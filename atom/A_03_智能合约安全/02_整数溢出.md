# æ•´æ•°æº¢å‡º (Integer Overflow/Underflow)

## 1. ã€30å­—æ ¸å¿ƒã€‘

**æ•´æ•°æº¢å‡ºæ˜¯æ•°å€¼è¶…å‡ºç±»å‹èŒƒå›´æ—¶å‘ç”Ÿçš„å›ç»•ç°è±¡ï¼ŒSolidity 0.8å‰éœ€è¦SafeMathé˜²æŠ¤ï¼Œ0.8+å†…ç½®æº¢å‡ºæ£€æŸ¥ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### æ•´æ•°æº¢å‡ºçš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**æ•´æ•°æº¢å‡º = æ•°å€¼è¶…å‡ºå­˜å‚¨ç±»å‹çš„è¡¨ç¤ºèŒƒå›´ï¼Œå¯¼è‡´æ•°å€¼å›ç»•**

- **ä¸Šæº¢ï¼ˆOverflowï¼‰**ï¼šæœ€å¤§å€¼ + 1 = 0ï¼ˆæˆ–æœ€å°å€¼ï¼‰
- **ä¸‹æº¢ï¼ˆUnderflowï¼‰**ï¼š0 - 1 = æœ€å¤§å€¼

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

#### 2. ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿæ•´æ•°æº¢å‡ºï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šè®¡ç®—æœºä½¿ç”¨å›ºå®šä½æ•°å­˜å‚¨æ•´æ•°ï¼Œè¶…å‡ºèŒƒå›´çš„æ•°å€¼æ— æ³•æ­£ç¡®è¡¨ç¤ºã€‚**

```
uint8 çš„èŒƒå›´ï¼š0 ~ 255ï¼ˆ2^8 - 1ï¼‰

255 + 1 = ?
äºŒè¿›åˆ¶ï¼š11111111 + 00000001 = 100000000ï¼ˆ9ä½ï¼‰
ä½† uint8 åªèƒ½å­˜8ä½ï¼Œæœ€é«˜ä½è¢«ä¸¢å¼ƒ
ç»“æœï¼š00000000 = 0 âŒ
```

#### 3. æ•´æ•°æº¢å‡ºçš„ä¸‰å±‚å±å®³

##### å±å®³1ï¼šèµ„é‡‘ç›—å–

**ç¤ºä¾‹**ï¼šERC20ä»£å¸çš„æ‰¹é‡è½¬è´¦
```solidity
// Solidity 0.7 åŠä»¥ä¸‹
function batchTransfer(address[] memory receivers, uint256 value) public {
    uint256 amount = receivers.length * value;  // æº¢å‡ºï¼
    require(balances[msg.sender] >= amount);     // æ£€æŸ¥é€šè¿‡
    // æ”»å‡»è€…å¯ä»¥è½¬å‡ºè¶…è¿‡è‡ªå·±ä½™é¢çš„ä»£å¸
}
```

##### å±å®³2ï¼šæƒé™ç»•è¿‡

**ç¤ºä¾‹**ï¼šæ—¶é—´é”ç»•è¿‡
```solidity
function unlock() public {
    require(block.timestamp >= lockTime);  // æ£€æŸ¥æ—¶é—´é”
    // ...
}

function increaseLockTime(uint256 _seconds) public {
    lockTime += _seconds;  // å¦‚æœæº¢å‡ºï¼ŒlockTimeå¯èƒ½å˜æˆå¾ˆå°çš„å€¼
}
```

##### å±å®³3ï¼šé€»è¾‘é”™è¯¯

**ç¤ºä¾‹**ï¼šä½™é¢è®¡ç®—é”™è¯¯
```solidity
function withdraw(uint256 amount) public {
    balances[msg.sender] -= amount;  // å¦‚æœamount > balanceï¼Œä¸‹æº¢ä¸ºè¶…å¤§å€¼
    // æ”»å‡»è€…ä½™é¢å˜æˆå¤©æ–‡æ•°å­—
}
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼é˜²å¾¡æ–¹æ¡ˆ

**æ¨ç†é“¾ï¼š**

```
1. å‰æï¼šæ•´æ•°å­˜å‚¨æœ‰å›ºå®šä½æ•°é™åˆ¶
   â†“
2. æ¨å¯¼ï¼šè¶…å‡ºèŒƒå›´çš„è¿ç®—ç»“æœä¸å¯é¢„æœŸ
   â†“
3. æ¨å¯¼ï¼šéœ€è¦åœ¨è¿ç®—å‰/åæ£€æŸ¥æ˜¯å¦æº¢å‡º
   â†“
4. é˜²å¾¡æ–¹æ¡ˆ1ï¼šä½¿ç”¨ SafeMath åº“æ‰‹åŠ¨æ£€æŸ¥
   â†“
5. é˜²å¾¡æ–¹æ¡ˆ2ï¼šå‡çº§åˆ° Solidity 0.8+ï¼ˆå†…ç½®æ£€æŸ¥ï¼‰
   â†“
6. ç‰¹æ®Šæƒ…å†µï¼šç¡®å®éœ€è¦æº¢å‡ºæ—¶ä½¿ç”¨ unchecked
   â†“
7. æœ€ç»ˆå®è·µï¼šé»˜è®¤ä½¿ç”¨ 0.8+ï¼Œå¿…è¦æ—¶æ‰ç”¨ unchecked
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**æ•´æ•°æº¢å‡ºæºäºå›ºå®šä½æ•°çš„å­˜å‚¨é™åˆ¶ï¼ŒSolidity 0.8+ é»˜è®¤æ£€æŸ¥æº¢å‡ºå¹¶ revertï¼Œè¿™æ˜¯è¯­è¨€å±‚é¢çš„å®‰å…¨å‡çº§ã€‚**

---

## 3. ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šæº¢å‡ºç±»å‹ ğŸ”¢

**ä¸€å¥è¯å®šä¹‰ï¼š** ä¸Šæº¢æ˜¯è¶…è¿‡æœ€å¤§å€¼åå½’é›¶ï¼Œä¸‹æº¢æ˜¯ä½äºé›¶åå˜æˆæœ€å¤§å€¼ã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.7.0;  // æ—§ç‰ˆæœ¬ï¼Œæ— æº¢å‡ºæ£€æŸ¥

contract OverflowDemo {
    // uint8 èŒƒå›´ï¼š0 ~ 255
    
    // ä¸Šæº¢ç¤ºä¾‹
    function overflow() public pure returns (uint8) {
        uint8 max = 255;
        return max + 1;  // è¿”å› 0 âŒ
    }
    
    // ä¸‹æº¢ç¤ºä¾‹
    function underflow() public pure returns (uint8) {
        uint8 zero = 0;
        return zero - 1;  // è¿”å› 255 âŒ
    }
    
    // ä¹˜æ³•æº¢å‡º
    function multiplyOverflow() public pure returns (uint8) {
        uint8 a = 100;
        uint8 b = 3;
        return a * b;  // 100 * 3 = 300ï¼Œä½† uint8 æœ€å¤§255ï¼Œè¿”å› 44 (300 % 256)
    }
}
```

**å„ç±»å‹çš„èŒƒå›´ï¼š**

| ç±»å‹ | æœ€å°å€¼ | æœ€å¤§å€¼ | ä½æ•° |
|------|--------|--------|------|
| uint8 | 0 | 255 | 8 |
| uint16 | 0 | 65,535 | 16 |
| uint32 | 0 | 4,294,967,295 | 32 |
| uint64 | 0 | çº¦ 1.8 Ã— 10^19 | 64 |
| uint128 | 0 | çº¦ 3.4 Ã— 10^38 | 128 |
| uint256 | 0 | çº¦ 1.15 Ã— 10^77 | 256 |
| int256 | çº¦ -5.7 Ã— 10^76 | çº¦ 5.7 Ã— 10^76 | 256 |

**åœ¨æ™ºèƒ½åˆçº¦å¼€å‘ä¸­çš„åº”ç”¨ï¼š**

```solidity
// ERC20 ä»£å¸é€šå¸¸ä½¿ç”¨ uint256 å­˜å‚¨ä½™é¢
// å³ä½¿æ˜¯æœ€å¤§ä¾›åº”é‡çš„ä»£å¸ï¼Œuint256 ä¹Ÿè¶³å¤Ÿå¤§
// ä½†è¿ç®—æ—¶ä»éœ€æ³¨æ„æº¢å‡º
uint256 public constant MAX_SUPPLY = 1000000 * 10**18;  // 100ä¸‡ä»£å¸
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šSafeMath åº“ ğŸ›¡ï¸

**ä¸€å¥è¯å®šä¹‰ï¼š** SafeMath æ˜¯ OpenZeppelin æä¾›çš„å®‰å…¨æ•°å­¦åº“ï¼Œåœ¨ Solidity 0.8 ä¹‹å‰ç”¨äºé˜²æ­¢æº¢å‡ºã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.7.0;

// ç®€åŒ–ç‰ˆ SafeMath
library SafeMath {
    function add(uint256 a, uint256 b) internal pure returns (uint256) {
        uint256 c = a + b;
        require(c >= a, "SafeMath: addition overflow");
        return c;
    }
    
    function sub(uint256 a, uint256 b) internal pure returns (uint256) {
        require(b <= a, "SafeMath: subtraction underflow");
        return a - b;
    }
    
    function mul(uint256 a, uint256 b) internal pure returns (uint256) {
        if (a == 0) return 0;
        uint256 c = a * b;
        require(c / a == b, "SafeMath: multiplication overflow");
        return c;
    }
    
    function div(uint256 a, uint256 b) internal pure returns (uint256) {
        require(b > 0, "SafeMath: division by zero");
        return a / b;
    }
}

contract SafeToken {
    using SafeMath for uint256;  // ä¸º uint256 å¯ç”¨ SafeMath
    
    mapping(address => uint256) public balances;
    
    function transfer(address to, uint256 amount) public {
        // ä½¿ç”¨ SafeMath çš„å®‰å…¨å‡æ³•
        balances[msg.sender] = balances[msg.sender].sub(amount);
        balances[to] = balances[to].add(amount);
    }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

SafeMath çš„æ£€æŸ¥åŸç†ï¼š
- **åŠ æ³•**ï¼š`c >= a` ç¡®ä¿æ²¡æœ‰å›ç»•åˆ°æ›´å°çš„å€¼
- **å‡æ³•**ï¼š`b <= a` ç¡®ä¿ä¸ä¼šäº§ç”Ÿè´Ÿæ•°
- **ä¹˜æ³•**ï¼š`c / a == b` ç¡®ä¿æ²¡æœ‰æº¢å‡º
- **é™¤æ³•**ï¼š`b > 0` é˜²æ­¢é™¤é›¶é”™è¯¯

**å†å²æ„ä¹‰ï¼š**

åœ¨ Solidity 0.8 ä¹‹å‰ï¼ŒSafeMath æ˜¯æ‰€æœ‰åˆçº¦çš„æ ‡é…ã€‚å‡ ä¹æ‰€æœ‰çŸ¥åé¡¹ç›®ï¼ˆUniswap V2ã€Compoundã€Aaveï¼‰éƒ½ä½¿ç”¨äº† SafeMathã€‚

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šSolidity 0.8+ å†…ç½®æ£€æŸ¥ âœ…

**ä¸€å¥è¯å®šä¹‰ï¼š** Solidity 0.8 å¼€å§‹ï¼Œç®—æœ¯è¿ç®—é»˜è®¤åŒ…å«æº¢å‡ºæ£€æŸ¥ï¼Œæº¢å‡ºæ—¶è‡ªåŠ¨ revertã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract ModernSafety {
    // 0.8+ é»˜è®¤å®‰å…¨ï¼Œæº¢å‡ºä¼š revert
    function safeAdd() public pure returns (uint8) {
        uint8 a = 255;
        return a + 1;  // è‡ªåŠ¨ revertï¼Œä¸ä¼šè¿”å› 0
    }
    
    // ä½¿ç”¨ unchecked ç¦ç”¨æ£€æŸ¥ï¼ˆèŠ‚çœ gasï¼‰
    function unsafeAdd() public pure returns (uint8) {
        uint8 a = 255;
        unchecked {
            return a + 1;  // è¿”å› 0ï¼Œåƒæ—§ç‰ˆæœ¬ä¸€æ ·
        }
    }
    
    // å®é™…åº”ç”¨ï¼šå¾ªç¯è®¡æ•°å™¨å¯ä»¥ç”¨ unchecked èŠ‚çœ gas
    function sumArray(uint256[] memory arr) public pure returns (uint256) {
        uint256 sum = 0;
        for (uint256 i = 0; i < arr.length; ) {
            sum += arr[i];
            unchecked { i++; }  // i++ ä¸å¯èƒ½æº¢å‡ºï¼ˆæ•°ç»„é•¿åº¦æœ‰é™ï¼‰
        }
        return sum;
    }
}
```

**unchecked çš„é€‚ç”¨åœºæ™¯ï¼š**

```solidity
// âœ… é€‚åˆä½¿ç”¨ unchecked
unchecked { i++; }  // å¾ªç¯è®¡æ•°å™¨
unchecked { blockNumber++; }  // åŒºå—å·é€’å¢

// âŒ ä¸åº”ä½¿ç”¨ unchecked
unchecked { balance -= amount; }  // ç”¨æˆ·ä½™é¢è®¡ç®—
unchecked { price * quantity; }   // é‡‘é¢è®¡ç®—
```

**Gas æˆæœ¬å¯¹æ¯”ï¼š**

| æ“ä½œ | æœ‰æ£€æŸ¥ï¼ˆé»˜è®¤ï¼‰ | æ— æ£€æŸ¥ï¼ˆuncheckedï¼‰ |
|------|---------------|-------------------|
| åŠ æ³• | ~50 gas | ~3 gas |
| ä¹˜æ³• | ~55 gas | ~5 gas |

---

## 4. ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½é˜²æ­¢80%çš„æ•´æ•°æº¢å‡ºé—®é¢˜ï¼š

### 4.1 ä½¿ç”¨ Solidity 0.8+

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;  // å…³é”®ï¼šç‰ˆæœ¬å· >= 0.8.0

contract SafeContract {
    // æ‰€æœ‰ç®—æœ¯è¿ç®—è‡ªåŠ¨å—ä¿æŠ¤
    function safeTransfer(address to, uint256 amount) public {
        balances[msg.sender] -= amount;  // è‡ªåŠ¨æ£€æŸ¥ä¸‹æº¢
        balances[to] += amount;           // è‡ªåŠ¨æ£€æŸ¥ä¸Šæº¢
    }
}
```

### 4.2 è°¨æ…ä½¿ç”¨ unchecked

```solidity
// åªåœ¨ç¡®å®šå®‰å…¨çš„åœºæ™¯ä½¿ç”¨
for (uint256 i = 0; i < arr.length; ) {
    // å¤„ç†é€»è¾‘
    unchecked { i++; }  // OKï¼ši ä¸å¯èƒ½è¶…è¿‡ arr.length
}

// âŒ ç¦æ­¢åœ¨ç”¨æˆ·è¾“å…¥ç›¸å…³çš„è®¡ç®—ä¸­ä½¿ç”¨
unchecked {
    uint256 total = userAmount * price;  // å±é™©ï¼
}
```

### 4.3 æ—§åˆçº¦å‡çº§æŒ‡å—

```solidity
// æ—§ä»£ç  (0.7)
pragma solidity ^0.7.0;
import "@openzeppelin/contracts/math/SafeMath.sol";

contract OldToken {
    using SafeMath for uint256;
    
    function transfer(uint256 amount) public {
        balances[msg.sender] = balances[msg.sender].sub(amount);
    }
}

// æ–°ä»£ç  (0.8+)
pragma solidity ^0.8.0;

contract NewToken {
    // ä¸å†éœ€è¦ SafeMath
    function transfer(uint256 amount) public {
        balances[msg.sender] -= amount;  // ç›´æ¥ä½¿ç”¨
    }
}
```

### 4.4 ç±»å‹è½¬æ¢æ³¨æ„äº‹é¡¹

```solidity
// âŒ å±é™©ï¼šå¤§ç±»å‹è½¬å°ç±»å‹å¯èƒ½æˆªæ–­
uint256 big = 1000;
uint8 small = uint8(big);  // small = 232 (1000 % 256)

// âœ… å®‰å…¨ï¼šå…ˆæ£€æŸ¥èŒƒå›´
require(big <= type(uint8).max, "Value too large");
uint8 small = uint8(big);
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- âœ… ç¼–å†™ä¸å—æº¢å‡ºå½±å“çš„åˆçº¦
- âœ… æ­£ç¡®å‡çº§æ—§ç‰ˆæœ¬åˆçº¦
- âœ… åœ¨ä»£ç å®¡è®¡ä¸­è¯†åˆ«æº¢å‡ºé£é™©
- âœ… åˆç†ä½¿ç”¨ unchecked ä¼˜åŒ– gas

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šæ•´æ•°æº¢å‡º ğŸ”„

#### ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼šæ•´æ•°æº¢å‡º = é‡Œç¨‹è¡¨å½’é›¶

æƒ³è±¡ä¸€è¾†è€æ±½è½¦çš„é‡Œç¨‹è¡¨ï¼š

**é‡Œç¨‹è¡¨ç‰¹ç‚¹ï¼š**
- æœ€å¤šæ˜¾ç¤º 999,999 å…¬é‡Œï¼ˆ6ä½æ•°å­—ï¼‰
- å½“è¾¾åˆ° 999,999 åå†å¼€ 1 å…¬é‡Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ
- é‡Œç¨‹è¡¨æ˜¾ç¤º 000,000ï¼ˆå½’é›¶ï¼‰ï¼

**å¯¹åº”æ•´æ•°æº¢å‡ºï¼š**
- **é‡Œç¨‹è¡¨** = uint256 å˜é‡
- **999,999** = æœ€å¤§å€¼ï¼ˆ2^256 - 1ï¼‰
- **å½’é›¶** = æº¢å‡ºå›ç»•åˆ° 0

**ä¸¾ä¾‹ï¼š**

```
é‡Œç¨‹è¡¨ï¼ˆ6ä½ï¼‰ï¼š
  999,997 â†’ 999,998 â†’ 999,999 â†’ 000,000 â†’ 000,001
                                  â†‘
                              æº¢å‡ºå½’é›¶

uint8ï¼ˆ8ä½ï¼‰ï¼š
  253 â†’ 254 â†’ 255 â†’ 0 â†’ 1
                     â†‘
                 æº¢å‡ºå½’é›¶
```

**ç°å®ä¸­çš„è§£å†³æ–¹æ¡ˆï¼š**
- ç°ä»£æ±½è½¦ä½¿ç”¨ç”µå­é‡Œç¨‹è¡¨ï¼Œæ•°å­—è¶³å¤Ÿå¤§
- é‡Œç¨‹è¡¨ä¼šæ˜¾ç¤ºè­¦å‘Šè€Œä¸æ˜¯å½’é›¶
- å°±åƒ Solidity 0.8+ ä¼š revert è€Œä¸æ˜¯é™é»˜æº¢å‡º

---

#### å‰ç«¯é¢†åŸŸç±»æ¯”ï¼šæ•´æ•°æº¢å‡º = JavaScript Number.MAX_SAFE_INTEGER

JavaScript ä¹Ÿæœ‰ç±»ä¼¼é—®é¢˜ï¼š

```javascript
// JavaScript çš„å®‰å…¨æ•´æ•°èŒƒå›´
console.log(Number.MAX_SAFE_INTEGER);  // 9007199254740991
console.log(Number.MAX_SAFE_INTEGER + 1);  // 9007199254740992
console.log(Number.MAX_SAFE_INTEGER + 2);  // 9007199254740992 âŒ é”™è¯¯ï¼

// åº”è¯¥ç”¨ BigInt
console.log(BigInt(Number.MAX_SAFE_INTEGER) + 2n);  // æ­£ç¡®
```

**å¯¹åº”Solidityï¼š**

```javascript
// JavaScript å¤„ç†å¤§æ•°
const amount = BigInt("1000000000000000000");  // 1 ETH in Wei

// ethers.js è‡ªåŠ¨å¤„ç†
import { ethers } from 'ethers';
const oneEth = ethers.parseEther("1.0");  // è¿”å› BigInt
```

```solidity
// Solidity 0.8+ è‡ªåŠ¨æ£€æŸ¥
uint256 balance = 1000000000000000000;  // 1 ETH
balance += 1;  // å®‰å…¨ï¼Œæœ‰æº¢å‡ºæ£€æŸ¥
```

**ç±»æ¯”è¡¨ï¼š**

| åœºæ™¯ | JavaScript | Solidity 0.7 | Solidity 0.8+ |
|------|-----------|--------------|---------------|
| å¤§æ•´æ•°è®¡ç®— | Number ä¸ç²¾ç¡® | é™é»˜æº¢å‡º | è‡ªåŠ¨ revert |
| è§£å†³æ–¹æ¡ˆ | BigInt | SafeMath | å†…ç½®æ£€æŸ¥ |
| è·³è¿‡æ£€æŸ¥ | ä¸å¯èƒ½ | ä¸ä½¿ç”¨SafeMath | unchecked {} |

---

### ç±»æ¯”2ï¼šä¸‹æº¢ â¬‡ï¸

#### ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼šä¸‹æº¢ = é“¶è¡Œè´¦æˆ·é€æ”¯

æƒ³è±¡ä¸€ä¸ªä¸å…è®¸é€æ”¯çš„é“¶è¡Œè´¦æˆ·ï¼š

**æ­£å¸¸ç³»ç»Ÿï¼š**
- ä½™é¢ 100 å…ƒ
- å–æ¬¾ 150 å…ƒ
- ç³»ç»Ÿæç¤º"ä½™é¢ä¸è¶³"ï¼Œæ‹’ç»äº¤æ˜“

**æœ‰bugçš„ç³»ç»Ÿï¼ˆåƒ Solidity 0.7ï¼‰ï¼š**
- ä½™é¢ 100 å…ƒ
- å–æ¬¾ 150 å…ƒ
- ç³»ç»Ÿè®¡ç®—ï¼š100 - 150 = -50
- ä½†ç³»ç»Ÿåªèƒ½å­˜æ­£æ•°ï¼Œ-50 å˜æˆäº†è¶…å¤§æ­£æ•°ï¼
- ä½™é¢æ˜¾ç¤ºï¼š18,446,744,073,709,551,566 å…ƒ ğŸ’°

**å¯¹åº”ä»£ç ï¼š**

```solidity
// Solidity 0.7ï¼ˆæœ‰bugï¼‰
uint256 balance = 100;
balance -= 150;  // balance = 2^256 - 50 = è¶…å¤§æ•°å­—

// Solidity 0.8+ï¼ˆä¿®å¤ï¼‰
uint256 balance = 100;
balance -= 150;  // revert: "Arithmetic underflow"
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| æº¢å‡ºæ¦‚å¿µ | ç”Ÿæ´»åœºæ™¯ç±»æ¯” | å‰ç«¯é¢†åŸŸç±»æ¯” | æ ¸å¿ƒç›¸ä¼¼æ€§ |
|---------|-------------|-------------|-----------|
| **ä¸Šæº¢** | é‡Œç¨‹è¡¨å½’é›¶ | Number.MAX_SAFE_INTEGER | è¶…è¿‡æœ€å¤§å€¼åå›ç»• |
| **ä¸‹æº¢** | è´¦æˆ·é€æ”¯å˜å·¨æ¬¾ | è´Ÿæ•°è½¬æ— ç¬¦å·æ•´æ•° | ä½äºé›¶åå˜æœ€å¤§å€¼ |
| **SafeMath** | é“¶è¡Œç³»ç»Ÿä½™é¢æ£€æŸ¥ | ä½¿ç”¨ BigInt | è¿ç®—å‰åéªŒè¯ |
| **0.8+æ£€æŸ¥** | ç°ä»£ç”µå­ç³»ç»ŸæŠ¥é”™ | TypeScript ç±»å‹æ£€æŸ¥ | è¯­è¨€å±‚é¢å¼ºåˆ¶å®‰å…¨ |
| **unchecked** | æ‰‹åŠ¨å…³é—­å®‰å…¨æ£€æŸ¥ | // @ts-ignore | æœ‰æ„è·³è¿‡æ£€æŸ¥ |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šSolidity 0.8+ å®Œå…¨ä¸ç”¨æ‹…å¿ƒæº¢å‡º âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

è™½ç„¶ 0.8+ æœ‰å†…ç½®æ£€æŸ¥ï¼Œä½†ä»¥ä¸‹æƒ…å†µä»éœ€æ³¨æ„ï¼š

1. **unchecked å—**ï¼šå¼€å‘è€…å¯èƒ½é”™è¯¯ä½¿ç”¨
2. **ç±»å‹è½¬æ¢**ï¼šå¤§ç±»å‹è½¬å°ç±»å‹ä¼šæˆªæ–­
3. **å¤–éƒ¨è°ƒç”¨**ï¼šè°ƒç”¨ 0.7 åˆçº¦ä¸å—ä¿æŠ¤
4. **æ±‡ç¼–ä»£ç **ï¼šå†…è”æ±‡ç¼–ç»•è¿‡æ£€æŸ¥

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

0.8 çš„æº¢å‡ºæ£€æŸ¥ç»™äººä¸€ç§"ç»å¯¹å®‰å…¨"çš„é”™è§‰ï¼Œä½†å®‰å…¨éœ€è¦å…¨é¢è€ƒè™‘ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```solidity
// âŒ ä»ç„¶å±é™©ï¼šç±»å‹è½¬æ¢æˆªæ–­
uint256 bigNumber = 1000;
uint8 smallNumber = uint8(bigNumber);  // 232ï¼Œä¸æ˜¯1000ï¼

// âŒ ä»ç„¶å±é™©ï¼šunchecked å—
unchecked {
    uint256 result = a - b;  // å¯èƒ½ä¸‹æº¢
}

// âœ… å®‰å…¨ï¼šæ˜¾å¼æ£€æŸ¥ç±»å‹è½¬æ¢
require(bigNumber <= type(uint8).max, "Overflow");
uint8 smallNumber = uint8(bigNumber);
```

---

### è¯¯åŒº2ï¼šuint256 è¶³å¤Ÿå¤§ï¼Œä¸å¯èƒ½æº¢å‡º âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

uint256 ç¡®å®å¾ˆå¤§ï¼ˆçº¦ 1.15 Ã— 10^77ï¼‰ï¼Œä½†ä¹˜æ³•è¿ç®—å¯èƒ½å¯¼è‡´æº¢å‡ºï¼š

**å®é™…æƒ…å†µï¼š**
```solidity
// çœ‹ä¼¼å®‰å…¨çš„è®¡ç®—
uint256 price = 10**18;  // 1 ETH
uint256 quantity = 10**60;  // è¶…å¤§æ•°é‡
uint256 total = price * quantity;  // 10^78 > 10^77ï¼Œæº¢å‡ºï¼
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

æ—¥å¸¸é‡‘èåœºæ™¯ä¸­ uint256 ç¡®å®è¶³å¤Ÿï¼Œä½† DeFi ä¸­çš„æŸäº›è®¡ç®—ï¼ˆå¦‚å¤åˆ©ã€æµåŠ¨æ€§è®¡ç®—ï¼‰å¯èƒ½æ¶‰åŠéå¸¸å¤§çš„ä¸­é—´å€¼ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```solidity
// âŒ å±é™©ï¼šç›´æ¥ä¹˜æ³•å¯èƒ½æº¢å‡º
uint256 result = a * b / c;

// âœ… å®‰å…¨ï¼šä½¿ç”¨ FullMath åº“æˆ–è°ƒæ•´è¿ç®—é¡ºåº
uint256 result = a / c * b;  // å…ˆé™¤åä¹˜ï¼Œé™ä½ä¸­é—´å€¼

// âœ… å®‰å…¨ï¼šä½¿ç”¨ä¸“é—¨çš„åº“
import "@uniswap/v3-core/contracts/libraries/FullMath.sol";
uint256 result = FullMath.mulDiv(a, b, c);  // a * b / cï¼Œä¸æº¢å‡º
```

---

### è¯¯åŒº3ï¼šSafeMath åœ¨ 0.8+ ä¸­ä»ç„¶æœ‰ç”¨ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

åœ¨ 0.8+ ä¸­ä½¿ç”¨ SafeMathï¼š
1. æµªè´¹ gasï¼ˆåŒé‡æ£€æŸ¥ï¼‰
2. ä»£ç å†—ä½™
3. å¯èƒ½é€ æˆå›°æƒ‘

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

ä»æ—§é¡¹ç›®è¿ç§»æ—¶ï¼Œä¹ æƒ¯æ€§ä¿ç•™ SafeMathã€‚

**æ­£ç¡®ç†è§£ï¼š**

```solidity
// âŒ 0.8+ ä¸­ä¸éœ€è¦ SafeMath
pragma solidity ^0.8.0;
import "@openzeppelin/contracts/utils/math/SafeMath.sol";  // ä¸éœ€è¦

contract Redundant {
    using SafeMath for uint256;  // ä¸éœ€è¦
    
    function transfer(uint256 amount) public {
        balances[msg.sender] = balances[msg.sender].sub(amount);  // å†—ä½™
    }
}

// âœ… 0.8+ ç›´æ¥ä½¿ç”¨è¿ç®—ç¬¦
pragma solidity ^0.8.0;

contract Modern {
    function transfer(uint256 amount) public {
        balances[msg.sender] -= amount;  // è‡ªåŠ¨æ£€æŸ¥
    }
}
```

**æ³¨æ„ï¼š** OpenZeppelin 4.x å·²ç§»é™¤ SafeMathï¼Œå› ä¸ºä¸å†éœ€è¦ã€‚

---

## 7. ã€å®æˆ˜ä»£ç ã€‘

### åœºæ™¯1ï¼šç»å…¸æº¢å‡ºæ¼æ´ï¼ˆBEC Token æ”»å‡»ï¼‰

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.7.0;  // æ—§ç‰ˆæœ¬ï¼Œæ¼”ç¤ºæ¼æ´

// ===== 1. æœ‰æ¼æ´çš„ä»£å¸åˆçº¦ =====
contract VulnerableToken {
    mapping(address => uint256) public balances;
    
    constructor() {
        balances[msg.sender] = 10000;  // åˆå§‹10000ä»£å¸
    }
    
    // âŒ æœ‰æº¢å‡ºæ¼æ´çš„æ‰¹é‡è½¬è´¦
    function batchTransfer(address[] memory receivers, uint256 value) public {
        // å±é™©ï¼šå¦‚æœ receivers.length * value æº¢å‡º
        // æ¯”å¦‚ï¼šreceivers.length = 2, value = 2^255
        // 2 * 2^255 = 2^256 æº¢å‡ºä¸º 0
        uint256 amount = receivers.length * value;  // æº¢å‡ºï¼
        
        require(balances[msg.sender] >= amount);  // 0 >= 0ï¼Œé€šè¿‡ï¼
        
        balances[msg.sender] -= amount;  // å‡å» 0
        
        for (uint256 i = 0; i < receivers.length; i++) {
            balances[receivers[i]] += value;  // æ¯äººè·å¾— 2^255 ä»£å¸ï¼
        }
    }
}
```

### åœºæ™¯2ï¼šæ”»å‡»æ¼”ç¤º

```solidity
// ===== 2. æ”»å‡»æ­¥éª¤ =====
contract Attacker {
    VulnerableToken public token;
    
    constructor(address _token) {
        token = VulnerableToken(_token);
    }
    
    function attack() external {
        // æ„é€ æ¶æ„å‚æ•°
        address[] memory receivers = new address[](2);
        receivers[0] = address(this);
        receivers[1] = msg.sender;
        
        // value = 2^255ï¼Œä½¿å¾— 2 * 2^255 = 2^256 æº¢å‡ºä¸º 0
        uint256 maliciousValue = 2**255;
        
        // è°ƒç”¨æ¼æ´å‡½æ•°
        token.batchTransfer(receivers, maliciousValue);
        
        // æ”»å‡»è€…å’ŒåŒä¼™å„è·å¾— 2^255 ä»£å¸
    }
}
```

### åœºæ™¯3ï¼šä¿®å¤æ–¹æ¡ˆ

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;  // å‡çº§åˆ° 0.8+

// ===== 3. ä¿®å¤æ–¹æ¡ˆ1ï¼šä½¿ç”¨ 0.8+ å†…ç½®æ£€æŸ¥ =====
contract SafeToken {
    mapping(address => uint256) public balances;
    
    constructor() {
        balances[msg.sender] = 10000;
    }
    
    // âœ… 0.8+ è‡ªåŠ¨æ£€æŸ¥æº¢å‡º
    function batchTransfer(address[] memory receivers, uint256 value) public {
        // æº¢å‡ºä¼šè‡ªåŠ¨ revert
        uint256 amount = receivers.length * value;
        
        require(balances[msg.sender] >= amount, "Insufficient balance");
        
        balances[msg.sender] -= amount;
        
        for (uint256 i = 0; i < receivers.length; i++) {
            balances[receivers[i]] += value;
        }
    }
}

// ===== 4. ä¿®å¤æ–¹æ¡ˆ2ï¼š0.7 ä½¿ç”¨ SafeMath =====
// pragma solidity ^0.7.0;
// import "@openzeppelin/contracts/math/SafeMath.sol";

contract SafeTokenLegacy {
    // using SafeMath for uint256;
    
    mapping(address => uint256) public balances;
    
    function batchTransfer(address[] memory receivers, uint256 value) public {
        // ä½¿ç”¨ SafeMath çš„å®‰å…¨ä¹˜æ³•
        // uint256 amount = receivers.length.mul(value);  // æº¢å‡ºä¼š revert
        // require(balances[msg.sender] >= amount);
        // balances[msg.sender] = balances[msg.sender].sub(amount);
        // ...
    }
}
```

### åœºæ™¯4ï¼šunchecked çš„æ­£ç¡®ä½¿ç”¨

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract UncheckedDemo {
    // âœ… æ­£ç¡®ä½¿ç”¨ï¼šå¾ªç¯è®¡æ•°å™¨
    function sumArray(uint256[] memory arr) public pure returns (uint256) {
        uint256 total = 0;
        uint256 len = arr.length;
        
        for (uint256 i = 0; i < len; ) {
            total += arr[i];  // è¿™é‡Œä¿æŒæ£€æŸ¥
            
            unchecked {
                i++;  // i ä¸å¯èƒ½è¶…è¿‡æ•°ç»„é•¿åº¦ï¼Œå®‰å…¨
            }
        }
        
        return total;
    }
    
    // âœ… æ­£ç¡®ä½¿ç”¨ï¼šå·²çŸ¥å®‰å…¨çš„å‡æ³•
    function safeSub(uint256 a, uint256 b) public pure returns (uint256) {
        require(a >= b, "Underflow");  // å…ˆæ£€æŸ¥
        
        unchecked {
            return a - b;  // å·²ç¡®è®¤å®‰å…¨ï¼Œå¯ä»¥ç”¨ unchecked çœ gas
        }
    }
    
    // âŒ é”™è¯¯ä½¿ç”¨ï¼šç”¨æˆ·è¾“å…¥
    function unsafeMul(uint256 a, uint256 b) public pure returns (uint256) {
        unchecked {
            return a * b;  // å±é™©ï¼ç”¨æˆ·å¯ä»¥è¾“å…¥å¯¼è‡´æº¢å‡ºçš„å€¼
        }
    }
}
```

### åœºæ™¯5ï¼šç±»å‹è½¬æ¢å®‰å…¨

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract TypeCastSafety {
    // âŒ å±é™©ï¼šç›´æ¥è½¬æ¢
    function unsafeCast(uint256 value) public pure returns (uint8) {
        return uint8(value);  // æˆªæ–­ï¼1000 å˜æˆ 232
    }
    
    // âœ… å®‰å…¨ï¼šå…ˆæ£€æŸ¥èŒƒå›´
    function safeCast(uint256 value) public pure returns (uint8) {
        require(value <= type(uint8).max, "Value exceeds uint8 range");
        return uint8(value);
    }
    
    // âœ… ä½¿ç”¨ OpenZeppelin çš„ SafeCast
    // import "@openzeppelin/contracts/utils/math/SafeCast.sol";
    // using SafeCast for uint256;
    // function safeCastOZ(uint256 value) public pure returns (uint8) {
    //     return value.toUint8();  // è¶…èŒƒå›´è‡ªåŠ¨ revert
    // }
}
```

**åœ¨ Remix ä¸­æµ‹è¯•ï¼š**

```
1. éƒ¨ç½² VulnerableTokenï¼ˆä½¿ç”¨ 0.7 ç¼–è¯‘å™¨ï¼‰
2. è°ƒç”¨ batchTransferï¼Œå‚æ•°ï¼š
   - receivers: [æ”»å‡»è€…åœ°å€1, æ”»å‡»è€…åœ°å€2]
   - value: 57896044618658097711785492504343953926634992332820282019728792003956564819968
     (å³ 2^255)
3. è§‚å¯Ÿï¼šä¸¤ä¸ªæ”»å‡»è€…å„è·å¾—è¶…å¤§é‡ä»£å¸

4. éƒ¨ç½² SafeTokenï¼ˆä½¿ç”¨ 0.8 ç¼–è¯‘å™¨ï¼‰
5. åŒæ ·çš„æ”»å‡»ä¼š revertï¼š"Arithmetic overflow"
```

---

## 8. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"ä»€ä¹ˆæ˜¯æ•´æ•°æº¢å‡ºï¼ŸSolidity å¦‚ä½•è§£å†³ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"æ•´æ•°æº¢å‡ºæ˜¯æ•°å­—è¶…è¿‡æœ€å¤§å€¼åå½’é›¶ã€‚Solidity 0.8 è‡ªåŠ¨æ£€æŸ¥æº¢å‡ºã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **æ•´æ•°æº¢å‡ºå¯ä»¥ä»ä¸‰ä¸ªå±‚é¢ç†è§£ï¼š**
>
> **1. åŸç†å±‚é¢**ï¼š
> è®¡ç®—æœºç”¨å›ºå®šä½æ•°å­˜å‚¨æ•´æ•°ï¼Œæ¯”å¦‚ uint8 ç”¨8ä½ï¼ŒèŒƒå›´æ˜¯ 0-255ã€‚å½“è¿ç®—ç»“æœè¶…å‡ºèŒƒå›´æ—¶ï¼š
> - ä¸Šæº¢ï¼š255 + 1 = 0ï¼ˆæœ€é«˜ä½ä¸¢å¤±ï¼‰
> - ä¸‹æº¢ï¼š0 - 1 = 255ï¼ˆå€Ÿä½å¤±è´¥å˜æœ€å¤§å€¼ï¼‰
>
> **2. å†å²æ¼”å˜**ï¼š
> - **0.8 ä¹‹å‰**ï¼šæ— æ£€æŸ¥ï¼Œéœ€è¦ SafeMath åº“æ‰‹åŠ¨éªŒè¯
> - **0.8 ä¹‹å**ï¼šå†…ç½®æ£€æŸ¥ï¼Œæº¢å‡ºè‡ªåŠ¨ revert
> - **ç°åœ¨**ï¼šå¯ç”¨ `unchecked {}` è·³è¿‡æ£€æŸ¥ä»¥ä¼˜åŒ– gas
>
> **3. è‘—åæ¡ˆä¾‹**ï¼š
> 2018å¹´ BEC Token æ”»å‡»ï¼Œåˆ©ç”¨ `batchTransfer` ä¸­çš„ä¹˜æ³•æº¢å‡ºï¼Œæ”»å‡»è€…ç”¨ `2 * 2^255 = 0` ç»•è¿‡ä½™é¢æ£€æŸ¥ï¼Œå‡­ç©ºåˆ›é€ å¤©é‡ä»£å¸ã€‚
>
> **å®é™…å¼€å‘å»ºè®®**ï¼š
> - å§‹ç»ˆä½¿ç”¨ 0.8+
> - åªåœ¨ç¡®å®šå®‰å…¨æ—¶ä½¿ç”¨ `unchecked`ï¼ˆå¦‚å¾ªç¯è®¡æ•°å™¨ i++ï¼‰
> - æ³¨æ„ç±»å‹è½¬æ¢å¯èƒ½æˆªæ–­
> - æ¶‰åŠå¤§æ•°ä¹˜é™¤ä½¿ç”¨ FullMath åº“
>
> ```solidity
> // 0.8+ ç¤ºä¾‹
> uint256 a = type(uint256).max;
> uint256 b = a + 1;  // revert: Arithmetic overflow
> 
> unchecked {
>     uint256 c = a + 1;  // c = 0ï¼Œè·³è¿‡æ£€æŸ¥
> }
> ```

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… è§£é‡Šäº†åº•å±‚åŸç†ï¼ˆä½è¿ç®—ï¼‰
2. âœ… å±•ç¤ºäº†å†å²æ¼”å˜ï¼ˆSafeMath â†’ 0.8ï¼‰
3. âœ… å¼•ç”¨çœŸå®æ¡ˆä¾‹ï¼ˆBECæ”»å‡»ï¼‰
4. âœ… æä¾›äº†å®ç”¨å»ºè®®å’Œä»£ç 

---

### é—®é¢˜2ï¼š"unchecked ä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿæœ‰ä»€ä¹ˆé£é™©ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"unchecked ç”¨æ¥çœ gasï¼Œä½†æœ‰æº¢å‡ºé£é™©ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **unchecked æ˜¯ Solidity 0.8 å¼•å…¥çš„å…³é”®å­—ï¼Œç”¨äºç¦ç”¨ç‰¹å®šä»£ç å—çš„æº¢å‡ºæ£€æŸ¥ï¼š**
>
> **é€‚ç”¨åœºæ™¯ï¼š**
> ```solidity
> // 1. å¾ªç¯è®¡æ•°å™¨ï¼ˆæœ€å¸¸è§ï¼‰
> for (uint i = 0; i < arr.length; ) {
>     // ... 
>     unchecked { i++; }  // èŠ‚çœçº¦ 50 gas/æ¬¡
> }
> 
> // 2. å·²ç»éªŒè¯è¿‡çš„è¿ç®—
> require(a >= b);
> unchecked { return a - b; }  // å·²ç¡®è®¤ä¸ä¼šä¸‹æº¢
> 
> // 3. å“ˆå¸Œ/IDç”Ÿæˆï¼ˆæ•…æ„åˆ©ç”¨æº¢å‡ºç‰¹æ€§ï¼‰
> unchecked { id = hash ^ nonce++; }
> ```
>
> **ä¸é€‚ç”¨åœºæ™¯ï¼š**
> ```solidity
> // âŒ ç”¨æˆ·è¾“å…¥
> unchecked { total = userAmount * price; }
> 
> // âŒ å¤–éƒ¨æ•°æ®
> unchecked { balance -= externalValue; }
> 
> // âŒ é‡‘èè®¡ç®—
> unchecked { interest = principal * rate / 100; }
> ```
>
> **Gas æˆæœ¬å¯¹æ¯”ï¼š**
> - æœ‰æ£€æŸ¥çš„åŠ æ³•ï¼šçº¦ 50 gas
> - æ— æ£€æŸ¥çš„åŠ æ³•ï¼šçº¦ 3 gas
> - åœ¨å¾ªç¯ä¸­ç´¯è®¡å·®å¼‚å¯è§‚
>
> **é£é™©æ§åˆ¶ï¼š**
> æˆ‘ä»¬å›¢é˜Ÿçš„è§„èŒƒæ˜¯ï¼š
> 1. æ¯ä¸ª `unchecked` å¿…é¡»æœ‰æ³¨é‡Šè¯´æ˜ä¸ºä»€ä¹ˆå®‰å…¨
> 2. PR æ—¶é‡ç‚¹ review `unchecked` å—
> 3. æ¶‰åŠé‡‘é¢çš„ä»£ç ç¦æ­¢ä½¿ç”¨ `unchecked`

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… åŒºåˆ†äº†é€‚ç”¨å’Œä¸é€‚ç”¨åœºæ™¯
2. âœ… ç»™å‡ºäº†å…·ä½“çš„ gas æ•°æ®
3. âœ… å±•ç¤ºäº†å›¢é˜Ÿè§„èŒƒå’Œå®è·µ
4. âœ… ä»£ç ç¤ºä¾‹æ¸…æ™°

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šä»€ä¹ˆæ˜¯æ•´æ•°æº¢å‡ºï¼Ÿ ğŸ”„

**ä¸€å¥è¯ï¼š** æ•°å€¼è¶…è¿‡ç±»å‹èƒ½å­˜å‚¨çš„æœ€å¤§å€¼åï¼Œä¼šå›ç»•åˆ°æœ€å°å€¼ï¼ˆæˆ–åä¹‹ï¼‰ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
uint8 max = 255;
max + 1 = 0  // ä¸Šæº¢

uint8 zero = 0;
zero - 1 = 255  // ä¸‹æº¢
```

**åº”ç”¨ï¼š** æ”»å‡»è€…åˆ©ç”¨æº¢å‡ºå¯ä»¥ç»•è¿‡ä½™é¢æ£€æŸ¥ï¼Œå‡­ç©ºåˆ›é€ ä»£å¸æˆ–ç›—å–èµ„é‡‘ã€‚

---

### å¡ç‰‡2ï¼šuint256 çš„èŒƒå›´ ğŸ“Š

**ä¸€å¥è¯ï¼š** uint256 å¯ä»¥å­˜å‚¨ 0 åˆ°çº¦ 1.15 Ã— 10^77 çš„æ•°å­—ï¼Œä½†ä¹˜æ³•ä»å¯èƒ½æº¢å‡ºã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
type(uint256).max = 
115792089237316195423570985008687907853269984665640564039457584007913129639935

// çœ‹ä¼¼å®‰å…¨ï¼Œå®åˆ™å¯èƒ½æº¢å‡º
uint256 result = price * quantity * rate;
```

**åº”ç”¨ï¼š** å³ä½¿ç”¨ uint256ï¼Œæ¶‰åŠå¤šä¸ªä¹˜æ³•æ—¶ä¹Ÿè¦å°å¿ƒï¼Œè€ƒè™‘ä½¿ç”¨ FullMath åº“ã€‚

---

### å¡ç‰‡3ï¼šSafeMath å†å² ğŸ“œ

**ä¸€å¥è¯ï¼š** SafeMath æ˜¯ 0.8 ä¹‹å‰çš„æ ‡å‡†é˜²æŠ¤åº“ï¼Œé€šè¿‡æ‰‹åŠ¨æ£€æŸ¥æ¯æ¬¡è¿ç®—é˜²æ­¢æº¢å‡ºã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// 0.7 æ—¶ä»£å¿…é¡»è¿™æ ·å†™
using SafeMath for uint256;
balances[msg.sender] = balances[msg.sender].sub(amount);
```

**åº”ç”¨ï¼š** å¦‚æœç»´æŠ¤æ—§åˆçº¦ï¼ˆ0.7åŠä»¥ä¸‹ï¼‰ï¼Œç¡®ä¿æ‰€æœ‰æ•°å­¦è¿ç®—ä½¿ç”¨ SafeMathã€‚

---

### å¡ç‰‡4ï¼šSolidity 0.8 çš„æ”¹å˜ âœ¨

**ä¸€å¥è¯ï¼š** 0.8+ å†…ç½®æº¢å‡ºæ£€æŸ¥ï¼Œæº¢å‡ºè‡ªåŠ¨ revertï¼Œä¸å†éœ€è¦ SafeMathã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
pragma solidity ^0.8.0;

uint256 a = type(uint256).max;
uint256 b = a + 1;  // è‡ªåŠ¨ revert!
```

**åº”ç”¨ï¼š** æ–°é¡¹ç›®å¿…é¡»ä½¿ç”¨ 0.8+ï¼Œæ—§é¡¹ç›®åº”è¯¥å‡çº§ã€‚

---

### å¡ç‰‡5ï¼šunchecked å…³é”®å­— âš¡

**ä¸€å¥è¯ï¼š** unchecked å—å†…çš„ä»£ç è·³è¿‡æº¢å‡ºæ£€æŸ¥ï¼Œå¯ä»¥èŠ‚çœ gasã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// èŠ‚çœ gas çš„å¾ªç¯
for (uint i = 0; i < 100; ) {
    // å¤„ç†é€»è¾‘
    unchecked { i++; }  // çœçº¦ 50 gas
}
```

**åº”ç”¨ï¼š** åªåœ¨ 100% ç¡®å®šå®‰å…¨çš„åœºæ™¯ä½¿ç”¨ï¼Œå¦‚å¾ªç¯è®¡æ•°å™¨ã€‚

---

### å¡ç‰‡6ï¼šBEC æ”»å‡»æ¡ˆä¾‹ ğŸ’¥

**ä¸€å¥è¯ï¼š** 2018å¹´ BEC Token å› ä¹˜æ³•æº¢å‡ºè¢«æ”»å‡»ï¼Œæ”»å‡»è€…å‡­ç©ºè·å¾—å¤©é‡ä»£å¸ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// æ¼æ´ä»£ç 
uint256 amount = receivers.length * value;
// æ”»å‡»ï¼š2 * 2^255 = 0ï¼ˆæº¢å‡ºï¼‰
// ä½™é¢æ£€æŸ¥ï¼šbalance >= 0 é€šè¿‡ï¼
```

**åº”ç”¨ï¼š** è¿™ä¸ªæ¡ˆä¾‹å¯¼è‡´äº¤æ˜“æ‰€ä¸‹æ¶ BECï¼Œå……åˆ†è¯´æ˜äº†æº¢å‡ºçš„å±å®³ã€‚

---

### å¡ç‰‡7ï¼šç±»å‹è½¬æ¢é™·é˜± ğŸª¤

**ä¸€å¥è¯ï¼š** å¤§ç±»å‹è½¬å°ç±»å‹ä¼šé™é»˜æˆªæ–­ï¼Œå³ä½¿åœ¨ 0.8+ ä¸­ä¹Ÿä¸ä¼šæŠ¥é”™ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
uint256 big = 1000;
uint8 small = uint8(big);  // small = 232ï¼Œä¸æ˜¯ 1000ï¼
// 1000 = 0x3E8 â†’ å–ä½8ä½ = 0xE8 = 232
```

**åº”ç”¨ï¼š** ç±»å‹è½¬æ¢å‰å¿…é¡»æ‰‹åŠ¨æ£€æŸ¥èŒƒå›´ï¼Œæˆ–ä½¿ç”¨ SafeCast åº“ã€‚

---

### å¡ç‰‡8ï¼šFullMath åº“ ğŸ§®

**ä¸€å¥è¯ï¼š** å¤„ç†å¤§æ•°ä¹˜é™¤æ—¶ï¼Œä½¿ç”¨ FullMath é¿å…ä¸­é—´ç»“æœæº¢å‡ºã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// Uniswap V3 ä½¿ç”¨çš„ FullMath
import "@uniswap/v3-core/contracts/libraries/FullMath.sol";

// a * b / cï¼Œä¸ä¼šå› ä¸º a * b æº¢å‡ºè€Œå‡ºé”™
uint256 result = FullMath.mulDiv(a, b, c);
```

**åº”ç”¨ï¼š** DeFi é¡¹ç›®ä¸­æ¶‰åŠä»·æ ¼ã€æµåŠ¨æ€§è®¡ç®—æ—¶å¸¸ç”¨ã€‚

---

### å¡ç‰‡9ï¼šå®¡è®¡æ£€æŸ¥æ¸…å• âœ…

**ä¸€å¥è¯ï¼š** ä»£ç å®¡è®¡æ—¶ï¼Œé‡ç‚¹æ£€æŸ¥æ‰€æœ‰ç®—æœ¯è¿ç®—å’Œç±»å‹è½¬æ¢ã€‚

**ä¸¾ä¾‹ï¼š**
```
â–¡ åˆçº¦ç‰ˆæœ¬æ˜¯å¦ >= 0.8.0ï¼Ÿ
â–¡ unchecked å—æ˜¯å¦æœ‰æ³¨é‡Šè¯´æ˜å®‰å…¨æ€§ï¼Ÿ
â–¡ ç±»å‹è½¬æ¢å‰æ˜¯å¦æ£€æŸ¥èŒƒå›´ï¼Ÿ
â–¡ ä¹˜æ³•è¿ç®—ä¸­é—´å€¼æ˜¯å¦å¯èƒ½æº¢å‡ºï¼Ÿ
â–¡ æ˜¯å¦æœ‰å¤–éƒ¨è¾“å…¥å‚ä¸è¿ç®—ï¼Ÿ
```

**åº”ç”¨ï¼š** å½¢æˆå®¡è®¡ä¹ æƒ¯ï¼Œä½¿ç”¨ Slither ç­‰å·¥å…·è¾…åŠ©æ£€æµ‹ã€‚

---

### å¡ç‰‡10ï¼šæœ€ä½³å®è·µæ€»ç»“ ğŸ“‹

**ä¸€å¥è¯ï¼š** ä½¿ç”¨ 0.8+ï¼Œè°¨æ…ç”¨ uncheckedï¼Œæ³¨æ„ç±»å‹è½¬æ¢ï¼Œå…³é”®è®¡ç®—ç”¨ä¸“ä¸šåº“ã€‚

**æ ¸å¿ƒå®è·µï¼š**
```solidity
// 1. ä½¿ç”¨ 0.8+
pragma solidity ^0.8.0;

// 2. unchecked åªç”¨äºå®‰å…¨åœºæ™¯
unchecked { i++; }  // OK

// 3. ç±»å‹è½¬æ¢å…ˆæ£€æŸ¥
require(x <= type(uint8).max);
uint8 y = uint8(x);

// 4. å¤§æ•°è®¡ç®—ç”¨åº“
FullMath.mulDiv(a, b, c);
```

**å»¶ä¼¸å­¦ä¹ ï¼š**
- [SWC-101: Integer Overflow/Underflow](https://swcregistry.io/docs/SWC-101)
- [OpenZeppelin SafeCast](https://docs.openzeppelin.com/contracts/4.x/api/utils#SafeCast)

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**æ•´æ•°æº¢å‡ºæ˜¯æ•°å€¼è¶…å‡ºç±»å‹èŒƒå›´åå‘ç”Ÿçš„å›ç»•ç°è±¡ï¼ŒSolidity 0.8ä¹‹å‰éœ€è¦SafeMathåº“é˜²æŠ¤ï¼Œ0.8+å†…ç½®æº¢å‡ºæ£€æŸ¥è‡ªåŠ¨revertï¼Œå¼€å‘è€…åº”å§‹ç»ˆä½¿ç”¨0.8+ç‰ˆæœ¬ï¼Œä»…åœ¨ç¡®ä¿å®‰å…¨æ—¶ä½¿ç”¨uncheckedä¼˜åŒ–gasã€‚**

---

## ğŸ“š é™„å½•

### å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬çŸ¥è¯†ç‚¹å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šä¸Šæº¢å’Œä¸‹æº¢çš„åŸç†
- [ ] è¯´å‡º uint8/uint256 çš„å–å€¼èŒƒå›´
- [ ] åœ¨ 0.7 é¡¹ç›®ä¸­æ­£ç¡®ä½¿ç”¨ SafeMath
- [ ] ç†è§£ 0.8+ å†…ç½®æ£€æŸ¥çš„å·¥ä½œæ–¹å¼
- [ ] æ­£ç¡®ä½¿ç”¨ unchecked ä¼˜åŒ– gas
- [ ] å®‰å…¨åœ°è¿›è¡Œç±»å‹è½¬æ¢
- [ ] äº†è§£ BEC Token æ”»å‡»æ¡ˆä¾‹
- [ ] ä½¿ç”¨ FullMath å¤„ç†å¤§æ•°è¿ç®—

### å¿«é€Ÿå‚è€ƒå¡

**ç‰ˆæœ¬é€‰æ‹©ï¼š**
```solidity
pragma solidity ^0.8.0;  // å¿…é¡» >= 0.8.0
```

**å®‰å…¨è¿ç®—ï¼š**
```solidity
// 0.8+ ç›´æ¥ä½¿ç”¨
a + b;  // è‡ªåŠ¨æ£€æŸ¥
a - b;  // è‡ªåŠ¨æ£€æŸ¥
a * b;  // è‡ªåŠ¨æ£€æŸ¥
```

**èŠ‚çœ Gasï¼š**
```solidity
unchecked { i++; }  // ä»…ç”¨äºå®‰å…¨åœºæ™¯
```

**ç±»å‹è½¬æ¢ï¼š**
```solidity
require(x <= type(uint8).max);
uint8 y = uint8(x);
```

### å‚è€ƒèµ„æº

- [SWC-101: Integer Overflow/Underflow](https://swcregistry.io/docs/SWC-101)
- [Solidity 0.8 Breaking Changes](https://docs.soliditylang.org/en/v0.8.0/080-breaking-changes.html)
- [OpenZeppelin Math Libraries](https://docs.openzeppelin.com/contracts/4.x/api/utils#math)
- [BEC Token Attack Analysis](https://medium.com/coinmonks/bec-token-attack-6a1c84f5df6d)

---

**ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2025-12-08
**é€‚ç”¨äººç¾¤ï¼š** å‰ç«¯å·¥ç¨‹å¸ˆè½¬Web3å¼€å‘

---

**è®°ä½ï¼š** å‡çº§åˆ° Solidity 0.8+ï¼Œè®©ç¼–è¯‘å™¨å¸®ä½ é˜²æ­¢æº¢å‡ºï¼ä½†ä¹Ÿåˆ«å¿˜äº†ç±»å‹è½¬æ¢çš„é™·é˜±ã€‚ğŸ›¡ï¸
