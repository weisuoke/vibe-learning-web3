# æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼ (Checks-Effects-Interactions Pattern)

## 1. ã€30å­—æ ¸å¿ƒã€‘

**CEIæ¨¡å¼æ˜¯æ™ºèƒ½åˆçº¦çš„é˜²å¾¡æ€§ç¼–ç¨‹è§„èŒƒï¼šå…ˆæ£€æŸ¥æ¡ä»¶(Checks)ã€å†æ›´æ–°çŠ¶æ€(Effects)ã€æœ€åå¤–éƒ¨è°ƒç”¨(Interactions)ï¼Œé˜²æ­¢é‡å…¥æ”»å‡»ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### CEIæ¨¡å¼çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**CEIæ¨¡å¼ = å‡½æ•°å†…ä»£ç çš„æ‰§è¡Œé¡ºåºè§„èŒƒ**

- **C (Checks)**ï¼šéªŒè¯æ¡ä»¶å’Œæƒé™
- **E (Effects)**ï¼šä¿®æ”¹åˆçº¦çŠ¶æ€
- **I (Interactions)**ï¼šä¸å¤–éƒ¨åˆçº¦/åœ°å€äº¤äº’

è¿™ä¸ªé¡ºåº**ä¸èƒ½é¢ å€’**ï¼

#### 2. ä¸ºä»€ä¹ˆéœ€è¦ CEI æ¨¡å¼ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¤–éƒ¨è°ƒç”¨æ—¶ï¼Œæ§åˆ¶æƒæš‚æ—¶è½¬ç§»ç»™è¢«è°ƒç”¨æ–¹ï¼Œè¢«è°ƒç”¨æ–¹å¯ä»¥å›è°ƒåŸåˆçº¦ã€‚**

å¦‚æœçŠ¶æ€æ›´æ–°åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹åï¼š
1. å¤–éƒ¨è°ƒç”¨è§¦å‘æ¥æ”¶æ–¹ä»£ç 
2. æ¥æ”¶æ–¹å›è°ƒåŸå‡½æ•°
3. åŸå‡½æ•°çœ‹åˆ°çš„æ˜¯**æ—§çŠ¶æ€**
4. å¯èƒ½å¯¼è‡´é‡å…¥æ”»å‡»

#### 3. CEIæ¨¡å¼çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šé˜²æ­¢é‡å…¥æ”»å‡»

```solidity
// âŒ EICï¼ˆé”™è¯¯é¡ºåºï¼‰ï¼šå…ˆäº¤äº’åæ•ˆæœ
function withdrawBad() external {
    uint256 amount = balances[msg.sender];
    (bool success, ) = msg.sender.call{value: amount}("");  // I
    balances[msg.sender] = 0;  // E
}

// âœ… CEIï¼ˆæ­£ç¡®é¡ºåºï¼‰ï¼šå…ˆæ•ˆæœåäº¤äº’
function withdrawGood() external {
    uint256 amount = balances[msg.sender];  // C (éšå«æ£€æŸ¥)
    balances[msg.sender] = 0;  // E
    (bool success, ) = msg.sender.call{value: amount}("");  // I
}
```

##### ä»·å€¼2ï¼šä¿è¯çŠ¶æ€ä¸€è‡´æ€§

CEI ç¡®ä¿åœ¨å¤–éƒ¨è°ƒç”¨æ—¶ï¼Œåˆçº¦çŠ¶æ€å·²ç»æ˜¯æœ€ç»ˆçŠ¶æ€ï¼Œä¸å­˜åœ¨"ä¸­é—´æ€"ã€‚

##### ä»·å€¼3ï¼šä»£ç å¯è¯»æ€§å’Œå¯å®¡è®¡æ€§

éµå¾ª CEI çš„ä»£ç æœ‰æ˜ç¡®çš„ç»“æ„ï¼Œæ›´å®¹æ˜“å‘ç°é—®é¢˜ã€‚

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ CEI æ¨¡å¼

**æ¨ç†é“¾ï¼š**

```
1. å‰æï¼šå¤–éƒ¨è°ƒç”¨ä¼šè½¬ç§»æ§åˆ¶æƒ
   â†“
2. æ¨å¯¼ï¼šè¢«è°ƒç”¨æ–¹å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç 
   â†“
3. æ¨å¯¼ï¼šè¢«è°ƒç”¨æ–¹å¯èƒ½å›è°ƒåŸåˆçº¦
   â†“
4. æ¨å¯¼ï¼šå¦‚æœçŠ¶æ€æœªæ›´æ–°ï¼Œå›è°ƒçœ‹åˆ°æ—§çŠ¶æ€
   â†“
5. æ¨å¯¼ï¼šæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ—§çŠ¶æ€é‡å¤æ“ä½œ
   â†“
6. ç»“è®ºï¼šçŠ¶æ€æ›´æ–°å¿…é¡»åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å‰
   â†“
7. è§„èŒƒï¼šChecks â†’ Effects â†’ Interactions
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**CEIæ¨¡å¼çš„æœ¬è´¨æ˜¯"åœ¨äº¤å‡ºæ§åˆ¶æƒä¹‹å‰ï¼Œç¡®ä¿åˆçº¦çŠ¶æ€å·²æ›´æ–°åˆ°æœ€ç»ˆçŠ¶æ€"ï¼Œä»æ ¹æœ¬ä¸Šæ¶ˆé™¤é‡å…¥æ”»å‡»çš„å¯èƒ½ã€‚**

---

## 3. ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šChecksï¼ˆæ£€æŸ¥ï¼‰âœ“

**ä¸€å¥è¯å®šä¹‰ï¼š** åœ¨å‡½æ•°å¼€å§‹æ—¶éªŒè¯æ‰€æœ‰å‰ç½®æ¡ä»¶ï¼ŒåŒ…æ‹¬æƒé™ã€ä½™é¢ã€å‚æ•°æœ‰æ•ˆæ€§ç­‰ã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract ChecksDemo {
    mapping(address => uint256) public balances;
    mapping(address => bool) public isAdmin;
    address public owner;
    bool public paused;
    
    // Checks é˜¶æ®µçš„å„ç§éªŒè¯
    function withdraw(uint256 amount) external {
        // ===== CHECKS =====
        
        // 1. æƒé™æ£€æŸ¥
        require(msg.sender == owner || isAdmin[msg.sender], "Not authorized");
        
        // 2. çŠ¶æ€æ£€æŸ¥
        require(!paused, "Contract is paused");
        
        // 3. ä½™é¢æ£€æŸ¥
        require(balances[msg.sender] >= amount, "Insufficient balance");
        
        // 4. å‚æ•°æ£€æŸ¥
        require(amount > 0, "Amount must be positive");
        require(amount <= 100 ether, "Exceeds max withdrawal");
        
        // 5. æ—¶é—´æ£€æŸ¥ï¼ˆå¦‚æœæœ‰ï¼‰
        // require(block.timestamp >= unlockTime, "Still locked");
        
        // ===== EFFECTS =====
        // ...
        
        // ===== INTERACTIONS =====
        // ...
    }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

Checks é˜¶æ®µåº”è¯¥éªŒè¯ï¼š
- **æƒé™**ï¼šè°ƒç”¨è€…æ˜¯å¦æœ‰æƒæ‰§è¡Œæ­¤æ“ä½œ
- **çŠ¶æ€**ï¼šåˆçº¦æ˜¯å¦å¤„äºå…è®¸æ“ä½œçš„çŠ¶æ€
- **ä½™é¢**ï¼šæ˜¯å¦æœ‰è¶³å¤Ÿçš„ä½™é¢/ä»£å¸
- **å‚æ•°**ï¼šè¾“å…¥å‚æ•°æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
- **æ—¶é—´**ï¼šæ˜¯å¦æ»¡è¶³æ—¶é—´é”æ¡ä»¶

**å¤±è´¥å¿«é€ŸåŸåˆ™**ï¼šå°½æ—©å¤±è´¥ï¼ŒèŠ‚çœ Gasã€‚

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šEffectsï¼ˆæ•ˆæœï¼‰âœï¸

**ä¸€å¥è¯å®šä¹‰ï¼š** åœ¨æ‰€æœ‰æ£€æŸ¥é€šè¿‡åï¼Œä¿®æ”¹åˆçº¦çš„çŠ¶æ€å˜é‡ï¼Œä¸”å¿…é¡»åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å‰ã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract EffectsDemo {
    mapping(address => uint256) public balances;
    mapping(address => uint256) public nonces;
    uint256 public totalSupply;
    
    event Transfer(address indexed from, address indexed to, uint256 amount);
    event Withdrawal(address indexed user, uint256 amount);
    
    function withdraw(uint256 amount) external {
        // ===== CHECKS =====
        require(balances[msg.sender] >= amount, "Insufficient balance");
        
        // ===== EFFECTS =====
        
        // 1. æ›´æ–°ä½™é¢
        balances[msg.sender] -= amount;
        
        // 2. æ›´æ–°æ€»ä¾›åº”é‡ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
        totalSupply -= amount;
        
        // 3. æ›´æ–° nonceï¼ˆé˜²é‡æ”¾ï¼‰
        nonces[msg.sender]++;
        
        // 4. å‘å‡ºäº‹ä»¶ï¼ˆäº‹ä»¶ä¹Ÿæ˜¯"æ•ˆæœ"çš„ä¸€éƒ¨åˆ†ï¼‰
        emit Withdrawal(msg.sender, amount);
        
        // ===== INTERACTIONS =====
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");
    }
    
    function transfer(address to, uint256 amount) external {
        // ===== CHECKS =====
        require(balances[msg.sender] >= amount, "Insufficient balance");
        require(to != address(0), "Invalid recipient");
        
        // ===== EFFECTS =====
        balances[msg.sender] -= amount;
        balances[to] += amount;
        
        emit Transfer(msg.sender, to, amount);
        
        // ===== INTERACTIONS =====
        // å¦‚æœéœ€è¦é€šçŸ¥æ¥æ”¶æ–¹ï¼ˆERC-777 ç­‰ï¼‰
        // è°ƒç”¨æ¥æ”¶æ–¹çš„ hook å‡½æ•°
    }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

Effects é˜¶æ®µåº”è¯¥ï¼š
- ä¿®æ”¹æ‰€æœ‰ç›¸å…³çš„çŠ¶æ€å˜é‡
- å‘å‡ºäº‹ä»¶ï¼ˆEventsï¼‰
- æ›´æ–°è®¡æ•°å™¨ï¼ˆnonceã€counter ç­‰ï¼‰

**å…³é”®åŸåˆ™**ï¼šåœ¨æ‰§è¡Œä»»ä½•å¤–éƒ¨è°ƒç”¨ä¹‹å‰ï¼Œåˆçº¦çŠ¶æ€åº”è¯¥åæ˜ æ“ä½œçš„æœ€ç»ˆç»“æœã€‚

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šInteractionsï¼ˆäº¤äº’ï¼‰ğŸ”—

**ä¸€å¥è¯å®šä¹‰ï¼š** æ‰€æœ‰ä¸å¤–éƒ¨åœ°å€æˆ–åˆçº¦çš„äº¤äº’ï¼Œå¿…é¡»æ”¾åœ¨å‡½æ•°çš„æœ€åã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract InteractionsDemo {
    mapping(address => uint256) public balances;
    
    // å¤–éƒ¨äº¤äº’çš„å„ç§å½¢å¼
    function demonstrateInteractions() external {
        uint256 amount = balances[msg.sender];
        
        // ===== CHECKS =====
        require(amount > 0, "No balance");
        
        // ===== EFFECTS =====
        balances[msg.sender] = 0;
        
        // ===== INTERACTIONS =====
        
        // 1. ETH è½¬è´¦ï¼ˆæœ€å¸¸è§ï¼‰
        (bool success1, ) = msg.sender.call{value: amount}("");
        require(success1, "ETH transfer failed");
        
        // 2. è°ƒç”¨å¤–éƒ¨åˆçº¦å‡½æ•°
        // IERC20(token).transfer(msg.sender, amount);
        
        // 3. è°ƒç”¨å¸¦å›è°ƒçš„å‡½æ•°
        // receiver.onTokenReceived(msg.sender, amount, data);
        
        // 4. ä½çº§è°ƒç”¨
        // (bool success2, bytes memory data) = target.call(calldata);
    }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

Interactions é˜¶æ®µçš„ç±»å‹ï¼š
- **ETH è½¬è´¦**ï¼š`call{value: amount}("")`
- **ERC20 è½¬è´¦**ï¼š`token.transfer(to, amount)`
- **å¤–éƒ¨åˆçº¦è°ƒç”¨**ï¼š`contract.function(args)`
- **ä½çº§è°ƒç”¨**ï¼š`address.call(data)`

**é£é™©æ¥æº**ï¼šæ‰€æœ‰å¤–éƒ¨è°ƒç”¨éƒ½å¯èƒ½è§¦å‘å¯¹æ–¹çš„ä»£ç æ‰§è¡Œã€‚

---

## 4. ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½æ­£ç¡®ä½¿ç”¨ CEI æ¨¡å¼ï¼š

### 4.1 æ ‡å‡† CEI æ¨¡æ¿

```solidity
function myFunction(uint256 param) external {
    // ===== CHECKS =====
    require(param > 0, "Invalid param");
    require(balances[msg.sender] >= param, "Insufficient balance");
    require(!paused, "Paused");
    
    // ===== EFFECTS =====
    balances[msg.sender] -= param;
    totalWithdrawn += param;
    emit Withdrawn(msg.sender, param);
    
    // ===== INTERACTIONS =====
    (bool success, ) = msg.sender.call{value: param}("");
    require(success, "Transfer failed");
}
```

### 4.2 å¸¸è§é”™è¯¯æ¨¡å¼

```solidity
// âŒ é”™è¯¯1ï¼šäº¤äº’åœ¨æ•ˆæœä¹‹å‰
function bad1() external {
    (bool s, ) = msg.sender.call{value: balance}("");  // I
    balance = 0;  // Eï¼ˆå¤ªæ™šäº†ï¼ï¼‰
}

// âŒ é”™è¯¯2ï¼šæ£€æŸ¥åœ¨æ•ˆæœä¹‹å
function bad2() external {
    balance -= amount;  // E
    require(balance >= 0);  // Cï¼ˆå¤ªæ™šäº†ï¼Solidity 0.8+ ä¼šè‡ªåŠ¨ revertï¼‰
}

// âŒ é”™è¯¯3ï¼šäº¤äº’ä¸­é—´æœ‰æ•ˆæœ
function bad3() external {
    token1.transfer(to, amount1);  // I
    balances[msg.sender] -= amount2;  // Eï¼ˆäº¤äº’ä¹‹é—´ä¸åº”æœ‰æ•ˆæœï¼‰
    token2.transfer(to, amount2);  // I
}
```

### 4.3 ä¸ ReentrancyGuard é…åˆä½¿ç”¨

```solidity
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract BestPractice is ReentrancyGuard {
    mapping(address => uint256) public balances;
    
    // CEI + ReentrancyGuard = åŒé‡ä¿æŠ¤
    function withdraw(uint256 amount) external nonReentrant {
        // CHECKS
        require(balances[msg.sender] >= amount);
        
        // EFFECTS
        balances[msg.sender] -= amount;
        
        // INTERACTIONS
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success);
    }
}
```

### 4.4 å®¡è®¡æ¸…å•

```
â–¡ æ‰€æœ‰ require/assert åœ¨å‡½æ•°å¼€å¤´ï¼Ÿ
â–¡ æ‰€æœ‰çŠ¶æ€å˜é‡ä¿®æ”¹åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å‰ï¼Ÿ
â–¡ æ‰€æœ‰ external call/transfer åœ¨å‡½æ•°æœ«å°¾ï¼Ÿ
â–¡ äº‹ä»¶å‘å‡ºåœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å‰ï¼Ÿ
â–¡ æ˜¯å¦é…åˆä½¿ç”¨äº† ReentrancyGuardï¼Ÿ
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- âœ… ç¼–å†™ç¬¦åˆ CEI æ¨¡å¼çš„å®‰å…¨å‡½æ•°
- âœ… è¯†åˆ«è¿å CEI æ¨¡å¼çš„ä»£ç 
- âœ… é€šè¿‡å®‰å…¨å®¡è®¡çš„åŸºæœ¬è¦æ±‚
- âœ… é˜²æ­¢å¤§éƒ¨åˆ†é‡å…¥æ”»å‡»

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šCEI æ¨¡å¼ ğŸ§

#### ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼šCEI = ATM å–æ¬¾æµç¨‹

æƒ³è±¡ä¸€ä¸ªå®‰å…¨çš„ ATM å–æ¬¾æµç¨‹ï¼š

**æ­£ç¡®æµç¨‹ï¼ˆCEIï¼‰ï¼š**
```
1. CHECKSï¼ˆæ£€æŸ¥ï¼‰
   - éªŒè¯é“¶è¡Œå¡ï¼ˆèº«ä»½éªŒè¯ï¼‰
   - éªŒè¯å¯†ç ï¼ˆæƒé™æ£€æŸ¥ï¼‰
   - æ£€æŸ¥ä½™é¢ï¼ˆä½™é¢éªŒè¯ï¼‰
   - æ£€æŸ¥å–æ¬¾é™é¢ï¼ˆå‚æ•°éªŒè¯ï¼‰

2. EFFECTSï¼ˆæ•ˆæœï¼‰
   - åœ¨ç³»ç»Ÿä¸­æ‰£é™¤ä½™é¢ï¼ˆçŠ¶æ€æ›´æ–°ï¼‰
   - è®°å½•äº¤æ˜“æ—¥å¿—ï¼ˆäº‹ä»¶å‘å‡ºï¼‰
   - æ›´æ–°äº¤æ˜“è®¡æ•°ï¼ˆè®¡æ•°å™¨æ›´æ–°ï¼‰

3. INTERACTIONSï¼ˆäº¤äº’ï¼‰
   - å‡ºé’ï¼ˆå¤–éƒ¨äº¤äº’ï¼‰
   - é€€å¡
```

**é”™è¯¯æµç¨‹ï¼ˆå…ˆå‡ºé’åæ‰£æ¬¾ï¼‰ï¼š**
```
1. æ£€æŸ¥å¯†ç  âœ“
2. å‡ºé’ â† é’±å·²ç»å‡ºæ¥äº†
3. æ›´æ–°ä½™é¢ â† å¦‚æœæ­¤æ—¶æ–­ç”µ...
   - é’±å·²å‡ºï¼Œä½†ä½™é¢æ²¡æ‰£
   - å¯ä»¥é‡å¤å–æ¬¾ï¼
```

**å¯¹åº”ä»£ç ï¼š**

```solidity
// âŒ é”™è¯¯ï¼šå…ˆå‡ºé’åæ‰£æ¬¾
function badATM() external {
    require(password == correct);        // C
    dispense(amount);                    // Iï¼ˆå…ˆäº¤äº’ï¼‰
    balances[msg.sender] -= amount;      // Eï¼ˆåæ•ˆæœï¼‰
}

// âœ… æ­£ç¡®ï¼šå…ˆæ‰£æ¬¾åå‡ºé’
function goodATM() external {
    require(password == correct);        // C
    require(balances[msg.sender] >= amount);  // C
    balances[msg.sender] -= amount;      // Eï¼ˆå…ˆæ•ˆæœï¼‰
    dispense(amount);                    // Iï¼ˆåäº¤äº’ï¼‰
}
```

---

#### å‰ç«¯é¢†åŸŸç±»æ¯”ï¼šCEI = API è¯·æ±‚å¤„ç†æµç¨‹

å¦‚æœä½ åšè¿‡åç«¯å¼€å‘ï¼ŒCEI ç±»ä¼¼äº**è¯·æ±‚å¤„ç†çš„æœ€ä½³å®è·µ**ï¼š

```javascript
// Express.js è·¯ç”±å¤„ç†
app.post('/api/withdraw', async (req, res) => {
    // ===== CHECKS =====
    // 1. èº«ä»½éªŒè¯
    const user = await verifyToken(req.headers.authorization);
    if (!user) return res.status(401).send('Unauthorized');
    
    // 2. å‚æ•°éªŒè¯
    const { amount } = req.body;
    if (!amount || amount <= 0) {
        return res.status(400).send('Invalid amount');
    }
    
    // 3. ä½™é¢éªŒè¯
    if (user.balance < amount) {
        return res.status(400).send('Insufficient balance');
    }
    
    // ===== EFFECTS =====
    // 4. æ•°æ®åº“äº‹åŠ¡å¼€å§‹
    const transaction = await db.beginTransaction();
    try {
        // 5. æ›´æ–°ä½™é¢ï¼ˆåœ¨äº‹åŠ¡ä¸­ï¼‰
        await db.query('UPDATE users SET balance = balance - ? WHERE id = ?', 
                       [amount, user.id]);
        
        // 6. è®°å½•æ—¥å¿—
        await db.query('INSERT INTO logs (user_id, action, amount) VALUES (?, ?, ?)',
                       [user.id, 'withdraw', amount]);
        
        // ===== INTERACTIONS =====
        // 7. è°ƒç”¨å¤–éƒ¨æ”¯ä»˜æœåŠ¡ï¼ˆäº‹åŠ¡å¤–ï¼‰
        const paymentResult = await paymentService.transfer(user.account, amount);
        
        if (paymentResult.success) {
            await transaction.commit();
            res.send({ success: true });
        } else {
            await transaction.rollback();
            res.status(500).send('Payment failed');
        }
    } catch (error) {
        await transaction.rollback();
        res.status(500).send('Internal error');
    }
});
```

**å¯¹åº” Solidityï¼š**

```solidity
function withdraw(uint256 amount) external nonReentrant {
    // ===== CHECKS =====
    require(msg.sender == user, "Unauthorized");
    require(amount > 0, "Invalid amount");
    require(balances[msg.sender] >= amount, "Insufficient balance");
    
    // ===== EFFECTS =====
    balances[msg.sender] -= amount;
    emit Withdrawal(msg.sender, amount);
    
    // ===== INTERACTIONS =====
    (bool success, ) = msg.sender.call{value: amount}("");
    require(success, "Transfer failed");
}
```

**ç±»æ¯”è¡¨ï¼š**

| åç«¯å¼€å‘ | Solidity CEI | è¯´æ˜ |
|---------|-------------|------|
| èº«ä»½éªŒè¯ | require(msg.sender == owner) | æƒé™æ£€æŸ¥ |
| å‚æ•°æ ¡éªŒ | require(amount > 0) | è¾“å…¥éªŒè¯ |
| æ•°æ®åº“æ›´æ–° | balances[user] -= amount | çŠ¶æ€æ›´æ–° |
| æ—¥å¿—è®°å½• | emit Event() | äº‹ä»¶å‘å‡º |
| å¤–éƒ¨ API è°ƒç”¨ | call{value: amount}("") | å¤–éƒ¨äº¤äº’ |
| äº‹åŠ¡å›æ»š | revert | å¤±è´¥å¤„ç† |

---

### ç±»æ¯”æ€»ç»“è¡¨

| CEI é˜¶æ®µ | ç”Ÿæ´»åœºæ™¯ç±»æ¯” | å‰ç«¯é¢†åŸŸç±»æ¯” | æ ¸å¿ƒç›®çš„ |
|---------|-------------|-------------|---------|
| **Checks** | ATMéªŒè¯å¯†ç å’Œä½™é¢ | èº«ä»½éªŒè¯+å‚æ•°æ ¡éªŒ | ç¡®ä¿æ“ä½œåˆæ³• |
| **Effects** | é“¶è¡Œç³»ç»Ÿæ‰£æ¬¾ | æ•°æ®åº“äº‹åŠ¡æ›´æ–° | æ›´æ–°å†…éƒ¨çŠ¶æ€ |
| **Interactions** | ATMå‡ºé’ | è°ƒç”¨å¤–éƒ¨API | ä¸å¤–éƒ¨äº¤äº’ |
| **é¡ºåºé‡è¦æ€§** | å…ˆæ‰£æ¬¾åå‡ºé’ | å…ˆæ›´æ–°åè°ƒç”¨å¤–éƒ¨ | é˜²æ­¢ä¸ä¸€è‡´ |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šéµå¾ª CEI å°±å®Œå…¨ä¸éœ€è¦ ReentrancyGuard âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

CEI æ˜¯å¿…è¦ä½†ä¸å……åˆ†çš„é˜²æŠ¤ï¼š

1. **äººä¸ºé”™è¯¯**ï¼šå¼€å‘è€…å¯èƒ½æ— æ„ä¸­è¿å CEI
2. **å¤æ‚åœºæ™¯**ï¼šå¤šå‡½æ•°äº¤äº’å¯èƒ½å½¢æˆéšè”½çš„é‡å…¥è·¯å¾„
3. **åªè¯»é‡å…¥**ï¼šCEI ä¸èƒ½é˜²æ­¢è¯»å–ä¸ä¸€è‡´çŠ¶æ€

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

CEI æ¦‚å¿µç®€å•æ˜“æ‡‚ï¼Œå®¹æ˜“äº§ç”Ÿ"è¶³å¤Ÿå®‰å…¨"çš„é”™è§‰ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```solidity
// âœ… æœ€ä½³å®è·µï¼šCEI + ReentrancyGuard
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract BestPractice is ReentrancyGuard {
    function withdraw() external nonReentrant {  // Guard ä½œä¸ºä¿é™©
        // Checks
        require(balances[msg.sender] > 0);
        
        // Effects
        uint256 amount = balances[msg.sender];
        balances[msg.sender] = 0;
        
        // Interactions
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success);
    }
}
```

---

### è¯¯åŒº2ï¼šäº‹ä»¶(emit)å¯ä»¥æ”¾åœ¨ Interactions ä¹‹å âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

äº‹ä»¶æ˜¯"Effects"çš„ä¸€éƒ¨åˆ†ï¼Œåº”è¯¥åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å‰ï¼š

1. å¦‚æœå¤–éƒ¨è°ƒç”¨å¤±è´¥å¹¶ revertï¼Œäº‹ä»¶ä¹Ÿä¼šå›æ»šï¼ˆè¿™æ˜¯æ­£ç¡®çš„ï¼‰
2. å¦‚æœå¤–éƒ¨è°ƒç”¨æˆåŠŸä½†åç»­é€»è¾‘å¤±è´¥ï¼Œäº‹ä»¶åº”è¯¥åæ˜ å®é™…çŠ¶æ€
3. æœ‰äº›ç›‘å¬å™¨ä¾èµ–äº‹ä»¶çš„é¡ºåºå’Œæ—¶æœº

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

äº‹ä»¶çœ‹èµ·æ¥åƒæ˜¯"é€šçŸ¥"ï¼Œå¼€å‘è€…è®¤ä¸ºæ“ä½œå®Œæˆåå†é€šçŸ¥æ›´åˆç†ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```solidity
// âŒ é”™è¯¯ï¼šäº‹ä»¶åœ¨äº¤äº’ä¹‹å
function bad() external {
    balances[msg.sender] = 0;
    (bool success, ) = msg.sender.call{value: amount}("");
    emit Withdrawal(msg.sender, amount);  // é¡ºåºé”™è¯¯
}

// âœ… æ­£ç¡®ï¼šäº‹ä»¶åœ¨äº¤äº’ä¹‹å‰
function good() external {
    balances[msg.sender] = 0;
    emit Withdrawal(msg.sender, amount);  // Effects é˜¶æ®µ
    (bool success, ) = msg.sender.call{value: amount}("");
}
```

---

### è¯¯åŒº3ï¼šåªæœ‰è½¬è´¦å‡½æ•°éœ€è¦éµå¾ª CEI âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

ä»»ä½•åŒ…å«å¤–éƒ¨è°ƒç”¨çš„å‡½æ•°éƒ½åº”éµå¾ª CEIï¼Œä¸ä»…ä»…æ˜¯è½¬è´¦ï¼š

1. **ERC-721 safeTransferFrom**ï¼šä¼šè°ƒç”¨æ¥æ”¶æ–¹çš„ `onERC721Received`
2. **ERC-1155 æ‰¹é‡è½¬è´¦**ï¼šä¼šè°ƒç”¨æ¥æ”¶æ–¹çš„é’©å­å‡½æ•°
3. **é¢„è¨€æœºè°ƒç”¨**ï¼šå¯èƒ½è§¦å‘å›è°ƒ
4. **è·¨åˆçº¦è°ƒç”¨**ï¼šä»»ä½• `contract.function()` è°ƒç”¨

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

é‡å…¥æ”»å‡»çš„ç»å…¸æ¡ˆä¾‹æ˜¯ ETH ææ¬¾ï¼Œå¯¼è‡´å…³æ³¨ç‚¹è¿‡äºé›†ä¸­ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```solidity
// ERC-721 çš„ CEI
function safeTransferFrom(address from, address to, uint256 tokenId) public {
    // CHECKS
    require(ownerOf(tokenId) == from);
    require(isApprovedOrOwner(msg.sender, tokenId));
    
    // EFFECTS
    _balances[from] -= 1;
    _balances[to] += 1;
    _owners[tokenId] = to;
    emit Transfer(from, to, tokenId);
    
    // INTERACTIONS
    if (to.code.length > 0) {
        // è°ƒç”¨æ¥æ”¶æ–¹çš„é’©å­ï¼Œå¿…é¡»åœ¨æœ€å
        IERC721Receiver(to).onERC721Received(msg.sender, from, tokenId, "");
    }
}
```

---

## 7. ã€å®æˆ˜ä»£ç ã€‘

### åœºæ™¯1ï¼šè¿å CEI çš„æ¼æ´ä»£ç 

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

// ===== 1. è¿å CEI çš„å¤šç§é”™è¯¯æ¨¡å¼ =====

contract BadPatterns {
    mapping(address => uint256) public balances;
    uint256 public totalSupply;
    
    // âŒ é”™è¯¯1ï¼šE-I-Cï¼ˆæ•ˆæœ-äº¤äº’-æ£€æŸ¥ï¼‰
    function badPattern1(uint256 amount) external {
        balances[msg.sender] -= amount;  // E
        (bool success, ) = msg.sender.call{value: amount}("");  // I
        require(success);  // Cï¼ˆå¤ªæ™šäº†ï¼‰
    }
    
    // âŒ é”™è¯¯2ï¼šC-I-Eï¼ˆæ£€æŸ¥-äº¤äº’-æ•ˆæœï¼‰- ç»å…¸é‡å…¥æ¼æ´
    function badPattern2() external {
        uint256 amount = balances[msg.sender];
        require(amount > 0);  // C
        (bool success, ) = msg.sender.call{value: amount}("");  // I
        require(success);
        balances[msg.sender] = 0;  // Eï¼ˆå¯è¢«é‡å…¥ï¼‰
    }
    
    // âŒ é”™è¯¯3ï¼šI-C-Eï¼ˆäº¤äº’-æ£€æŸ¥-æ•ˆæœï¼‰
    function badPattern3(address token) external {
        IERC20(token).transferFrom(msg.sender, address(this), 100);  // I
        require(allowance[msg.sender] >= 100);  // Cï¼ˆå¤ªæ™šäº†ï¼‰
        balances[msg.sender] += 100;  // E
    }
    
    // âŒ é”™è¯¯4ï¼šC-E-I-Eï¼ˆä¸­é—´å¤šäº†æ•ˆæœï¼‰
    function badPattern4() external {
        require(balances[msg.sender] > 0);  // C
        uint256 amount = balances[msg.sender];
        balances[msg.sender] = 0;  // E
        (bool success, ) = msg.sender.call{value: amount}("");  // I
        totalSupply -= amount;  // Eï¼ˆäº¤äº’ååˆæœ‰æ•ˆæœï¼‰
    }
    
    mapping(address => uint256) public allowance;
    
    receive() external payable {
        balances[msg.sender] += msg.value;
        totalSupply += msg.value;
    }
}

interface IERC20 {
    function transferFrom(address, address, uint256) external returns (bool);
}
```

### åœºæ™¯2ï¼šæ­£ç¡®çš„ CEI å®ç°

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

// ===== 2. æ­£ç¡®çš„ CEI æ¨¡å¼ =====

contract GoodPatterns {
    mapping(address => uint256) public balances;
    uint256 public totalSupply;
    
    event Deposit(address indexed user, uint256 amount);
    event Withdrawal(address indexed user, uint256 amount);
    event Transfer(address indexed from, address indexed to, uint256 amount);
    
    // âœ… æ­£ç¡®çš„ææ¬¾å‡½æ•°
    function withdraw(uint256 amount) external {
        // ===== CHECKS =====
        require(amount > 0, "Amount must be positive");
        require(balances[msg.sender] >= amount, "Insufficient balance");
        
        // ===== EFFECTS =====
        balances[msg.sender] -= amount;
        totalSupply -= amount;
        emit Withdrawal(msg.sender, amount);
        
        // ===== INTERACTIONS =====
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");
    }
    
    // âœ… æ­£ç¡®çš„è½¬è´¦å‡½æ•°
    function transfer(address to, uint256 amount) external {
        // ===== CHECKS =====
        require(to != address(0), "Invalid recipient");
        require(to != msg.sender, "Cannot transfer to self");
        require(amount > 0, "Amount must be positive");
        require(balances[msg.sender] >= amount, "Insufficient balance");
        
        // ===== EFFECTS =====
        balances[msg.sender] -= amount;
        balances[to] += amount;
        emit Transfer(msg.sender, to, amount);
        
        // ===== INTERACTIONS =====
        // å¦‚æœéœ€è¦é€šçŸ¥æ¥æ”¶æ–¹ï¼ˆç±»ä¼¼ ERC-777ï¼‰
        if (to.code.length > 0) {
            // ITokenReceiver(to).onTokenReceived(msg.sender, amount);
        }
    }
    
    // âœ… æ­£ç¡®çš„æ‰¹é‡è½¬è´¦
    function batchTransfer(address[] calldata recipients, uint256[] calldata amounts) external {
        // ===== CHECKS =====
        require(recipients.length == amounts.length, "Length mismatch");
        
        uint256 totalAmount;
        for (uint256 i = 0; i < amounts.length; i++) {
            require(recipients[i] != address(0), "Invalid recipient");
            require(amounts[i] > 0, "Invalid amount");
            totalAmount += amounts[i];
        }
        require(balances[msg.sender] >= totalAmount, "Insufficient balance");
        
        // ===== EFFECTS =====
        balances[msg.sender] -= totalAmount;
        for (uint256 i = 0; i < recipients.length; i++) {
            balances[recipients[i]] += amounts[i];
            emit Transfer(msg.sender, recipients[i], amounts[i]);
        }
        
        // ===== INTERACTIONS =====
        // æ‰¹é‡é€šçŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
    }
    
    receive() external payable {
        balances[msg.sender] += msg.value;
        totalSupply += msg.value;
        emit Deposit(msg.sender, msg.value);
    }
}
```

### åœºæ™¯3ï¼šCEI + ReentrancyGuard æœ€ä½³å®è·µ

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/security/Pausable.sol";

// ===== 3. ç”Ÿäº§çº§åˆ«çš„å®‰å…¨åˆçº¦ =====

contract ProductionVault is ReentrancyGuard, Ownable, Pausable {
    mapping(address => uint256) public balances;
    uint256 public totalDeposits;
    uint256 public constant MAX_WITHDRAWAL = 100 ether;
    uint256 public constant MIN_DEPOSIT = 0.01 ether;
    
    event Deposited(address indexed user, uint256 amount, uint256 newBalance);
    event Withdrawn(address indexed user, uint256 amount, uint256 newBalance);
    event EmergencyWithdraw(address indexed user, uint256 amount);
    
    constructor() Ownable(msg.sender) {}
    
    // å­˜æ¬¾ï¼šCEI æ¨¡å¼
    function deposit() external payable whenNotPaused {
        // ===== CHECKS =====
        require(msg.value >= MIN_DEPOSIT, "Below minimum deposit");
        
        // ===== EFFECTS =====
        balances[msg.sender] += msg.value;
        totalDeposits += msg.value;
        
        emit Deposited(msg.sender, msg.value, balances[msg.sender]);
        
        // ===== INTERACTIONS =====
        // æ— å¤–éƒ¨è°ƒç”¨
    }
    
    // ææ¬¾ï¼šCEI + ReentrancyGuard
    function withdraw(uint256 amount) external nonReentrant whenNotPaused {
        // ===== CHECKS =====
        require(amount > 0, "Amount must be positive");
        require(amount <= MAX_WITHDRAWAL, "Exceeds max withdrawal");
        require(balances[msg.sender] >= amount, "Insufficient balance");
        
        // ===== EFFECTS =====
        balances[msg.sender] -= amount;
        totalDeposits -= amount;
        
        emit Withdrawn(msg.sender, amount, balances[msg.sender]);
        
        // ===== INTERACTIONS =====
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");
    }
    
    // å…¨é¢ææ¬¾
    function withdrawAll() external nonReentrant whenNotPaused {
        // ===== CHECKS =====
        uint256 amount = balances[msg.sender];
        require(amount > 0, "No balance");
        
        // ===== EFFECTS =====
        balances[msg.sender] = 0;
        totalDeposits -= amount;
        
        emit Withdrawn(msg.sender, amount, 0);
        
        // ===== INTERACTIONS =====
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");
    }
    
    // ç´§æ€¥æš‚åœ
    function pause() external onlyOwner {
        _pause();
    }
    
    function unpause() external onlyOwner {
        _unpause();
    }
    
    // ç´§æ€¥ææ¬¾ï¼ˆå³ä½¿æš‚åœä¹Ÿå¯ç”¨ï¼‰
    function emergencyWithdraw() external nonReentrant {
        uint256 amount = balances[msg.sender];
        require(amount > 0, "No balance");
        
        balances[msg.sender] = 0;
        totalDeposits -= amount;
        
        emit EmergencyWithdraw(msg.sender, amount);
        
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");
    }
}
```

### åœºæ™¯4ï¼šCEI æ¨¡å¼çš„ä»£ç å®¡è®¡

```solidity
// ===== 4. ä»£ç å®¡è®¡æ³¨é‡Šæ¨¡æ¿ =====

contract AuditTemplate {
    mapping(address => uint256) public balances;
    
    function auditedFunction(uint256 amount) external {
        // [AUDIT: CHECKS START]
        require(amount > 0, "Invalid amount");           // [CHECK] å‚æ•°éªŒè¯
        require(balances[msg.sender] >= amount, "");     // [CHECK] ä½™é¢éªŒè¯
        // [AUDIT: CHECKS END]
        
        // [AUDIT: EFFECTS START]
        balances[msg.sender] -= amount;                  // [EFFECT] çŠ¶æ€æ›´æ–°
        emit Withdrawn(msg.sender, amount);              // [EFFECT] äº‹ä»¶å‘å‡º
        // [AUDIT: EFFECTS END]
        
        // [AUDIT: INTERACTIONS START]
        (bool success, ) = msg.sender.call{value: amount}("");  // [INTERACTION]
        require(success, "Failed");
        // [AUDIT: INTERACTIONS END]
        
        // [AUDIT: POST-INTERACTION EFFECTS]
        // è¿™é‡Œä¸åº”è¯¥æœ‰ä»»ä½•çŠ¶æ€ä¿®æ”¹ï¼
        // å¦‚æœæœ‰ï¼Œæ ‡è®°ä¸º [VIOLATION]
    }
    
    event Withdrawn(address user, uint256 amount);
}
```

**å®¡è®¡æ£€æŸ¥å‘½ä»¤ï¼ˆä½¿ç”¨ Slitherï¼‰ï¼š**

```bash
# å®‰è£… Slither
pip install slither-analyzer

# æ£€æµ‹é‡å…¥æ¼æ´
slither . --detect reentrancy-eth,reentrancy-no-eth

# æ£€æµ‹çŠ¶æ€å˜é‡åœ¨å¤–éƒ¨è°ƒç”¨åä¿®æ”¹
slither . --detect reentrancy-benign
```

---

## 8. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"ä»€ä¹ˆæ˜¯ CEI æ¨¡å¼ï¼Ÿä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"CEI æ˜¯ Checks-Effects-Interactionsï¼Œå°±æ˜¯å…ˆæ£€æŸ¥ï¼Œå†æ”¹çŠ¶æ€ï¼Œæœ€åå¤–éƒ¨è°ƒç”¨ã€‚ç”¨æ¥é˜²æ­¢é‡å…¥æ”»å‡»ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **CEI æ¨¡å¼å¯ä»¥ä»ä¸‰ä¸ªå±‚é¢ç†è§£ï¼š**
>
> **1. å®šä¹‰å±‚é¢**ï¼š
> CEI æ˜¯æ™ºèƒ½åˆçº¦å‡½æ•°çš„ä»£ç ç»„ç»‡è§„èŒƒï¼š
> - **Checks**ï¼šéªŒè¯æ¡ä»¶ï¼ˆæƒé™ã€ä½™é¢ã€å‚æ•°ï¼‰
> - **Effects**ï¼šä¿®æ”¹çŠ¶æ€ï¼ˆä½™é¢æ›´æ–°ã€äº‹ä»¶å‘å‡ºï¼‰
> - **Interactions**ï¼šå¤–éƒ¨è°ƒç”¨ï¼ˆè½¬è´¦ã€è°ƒç”¨å…¶ä»–åˆçº¦ï¼‰
>
> **2. åŸç†å±‚é¢**ï¼š
> å¤–éƒ¨è°ƒç”¨ä¼šè½¬ç§»æ§åˆ¶æƒã€‚å¦‚æœçŠ¶æ€æ›´æ–°åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹åï¼Œæ”»å‡»è€…å¯ä»¥åœ¨å›è°ƒä¸­çœ‹åˆ°æ—§çŠ¶æ€ï¼Œå¯¼è‡´é‡å…¥æ”»å‡»ã€‚CEI ç¡®ä¿åœ¨äº¤å‡ºæ§åˆ¶æƒå‰ï¼Œåˆçº¦çŠ¶æ€å·²æ˜¯æœ€ç»ˆçŠ¶æ€ã€‚
>
> ```solidity
> // âŒ å…ˆäº¤äº’åæ•ˆæœï¼šå¯è¢«é‡å…¥
> function bad() external {
>     msg.sender.call{value: balance}("");  // æ”»å‡»è€…åœ¨è¿™é‡Œé‡å…¥
>     balances[msg.sender] = 0;              // å¤ªæ™šäº†
> }
> 
> // âœ… å…ˆæ•ˆæœåäº¤äº’ï¼šå®‰å…¨
> function good() external {
>     balances[msg.sender] = 0;              // å…ˆæ›´æ–°çŠ¶æ€
>     msg.sender.call{value: balance}("");   // å³ä½¿é‡å…¥ä¹Ÿå®‰å…¨
> }
> ```
>
> **3. å®è·µå±‚é¢**ï¼š
> - CEI æ˜¯å¿…è¦ä½†ä¸å……åˆ†çš„ï¼Œåº”é…åˆ ReentrancyGuard
> - äº‹ä»¶(emit)å±äº Effectsï¼Œåº”åœ¨ Interactions ä¹‹å‰
> - ä¸ä»…è½¬è´¦éœ€è¦ CEIï¼Œæ‰€æœ‰å¤–éƒ¨è°ƒç”¨éƒ½éœ€è¦
>
> **å†å²æ•™è®­**ï¼š
> The DAO æ”»å‡»å°±æ˜¯å› ä¸ºè¿åäº† CEI æ¨¡å¼ï¼Œåœ¨å¤–éƒ¨è°ƒç”¨åæ‰æ›´æ–°ä½™é¢ï¼Œå¯¼è‡´ 6000 ä¸‡ç¾å…ƒæŸå¤±ã€‚
>
> **å®¡è®¡æŠ€å·§**ï¼š
> æˆ‘å®¡è®¡ä»£ç æ—¶ä¼šæœç´¢æ‰€æœ‰ `call`ã€`transfer`ã€`send` ä»¥åŠå¤–éƒ¨åˆçº¦è°ƒç”¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰çŠ¶æ€ä¿®æ”¹åœ¨å…¶ä¹‹åã€‚

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… åˆ†å±‚æ¬¡è§£é‡Šï¼ˆå®šä¹‰ã€åŸç†ã€å®è·µï¼‰
2. âœ… æœ‰å¯¹æ¯”ä»£ç ç¤ºä¾‹
3. âœ… æåˆ°äº†è¾¹ç•Œæƒ…å†µï¼ˆäº‹ä»¶ã€ReentrancyGuardï¼‰
4. âœ… è”ç³»äº†å†å²æ¡ˆä¾‹å’Œå®é™…å®¡è®¡

---

### é—®é¢˜2ï¼š"å¦‚ä½•è¯†åˆ«è¿å CEI æ¨¡å¼çš„ä»£ç ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"çœ‹ä»£ç é¡ºåºï¼Œå¦‚æœå¤–éƒ¨è°ƒç”¨åœ¨çŠ¶æ€ä¿®æ”¹ä¹‹å‰å°±æ˜¯æœ‰é—®é¢˜çš„ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **è¯†åˆ« CEI è¿è§„éœ€è¦ç³»ç»ŸåŒ–çš„æ–¹æ³•ï¼š**
>
> **1. é™æ€åˆ†æå·¥å…·**ï¼š
> ```bash
> # Slither è‡ªåŠ¨æ£€æµ‹
> slither . --detect reentrancy-eth,reentrancy-no-eth,reentrancy-benign
> 
> # å¸¸è§æ£€æµ‹ç»“æœ
> # - reentrancy-eth: æ¶‰åŠ ETH çš„é‡å…¥
> # - reentrancy-no-eth: ä¸æ¶‰åŠ ETH çš„é‡å…¥
> # - reentrancy-benign: è‰¯æ€§é‡å…¥ï¼ˆå¯èƒ½è¯¯æŠ¥ï¼‰
> ```
>
> **2. æ‰‹åŠ¨å®¡è®¡æ¸…å•**ï¼š
> ```
> â–¡ æœç´¢æ‰€æœ‰ .call(, .transfer(, .send(
> â–¡ æœç´¢æ‰€æœ‰å¤–éƒ¨åˆçº¦å‡½æ•°è°ƒç”¨
> â–¡ æ£€æŸ¥æ¯ä¸ªå¤–éƒ¨è°ƒç”¨åæ˜¯å¦æœ‰çŠ¶æ€ä¿®æ”¹
> â–¡ æ£€æŸ¥äº‹ä»¶æ˜¯å¦åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å‰
> â–¡ æ£€æŸ¥æ˜¯å¦æœ‰è·¨å‡½æ•°çš„éšå¼ä¾èµ–
> ```
>
> **3. å±é™©æ¨¡å¼è¯†åˆ«**ï¼š
> ```solidity
> // å±é™©æ¨¡å¼1ï¼šcall åæœ‰èµ‹å€¼
> target.call(...);
> stateVar = value;  // âŒ
> 
> // å±é™©æ¨¡å¼2ï¼šå¾ªç¯ä¸­æœ‰å¤–éƒ¨è°ƒç”¨
> for (uint i = 0; i < users.length; i++) {
>     users[i].call{value: amounts[i]}("");
>     balances[users[i]] = 0;  // âŒ
> }
> 
> // å±é™©æ¨¡å¼3ï¼šè·¨å‡½æ•°çŠ¶æ€ä¾èµ–
> function withdraw() {
>     _transfer(amount);  // å†…éƒ¨æœ‰å¤–éƒ¨è°ƒç”¨
>     balances[msg.sender] = 0;  // âŒ å¦‚æœ _transfer æœ‰å¤–éƒ¨è°ƒç”¨
> }
> ```
>
> **4. ä»£ç æ ‡æ³¨ä¹ æƒ¯**ï¼š
> ```solidity
> function safe() external {
>     // === CHECKS ===
>     require(condition);
>     
>     // === EFFECTS ===
>     state = newValue;
>     emit Event();
>     
>     // === INTERACTIONS ===
>     external.call();
>     
>     // è¿™é‡Œä¸åº”è¯¥æœ‰ä»£ç ï¼
> }
> ```
>
> **å®é™…ç»éªŒ**ï¼š
> åœ¨å®¡è®¡ä¸­ï¼Œæˆ‘å‘ç°å¾ˆå¤šè¿è§„æ˜¯å› ä¸ºåæœŸä¿®æ”¹ä»£ç æ—¶ä¸å°å¿ƒåœ¨ Interactions åæ·»åŠ äº† Effectsã€‚å»ºè®®ä½¿ç”¨æ³¨é‡Šæ ‡è®°å„é˜¶æ®µï¼Œæ–¹ä¾¿ç»´æŠ¤å’Œå®¡è®¡ã€‚

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… æä¾›äº†å·¥å…·å’Œæ‰‹åŠ¨æ–¹æ³•
2. âœ… ç»™å‡ºäº†å…·ä½“çš„å±é™©æ¨¡å¼
3. âœ… æœ‰å®ç”¨çš„ä»£ç æ ‡æ³¨å»ºè®®
4. âœ… åˆ†äº«äº†å®é™…å®¡è®¡ç»éªŒ

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šCEI æ˜¯ä»€ä¹ˆï¼Ÿ ğŸ“‹

**ä¸€å¥è¯ï¼š** Checks-Effects-Interactionsï¼Œæ™ºèƒ½åˆçº¦å‡½æ•°çš„ä»£ç ç»„ç»‡è§„èŒƒã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
function withdraw() external {
    require(balance > 0);        // Checks
    balance = 0;                 // Effects
    msg.sender.call{value: b}(); // Interactions
}
```

**åº”ç”¨ï¼š** æ‰€æœ‰æ¶‰åŠå¤–éƒ¨è°ƒç”¨çš„å‡½æ•°éƒ½åº”éµå¾ª CEI æ¨¡å¼ã€‚

---

### å¡ç‰‡2ï¼šChecks é˜¶æ®µ âœ“

**ä¸€å¥è¯ï¼š** åœ¨å‡½æ•°å¼€å¤´éªŒè¯æ‰€æœ‰å‰ç½®æ¡ä»¶ï¼ŒåŒ…æ‹¬æƒé™ã€ä½™é¢ã€å‚æ•°ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// CHECKS
require(msg.sender == owner, "Not owner");
require(amount > 0, "Invalid amount");
require(balances[msg.sender] >= amount, "Insufficient");
```

**åº”ç”¨ï¼š** å¤±è´¥å¿«é€ŸåŸåˆ™ - å°½æ—©å‘ç°é—®é¢˜ï¼ŒèŠ‚çœ Gasã€‚

---

### å¡ç‰‡3ï¼šEffects é˜¶æ®µ âœï¸

**ä¸€å¥è¯ï¼š** ä¿®æ”¹æ‰€æœ‰çŠ¶æ€å˜é‡å’Œå‘å‡ºäº‹ä»¶ï¼Œå¿…é¡»åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å‰ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// EFFECTS
balances[msg.sender] -= amount;
totalSupply -= amount;
emit Withdrawal(msg.sender, amount);
```

**åº”ç”¨ï¼š** äº‹ä»¶(emit)ä¹Ÿæ˜¯ Effects çš„ä¸€éƒ¨åˆ†ï¼

---

### å¡ç‰‡4ï¼šInteractions é˜¶æ®µ ğŸ”—

**ä¸€å¥è¯ï¼š** æ‰€æœ‰å¤–éƒ¨è°ƒç”¨æ”¾åœ¨å‡½æ•°æœ€åï¼ŒåŒ…æ‹¬è½¬è´¦å’Œåˆçº¦è°ƒç”¨ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// INTERACTIONS
(bool success, ) = msg.sender.call{value: amount}("");
require(success, "Transfer failed");
// è¿™ä¹‹åä¸åº”è¯¥æœ‰ä»»ä½•ä»£ç 
```

**åº”ç”¨ï¼š** å¤–éƒ¨è°ƒç”¨åä¸åº”æœ‰ä»»ä½•çŠ¶æ€ä¿®æ”¹ã€‚

---

### å¡ç‰‡5ï¼šä¸ºä»€ä¹ˆé¡ºåºé‡è¦ âš ï¸

**ä¸€å¥è¯ï¼š** å¤–éƒ¨è°ƒç”¨è½¬ç§»æ§åˆ¶æƒï¼Œå¦‚æœçŠ¶æ€æœªæ›´æ–°ï¼Œå›è°ƒä¼šçœ‹åˆ°æ—§çŠ¶æ€ã€‚

**ä¸¾ä¾‹ï¼š**
```
æ­£ç¡®ï¼šbalance = 0 â†’ call â†’ æ”»å‡»è€…é‡å…¥ â†’ æ£€æŸ¥ balance = 0 â†’ å¤±è´¥
é”™è¯¯ï¼šcall â†’ æ”»å‡»è€…é‡å…¥ â†’ æ£€æŸ¥ balance > 0 â†’ æˆåŠŸ â†’ å†æ¬¡ææ¬¾
```

**åº”ç”¨ï¼š** The DAO æ”»å‡»å°±æ˜¯å› ä¸ºè¿åäº†è¿™ä¸ªé¡ºåºã€‚

---

### å¡ç‰‡6ï¼šCEI + ReentrancyGuard ğŸ”’

**ä¸€å¥è¯ï¼š** CEI æ˜¯å¿…è¦ä½†ä¸å……åˆ†çš„ï¼Œåº”é…åˆ ReentrancyGuard ä½¿ç”¨ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

function withdraw() external nonReentrant {
    // CEI æ¨¡å¼ä»£ç 
}
```

**åº”ç”¨ï¼š** åŒé‡ä¿æŠ¤ = CEI + ReentrancyGuardã€‚

---

### å¡ç‰‡7ï¼šå¸¸è§é”™è¯¯æ¨¡å¼ âŒ

**ä¸€å¥è¯ï¼š** åœ¨å¤–éƒ¨è°ƒç”¨åä¿®æ”¹çŠ¶æ€æ˜¯æœ€å¸¸è§çš„é”™è¯¯ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// âŒ é”™è¯¯æ¨¡å¼
msg.sender.call{value: amount}("");
balance = 0;  // å¤ªæ™šäº†ï¼

// âŒ é”™è¯¯æ¨¡å¼
for (...) {
    call(...);
    state = value;  // å¾ªç¯ä¸­çš„äº¤äº’åæ•ˆæœ
}
```

**åº”ç”¨ï¼š** å®¡è®¡æ—¶é‡ç‚¹æœç´¢ `call` åçš„èµ‹å€¼è¯­å¥ã€‚

---

### å¡ç‰‡8ï¼šäº‹ä»¶çš„æ­£ç¡®ä½ç½® ğŸ“¢

**ä¸€å¥è¯ï¼š** äº‹ä»¶(emit)æ˜¯ Effects çš„ä¸€éƒ¨åˆ†ï¼Œåº”åœ¨ Interactions ä¹‹å‰ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// âœ… æ­£ç¡®
balance = 0;
emit Withdrawal(msg.sender, amount);  // Effects
call{value: amount}("");               // Interactions

// âŒ é”™è¯¯
call{value: amount}("");
emit Withdrawal(msg.sender, amount);  // é¡ºåºé”™è¯¯
```

**åº”ç”¨ï¼š** ç¡®ä¿äº‹ä»¶åæ˜ çš„æ˜¯æœ€ç»ˆçŠ¶æ€ã€‚

---

### å¡ç‰‡9ï¼šæ‰¹é‡æ“ä½œçš„ CEI ğŸ“¦

**ä¸€å¥è¯ï¼š** æ‰¹é‡æ“ä½œæ—¶ï¼Œæ‰€æœ‰ Effects åº”åœ¨æ‰€æœ‰ Interactions ä¹‹å‰ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// âœ… æ­£ç¡®çš„æ‰¹é‡è½¬è´¦
// 1. æ‰€æœ‰ Checks
for (...) { require(...); }

// 2. æ‰€æœ‰ Effects
for (...) { balances[to] += amount; }

// 3. æ‰€æœ‰ Interactions
for (...) { to.call{value: amount}(""); }
```

**åº”ç”¨ï¼š** ä¸è¦åœ¨å¾ªç¯ä¸­äº¤æ›¿æ‰§è¡Œ Effects å’Œ Interactionsã€‚

---

### å¡ç‰‡10ï¼šå®¡è®¡æŠ€å·§ ğŸ”

**ä¸€å¥è¯ï¼š** ä½¿ç”¨å·¥å…· + æ‰‹åŠ¨æ£€æŸ¥ + ä»£ç æ ‡æ³¨ç¡®ä¿ CEI åˆè§„ã€‚

**æ ¸å¿ƒå®è·µï¼š**
```bash
# 1. å·¥å…·æ£€æµ‹
slither . --detect reentrancy-eth

# 2. ä»£ç æ ‡æ³¨
// === CHECKS ===
// === EFFECTS ===
// === INTERACTIONS ===

# 3. å®¡è®¡æ¸…å•
â–¡ å¤–éƒ¨è°ƒç”¨åæ— çŠ¶æ€ä¿®æ”¹
â–¡ äº‹ä»¶åœ¨äº¤äº’ä¹‹å‰
â–¡ é…åˆ ReentrancyGuard
```

**å»¶ä¼¸å­¦ä¹ ï¼š**
- [Consensys Smart Contract Best Practices](https://consensys.github.io/smart-contract-best-practices/)
- [SWC Registry - Reentrancy](https://swcregistry.io/docs/SWC-107)

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**CEIæ¨¡å¼ï¼ˆChecks-Effects-Interactionsï¼‰æ˜¯æ™ºèƒ½åˆçº¦çš„é˜²å¾¡æ€§ç¼–ç¨‹è§„èŒƒï¼Œè¦æ±‚å‡½æ•°æŒ‰"æ£€æŸ¥æ¡ä»¶â†’æ›´æ–°çŠ¶æ€â†’å¤–éƒ¨è°ƒç”¨"çš„é¡ºåºæ‰§è¡Œï¼Œç¡®ä¿åœ¨äº¤å‡ºæ§åˆ¶æƒå‰åˆçº¦çŠ¶æ€å·²æ˜¯æœ€ç»ˆçŠ¶æ€ï¼Œä»æ ¹æœ¬ä¸Šé˜²æ­¢é‡å…¥æ”»å‡»ï¼Œåº”ä¸ReentrancyGuardé…åˆä½¿ç”¨å½¢æˆåŒé‡ä¿æŠ¤ã€‚**

---

## ğŸ“š é™„å½•

### å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬çŸ¥è¯†ç‚¹å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š CEI æ¨¡å¼çš„ä¸‰ä¸ªé˜¶æ®µ
- [ ] è¯´æ˜ä¸ºä»€ä¹ˆé¡ºåºé‡è¦
- [ ] è¯†åˆ«è¿å CEI çš„ä»£ç 
- [ ] é‡æ„ä¸ç¬¦åˆ CEI çš„å‡½æ•°
- [ ] ç†è§£äº‹ä»¶å±äº Effects é˜¶æ®µ
- [ ] æ­£ç¡®å¤„ç†æ‰¹é‡æ“ä½œçš„ CEI
- [ ] é…åˆ ReentrancyGuard ä½¿ç”¨
- [ ] ä½¿ç”¨å·¥å…·æ£€æµ‹ CEI è¿è§„

### å¿«é€Ÿå‚è€ƒå¡

**CEI æ¨¡æ¿ï¼š**
```solidity
function template() external {
    // === CHECKS ===
    require(condition);
    
    // === EFFECTS ===
    stateVar = newValue;
    emit Event();
    
    // === INTERACTIONS ===
    externalCall();
}
```

**å±é™©ä¿¡å·ï¼š**
```solidity
// âŒ å¤–éƒ¨è°ƒç”¨åæœ‰èµ‹å€¼
call();
state = value;

// âŒ å¾ªç¯ä¸­æ··åˆ E å’Œ I
for (...) {
    call();
    state = value;
}
```

**æœ€ä½³å®è·µï¼š**
```solidity
contract Best is ReentrancyGuard {
    function safe() external nonReentrant {
        // CEI æ¨¡å¼
    }
}
```

### å‚è€ƒèµ„æº

- [Consensys Smart Contract Best Practices](https://consensys.github.io/smart-contract-best-practices/)
- [SWC-107: Reentrancy](https://swcregistry.io/docs/SWC-107)
- [OpenZeppelin ReentrancyGuard](https://docs.openzeppelin.com/contracts/4.x/api/security#ReentrancyGuard)
- [Solidity by Example - CEI Pattern](https://solidity-by-example.org/hacks/re-entrancy/)

---

**ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2025-12-08
**é€‚ç”¨äººç¾¤ï¼š** å‰ç«¯å·¥ç¨‹å¸ˆè½¬Web3å¼€å‘

---

**è®°ä½ï¼š** Checks â†’ Effects â†’ Interactionsï¼Œè¿™ä¸ªé¡ºåºä¸èƒ½é¢ å€’ï¼åœ¨äº¤å‡ºæ§åˆ¶æƒå‰ï¼Œç¡®ä¿çŠ¶æ€å·²æ˜¯æœ€ç»ˆçŠ¶æ€ã€‚ğŸ›¡ï¸
