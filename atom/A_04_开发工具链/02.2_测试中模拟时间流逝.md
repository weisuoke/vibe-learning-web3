# å¦‚ä½•åœ¨æµ‹è¯•ä¸­æ¨¡æ‹Ÿæ—¶é—´æµé€ï¼Ÿ

## 1. ã€30å­—æ ¸å¿ƒã€‘

**ä½¿ç”¨ Hardhat Network Helpers çš„ `time.increase()` å’Œ `mine()` å¯ä»¥åœ¨æµ‹è¯•ä¸­æ¨¡æ‹Ÿæ—¶é—´æµé€å’ŒåŒºå—æ¨è¿›ï¼Œç”¨äºæµ‹è¯•æ—¶é—´é”ã€é”ä»“ç­‰åœºæ™¯ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### æ—¶é—´æ¨¡æ‹Ÿçš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**æ—¶é—´æ¨¡æ‹Ÿ = åœ¨æµ‹è¯•ä¸­æ§åˆ¶åŒºå—é“¾çš„æ—¶é—´æˆ³å’ŒåŒºå—å·**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

#### 2. ä¸ºä»€ä¹ˆéœ€è¦æ¨¡æ‹Ÿæ—¶é—´ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•æµ‹è¯•ä¾èµ–æ—¶é—´çš„åˆçº¦é€»è¾‘ï¼Ÿ**

æ™ºèƒ½åˆçº¦ä¸­å¸¸è§çš„æ—¶é—´ç›¸å…³é€»è¾‘ï¼š
- **æ—¶é—´é”ï¼ˆTimeLockï¼‰**ï¼šN å¤©åæ‰èƒ½æå–èµ„é‡‘
- **ä»£å¸é”ä»“ï¼ˆVestingï¼‰**ï¼šæŒ‰æœˆè§£é”ä»£å¸
- **æŠ•ç¥¨æœŸé™**ï¼šææ¡ˆåœ¨æˆªæ­¢æ—¶é—´å‰å¯æŠ•ç¥¨
- **åˆ©æ¯è®¡ç®—**ï¼šæ ¹æ®æ—¶é—´è®¡ç®—åˆ©æ¯
- **æ‹å–ç»“æŸ**ï¼šåˆ°æœŸåç»“ç®—æ‹å–

å¦‚æœä¸èƒ½æ§åˆ¶æ—¶é—´ï¼Œæµ‹è¯•è¿™äº›é€»è¾‘éœ€è¦**çœŸçš„ç­‰å¾…**ï¼ˆå‡ åˆ†é’Ÿåˆ°å‡ å¹´ï¼‰ã€‚

#### 3. æ—¶é—´æ¨¡æ‹Ÿçš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šæµ‹è¯•å¯è¡Œæ€§ï¼ˆå¿«é€ŸéªŒè¯ï¼‰

**é—®é¢˜**ï¼šå¦‚ä½•æµ‹è¯•"30 å¤©åæ‰èƒ½æå–"çš„é€»è¾‘ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šæ¨¡æ‹Ÿæ—¶é—´è·³è¿‡ 30 å¤©ã€‚

**ç¤ºä¾‹**ï¼š
```javascript
// ä¸ç”¨æ¨¡æ‹Ÿï¼šéœ€è¦ç­‰å¾… 30 å¤©ï¼ˆ2,592,000 ç§’ï¼‰
await new Promise(r => setTimeout(r, 2592000000));  // âŒ ä¸å¯è¡Œ

// ä½¿ç”¨æ¨¡æ‹Ÿï¼šç«‹å³è·³è¿‡ 30 å¤©
await time.increase(30 * 24 * 60 * 60);  // âœ… æ¯«ç§’å®Œæˆ
```

##### ä»·å€¼2ï¼šè¾¹ç•Œæµ‹è¯•ï¼ˆç²¾ç¡®æ§åˆ¶ï¼‰

**é—®é¢˜**ï¼šå¦‚ä½•æµ‹è¯•"æ°å¥½åœ¨æˆªæ­¢æ—¶é—´å‰å"çš„è¡Œä¸ºå·®å¼‚ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šç²¾ç¡®è®¾ç½®æ—¶é—´åˆ°è¾¹ç•Œç‚¹ã€‚

**ç¤ºä¾‹**ï¼š
```javascript
// æˆªæ­¢æ—¶é—´å‰ 1 ç§’
await time.increaseTo(deadline - 1);
await expect(contract.vote(1)).to.not.be.reverted;  // âœ… å¯ä»¥æŠ•ç¥¨

// æˆªæ­¢æ—¶é—´å
await time.increaseTo(deadline + 1);
await expect(contract.vote(1)).to.be.revertedWith("Voting ended");  // âœ… è¿‡æœŸ
```

##### ä»·å€¼3ï¼šçŠ¶æ€éªŒè¯ï¼ˆå¤šé˜¶æ®µæµ‹è¯•ï¼‰

**é—®é¢˜**ï¼šå¦‚ä½•æµ‹è¯• Vesting åˆçº¦çš„æœˆåº¦è§£é”ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šæ¨¡æ‹Ÿå¤šä¸ªæ—¶é—´ç‚¹ï¼ŒéªŒè¯æ¯ä¸ªé˜¶æ®µçš„çŠ¶æ€ã€‚

**ç¤ºä¾‹**ï¼š
```javascript
// åˆå§‹ï¼šä¸èƒ½æå–
expect(await vesting.claimable()).to.equal(0);

// 1 ä¸ªæœˆåï¼šå¯æå– 25%
await time.increase(30 * 24 * 60 * 60);
expect(await vesting.claimable()).to.equal(totalAmount / 4n);

// 4 ä¸ªæœˆåï¼šå¯æå– 100%
await time.increase(90 * 24 * 60 * 60);
expect(await vesting.claimable()).to.equal(totalAmount);
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼æ—¶é—´æ¨¡æ‹Ÿæœºåˆ¶

**æ¨ç†é“¾ï¼š**

```
1. å‰æï¼šæ™ºèƒ½åˆçº¦ä½¿ç”¨ block.timestamp è·å–æ—¶é—´
   â†“
2. æ¨å¯¼ï¼šæµ‹è¯•éœ€è¦æ§åˆ¶ block.timestamp â†’ Hardhat Network æä¾›æ§åˆ¶æ¥å£
   â†“
3. æ¨å¯¼ï¼šæ—¶é—´å˜åŒ–éœ€è¦æ–°åŒºå— â†’ æä¾› evm_mine æŒ–çŸ¿å‘½ä»¤
   â†“
4. æ¨å¯¼ï¼šéœ€è¦ä¾¿æ· API â†’ hardhat-network-helpers å°è£…
   â†“
5. æ¨å¯¼ï¼šå¸¸ç”¨æ“ä½œåŒ…æ‹¬ï¼š
   - time.increase(seconds)ï¼šå¢åŠ æ—¶é—´
   - time.increaseTo(timestamp)ï¼šè®¾ç½®åˆ°ç‰¹å®šæ—¶é—´
   - time.latest()ï¼šè·å–å½“å‰æ—¶é—´
   - mine(blocks)ï¼šæŒ–æŒ‡å®šæ•°é‡çš„åŒºå—
   â†“
6. æœ€ç»ˆå®ç°ï¼šå®Œæ•´çš„æ—¶é—´æ¨¡æ‹Ÿå·¥å…·é“¾
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**æ—¶é—´æ¨¡æ‹Ÿçš„æœ¬è´¨æ˜¯æ§åˆ¶ Hardhat Network çš„ block.timestampï¼Œè®©æµ‹è¯•å¯ä»¥"å¿«è¿›"åˆ°æœªæ¥ä»»æ„æ—¶é—´ç‚¹ï¼ŒéªŒè¯æ—¶é—´ä¾èµ–çš„åˆçº¦é€»è¾‘åœ¨å„ä¸ªæ—¶é—´èŠ‚ç‚¹çš„æ­£ç¡®æ€§ã€‚**

---

## 3. ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼štime.increase() - å¢åŠ æ—¶é—´ â©

**ä¸€å¥è¯å®šä¹‰ï¼š** `time.increase(seconds)` å°†åŒºå—é“¾æ—¶é—´å‘å‰æ¨è¿›æŒ‡å®šçš„ç§’æ•°ï¼Œå¹¶è‡ªåŠ¨æŒ–ä¸€ä¸ªæ–°åŒºå—ã€‚

```javascript
const { time } = require("@nomicfoundation/hardhat-network-helpers");

async function main() {
  // è·å–å½“å‰æ—¶é—´
  const before = await time.latest();
  console.log("Before:", new Date(before * 1000).toISOString());

  // å¢åŠ  1 å°æ—¶ï¼ˆ3600 ç§’ï¼‰
  await time.increase(3600);

  const after = await time.latest();
  console.log("After:", new Date(after * 1000).toISOString());
  console.log("Difference:", after - before, "seconds");  // 3600
}

// å¸¸ç”¨æ—¶é—´å¸¸é‡
const ONE_MINUTE = 60;
const ONE_HOUR = 60 * 60;
const ONE_DAY = 24 * 60 * 60;
const ONE_WEEK = 7 * ONE_DAY;
const ONE_MONTH = 30 * ONE_DAY;
const ONE_YEAR = 365 * ONE_DAY;

// ä½¿ç”¨æ—¶é—´å¸¸é‡
await time.increase(ONE_DAY);      // å¢åŠ  1 å¤©
await time.increase(ONE_WEEK);     // å¢åŠ  1 å‘¨
await time.increase(6 * ONE_MONTH); // å¢åŠ  6 ä¸ªæœˆ
```

**è¯¦ç»†è§£é‡Šï¼š**

`time.increase()` å†…éƒ¨åšäº†ä¸¤ä»¶äº‹ï¼š
1. è°ƒç”¨ `evm_increaseTime`ï¼šå¢åŠ åŒºå—é“¾çš„å†…éƒ¨æ—¶é’Ÿ
2. è°ƒç”¨ `evm_mine`ï¼šæŒ–ä¸€ä¸ªæ–°åŒºå—ï¼ˆä½¿æ—¶é—´å˜åŒ–ç”Ÿæ•ˆï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦æŒ–çŸ¿ï¼Ÿ**

æ™ºèƒ½åˆçº¦é€šè¿‡ `block.timestamp` è·å–æ—¶é—´ï¼Œè¿™ä¸ªå€¼æ˜¯å½“å‰åŒºå—çš„æ—¶é—´æˆ³ã€‚åªæœ‰äº§ç”Ÿæ–°åŒºå—ï¼Œæ–°çš„æ—¶é—´æˆ³æ‰ä¼šç”Ÿæ•ˆã€‚

**åœ¨æ™ºèƒ½åˆçº¦æµ‹è¯•ä¸­çš„åº”ç”¨ï¼š**

```javascript
describe("TimeLock", function () {
  it("Should unlock after lock period", async function () {
    const LOCK_PERIOD = 7 * 24 * 60 * 60;  // 7 å¤©

    // å­˜å…¥èµ„é‡‘
    await timeLock.deposit({ value: ethers.parseEther("1") });

    // ç«‹å³æå–åº”è¯¥å¤±è´¥
    await expect(timeLock.withdraw())
      .to.be.revertedWith("Still locked");

    // æ—¶é—´å¿«è¿› 7 å¤©
    await time.increase(LOCK_PERIOD);

    // ç°åœ¨å¯ä»¥æå–äº†
    await timeLock.withdraw();
  });
});
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼štime.increaseTo() - è®¾ç½®åˆ°ç‰¹å®šæ—¶é—´ ğŸ“…

**ä¸€å¥è¯å®šä¹‰ï¼š** `time.increaseTo(timestamp)` å°†åŒºå—é“¾æ—¶é—´è®¾ç½®åˆ°æŒ‡å®šçš„ Unix æ—¶é—´æˆ³ã€‚

```javascript
const { time } = require("@nomicfoundation/hardhat-network-helpers");

async function main() {
  // è·å–å½“å‰æ—¶é—´
  const now = await time.latest();
  console.log("Current:", now);

  // è®¾ç½®åˆ°ç‰¹å®šæ—¶é—´ç‚¹ï¼ˆå¿…é¡»æ˜¯æœªæ¥ï¼‰
  const targetTime = now + 86400;  // æ˜å¤©
  await time.increaseTo(targetTime);

  console.log("After:", await time.latest());  // === targetTime

  // âŒ ä¸èƒ½è®¾ç½®åˆ°è¿‡å»
  await time.increaseTo(now);  // Error: Cannot set time to a past timestamp
}

// å®ç”¨åœºæ™¯ï¼šè®¾ç½®åˆ°ç‰¹å®šæ—¥æœŸ
const christmas2024 = Math.floor(new Date("2024-12-25T00:00:00Z").getTime() / 1000);
await time.increaseTo(christmas2024);
```

**ä¸ time.increase() çš„åŒºåˆ«ï¼š**

| æ–¹æ³• | å‚æ•° | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|---------|
| `time.increase(seconds)` | ç›¸å¯¹ç§’æ•° | å¢åŠ  N ç§’ | ç­‰å¾…å›ºå®šæ—¶é•¿ |
| `time.increaseTo(timestamp)` | ç»å¯¹æ—¶é—´æˆ³ | è®¾ç½®åˆ°ç‰¹å®šæ—¶é—´ | æµ‹è¯•è¾¹ç•Œæ¡ä»¶ |

**åœ¨æ™ºèƒ½åˆçº¦æµ‹è¯•ä¸­çš„åº”ç”¨ï¼š**

```javascript
describe("Auction", function () {
  it("Should test exact deadline boundary", async function () {
    const deadline = (await time.latest()) + 3600;  // 1 å°æ—¶åç»“æŸ
    await auction.createAuction(deadline);

    // æˆªæ­¢å‰ 1 ç§’ï¼šå¯ä»¥å‡ºä»·
    await time.increaseTo(deadline - 1);
    await expect(auction.bid({ value: 100 })).to.not.be.reverted;

    // æ°å¥½æˆªæ­¢æ—¶é—´ï¼šå¯ä»¥å‡ºä»·ï¼ˆ<=ï¼‰
    await time.increaseTo(deadline);
    await expect(auction.bid({ value: 200 })).to.not.be.reverted;

    // æˆªæ­¢å 1 ç§’ï¼šä¸èƒ½å‡ºä»·
    await time.increaseTo(deadline + 1);
    await expect(auction.bid({ value: 300 }))
      .to.be.revertedWith("Auction ended");
  });
});
```

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šmine() - æŒ–çŸ¿æ¨è¿›åŒºå— â›ï¸

**ä¸€å¥è¯å®šä¹‰ï¼š** `mine(blocks)` æŒ–æŒ‡å®šæ•°é‡çš„ç©ºåŒºå—ï¼Œæ¨è¿› `block.number` è€Œä¸æ”¹å˜æ—¶é—´æˆ³ã€‚

```javascript
const { mine, time } = require("@nomicfoundation/hardhat-network-helpers");

async function main() {
  // è·å–å½“å‰åŒºå—å·
  const beforeBlock = await ethers.provider.getBlockNumber();
  console.log("Before block:", beforeBlock);

  // æŒ– 10 ä¸ªåŒºå—
  await mine(10);

  const afterBlock = await ethers.provider.getBlockNumber();
  console.log("After block:", afterBlock);
  console.log("Mined:", afterBlock - beforeBlock, "blocks");  // 10

  // æŒ–çŸ¿æ—¶æŒ‡å®šæ—¶é—´é—´éš”ï¼ˆæ¯ä¸ªåŒºå—ç›¸éš” 12 ç§’ï¼‰
  await mine(5, { interval: 12 });
  // åŒºå—å· +5ï¼Œæ—¶é—´ +60 ç§’
}
```

**block.number vs block.timestampï¼š**

æœ‰äº›åˆçº¦é€»è¾‘ä¾èµ–åŒºå—å·è€Œéæ—¶é—´ï¼š

```solidity
// ä¾èµ–åŒºå—å·çš„é€»è¾‘
contract BlockVoting {
    uint256 public endBlock;

    function vote() external {
        require(block.number <= endBlock, "Voting ended");
        // ...
    }
}

// æµ‹è¯•
it("Should end voting after certain blocks", async function () {
  const currentBlock = await ethers.provider.getBlockNumber();
  await voting.createProposal(currentBlock + 100);  // 100 åŒºå—åç»“æŸ

  // æ¨è¿› 99 ä¸ªåŒºå—ï¼šå¯ä»¥æŠ•ç¥¨
  await mine(99);
  await voting.vote(1);

  // å†æ¨è¿› 2 ä¸ªåŒºå—ï¼šä¸èƒ½æŠ•ç¥¨
  await mine(2);
  await expect(voting.vote(1)).to.be.revertedWith("Voting ended");
});
```

**æ—¶é—´ + åŒºå—ç»„åˆä½¿ç”¨ï¼š**

```javascript
// åœºæ™¯ï¼šæŸåè®®è¦æ±‚ç­‰å¾… 1 å¤© + 10 ä¸ªåŒºå—ç¡®è®¤
await time.increase(ONE_DAY);  // å¢åŠ  1 å¤©
await mine(10);                 // æŒ– 10 ä¸ªåŒºå—
await protocol.execute();       // ç°åœ¨å¯ä»¥æ‰§è¡Œ
```

---

## 4. ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½åœ¨æµ‹è¯•ä¸­æ¨¡æ‹Ÿæ—¶é—´æµé€ï¼š

### 4.1 åŸºç¡€è®¾ç½®

```javascript
const { time, mine } = require("@nomicfoundation/hardhat-network-helpers");

// æ—¶é—´å¸¸é‡
const ONE_MINUTE = 60;
const ONE_HOUR = 60 * 60;
const ONE_DAY = 24 * 60 * 60;
const ONE_WEEK = 7 * ONE_DAY;
```

### 4.2 å¢åŠ æ—¶é—´

```javascript
// å¢åŠ å›ºå®šæ—¶é•¿
await time.increase(ONE_DAY);       // å¢åŠ  1 å¤©
await time.increase(3 * ONE_HOUR);  // å¢åŠ  3 å°æ—¶

// è®¾ç½®åˆ°ç‰¹å®šæ—¶é—´
const deadline = (await time.latest()) + ONE_WEEK;
await time.increaseTo(deadline);
```

### 4.3 è·å–å½“å‰æ—¶é—´

```javascript
const currentTime = await time.latest();
console.log("Current timestamp:", currentTime);
console.log("Current date:", new Date(currentTime * 1000));
```

### 4.4 æŒ–çŸ¿æ¨è¿›åŒºå—

```javascript
// æŒ– 10 ä¸ªåŒºå—
await mine(10);

// æŒ–çŸ¿åŒæ—¶æ¨è¿›æ—¶é—´ï¼ˆæ¯å— 12 ç§’ï¼‰
await mine(5, { interval: 12 });
```

### 4.5 å®Œæ•´æµ‹è¯•ç¤ºä¾‹

```javascript
const { expect } = require("chai");
const { ethers } = require("hardhat");
const { time, loadFixture } = require("@nomicfoundation/hardhat-network-helpers");

describe("TimeLock", function () {
  const LOCK_DURATION = 7 * 24 * 60 * 60;  // 7 å¤©

  async function deployFixture() {
    const [owner, user] = await ethers.getSigners();
    const TimeLock = await ethers.getContractFactory("TimeLock");
    const timeLock = await TimeLock.deploy(LOCK_DURATION);
    return { timeLock, owner, user };
  }

  it("Should lock funds for correct duration", async function () {
    const { timeLock, owner } = await loadFixture(deployFixture);

    // å­˜å…¥
    await timeLock.deposit({ value: ethers.parseEther("1") });

    // é”å®šæœŸå†…ä¸èƒ½æå–
    await expect(timeLock.withdraw()).to.be.revertedWith("Still locked");

    // 6 å¤©åä»ä¸èƒ½æå–
    await time.increase(6 * 24 * 60 * 60);
    await expect(timeLock.withdraw()).to.be.revertedWith("Still locked");

    // 7 å¤©åå¯ä»¥æå–
    await time.increase(1 * 24 * 60 * 60);
    await expect(timeLock.withdraw()).to.not.be.reverted;
  });
});
```

---

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- âœ… æµ‹è¯•æ—¶é—´é”åˆçº¦
- âœ… æµ‹è¯•é”ä»“/å½’å±è®¡åˆ’
- âœ… æµ‹è¯•æŠ•ç¥¨æˆªæ­¢æ—¶é—´
- âœ… æµ‹è¯•åŒºå—å·ä¾èµ–é€»è¾‘
- âœ… éªŒè¯æ—¶é—´è¾¹ç•Œæ¡ä»¶

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šæ—¶é—´å¿«è¿› â©

#### ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼štime.increase() = ç”µå½±å¿«è¿›

æƒ³è±¡ä½ åœ¨çœ‹ä¸€éƒ¨ç”µå½±ï¼š

**æ­£å¸¸æ’­æ”¾ï¼š**
- ç”µå½±é‡Œçš„ 1 å°æ—¶ = ç°å®çš„ 1 å°æ—¶
- å¤ªæ…¢äº†ï¼ä¸æƒ³ç­‰

**å¿«è¿›åŠŸèƒ½ï¼š**
- æŒ‰ä¸‹å¿«è¿›ï¼Œç”µå½±é‡Œçš„ 1 å°æ—¶ = ç°å®çš„ 10 ç§’
- å¯ä»¥è·³åˆ°æƒ³çœ‹çš„æƒ…èŠ‚

```javascript
// ç”µå½±æ’­æ”¾"ä»£ç "
const ç”µå½± = await åŠ è½½ç”µå½±("è‚–ç”³å…‹çš„æ•‘èµ");

// æ­£å¸¸æ’­æ”¾ï¼ˆå¤ªæ…¢ï¼‰
await ç”µå½±.æ’­æ”¾();  // éœ€è¦ 2 å°æ—¶ 22 åˆ†é’Ÿ

// å¿«è¿›åˆ°å®‰è¿ªæŒ–æ´æˆåŠŸ
await ç”µå½±.å¿«è¿›åˆ°(90 * 60);  // å¿«è¿›åˆ°ç¬¬ 90 åˆ†é’Ÿ
await ç”µå½±.æ’­æ”¾();  // ä»è¿™é‡Œå¼€å§‹çœ‹
```

**å¯¹åº”å…³ç³»ï¼š**

| ç”µå½±æ¦‚å¿µ | æ—¶é—´æ¨¡æ‹Ÿæ¦‚å¿µ | è¯´æ˜ |
|---------|-------------|------|
| ç”µå½±è¿›åº¦ | block.timestamp | å½“å‰æ—¶é—´ç‚¹ |
| å¿«è¿› N åˆ†é’Ÿ | time.increase(N * 60) | å‘å‰è·³è¿‡æ—¶é—´ |
| è·³åˆ°ç‰¹å®šæ—¶é—´ç‚¹ | time.increaseTo(timestamp) | è®¾ç½®åˆ°ç‰¹å®šæ—¶é—´ |
| å½“å‰æ’­æ”¾æ—¶é—´ | time.latest() | è·å–å½“å‰æ—¶é—´ |

---

#### å‰ç«¯é¢†åŸŸç±»æ¯”ï¼štime.increase() = Jest çš„ fake timers

å¦‚æœä½ ç†Ÿæ‚‰å‰ç«¯æµ‹è¯•ï¼Œæ—¶é—´æ¨¡æ‹Ÿå°±åƒ Jest çš„ **jest.useFakeTimers()**ï¼š

```javascript
// Jest å‰ç«¯æµ‹è¯•
jest.useFakeTimers();

test("setTimeout callback", () => {
  const callback = jest.fn();
  setTimeout(callback, 10000);  // 10 ç§’åæ‰§è¡Œ

  // ä¸ç”¨çœŸçš„ç­‰ 10 ç§’
  jest.advanceTimersByTime(10000);  // å¿«è¿› 10 ç§’

  expect(callback).toHaveBeenCalled();
});

// Hardhat æ™ºèƒ½åˆçº¦æµ‹è¯•
it("Should unlock after time passes", async function () {
  await timeLock.deposit({ value: 1000 });

  // ä¸ç”¨çœŸçš„ç­‰ 7 å¤©
  await time.increase(7 * 24 * 60 * 60);  // å¿«è¿› 7 å¤©

  await timeLock.withdraw();  // ç°åœ¨å¯ä»¥æå–
});
```

**å¯¹æ¯”è¡¨ï¼š**

| æ¦‚å¿µ | Jest (å‰ç«¯) | Hardhat (æ™ºèƒ½åˆçº¦) |
|------|------------|-------------------|
| å¯ç”¨å‡æ—¶é—´ | `jest.useFakeTimers()` | é»˜è®¤å¯ç”¨ |
| å¿«è¿›æ—¶é—´ | `jest.advanceTimersByTime(ms)` | `time.increase(seconds)` |
| è·³åˆ°ç‰¹å®šæ—¶é—´ | `jest.setSystemTime(date)` | `time.increaseTo(timestamp)` |
| è·å–å½“å‰æ—¶é—´ | `Date.now()` | `time.latest()` |
| æ—¶é—´å•ä½ | æ¯«ç§’ | ç§’ |

---

### ç±»æ¯”2ï¼šæŒ–çŸ¿æ¨è¿›åŒºå— â›ï¸

#### ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼šmine() = æ—¥å†ç¿»é¡µ

æƒ³è±¡ä½ æœ‰ä¸€æœ¬æ—¥å†ï¼š

**æ­£å¸¸æƒ…å†µï¼š**
- æ¯å¤©è‡ªåŠ¨ç¿»ä¸€é¡µï¼ˆç°å®ä¸­çš„ 1 å¤©ï¼‰
- ä½ ä¸èƒ½åŠ é€Ÿæ—¥å†

**å¯æ§åˆ¶çš„æ—¥å†ï¼š**
- ä½ å¯ä»¥æ‰‹åŠ¨ç¿»é¡µ
- ç¿» 10 é¡µ = è·³è¿‡ 10 å¤©

```javascript
// æ—¥å†"ä»£ç "
const æ—¥å† = await åˆ›å»ºæ—¥å†();

// æŸ¥çœ‹å½“å‰æ—¥æœŸ
console.log(æ—¥å†.ä»Šå¤©);  // 1æœˆ1æ—¥

// ç¿»è¿‡ 10 é¡µ
await æ—¥å†.ç¿»é¡µ(10);

console.log(æ—¥å†.ä»Šå¤©);  // 1æœˆ11æ—¥
```

**å¯¹åº”å…³ç³»ï¼š**

| æ—¥å†æ¦‚å¿µ | åŒºå—é“¾æ¦‚å¿µ | è¯´æ˜ |
|---------|-----------|------|
| ä¸€é¡µæ—¥å† | ä¸€ä¸ªåŒºå— | æœ€å°æ—¶é—´å•ä½ |
| ç¿»é¡µ | mine() | æ¨è¿›åŒºå— |
| å½“å‰æ—¥æœŸ | block.number | å½“å‰åŒºå—å· |

---

#### å‰ç«¯é¢†åŸŸç±»æ¯”ï¼šmine() = æ‰‹åŠ¨è§¦å‘äº‹ä»¶å¾ªç¯

```javascript
// Node.js äº‹ä»¶å¾ªç¯
setImmediate(() => console.log("Task 1"));
setImmediate(() => console.log("Task 2"));
setImmediate(() => console.log("Task 3"));

// æ­£å¸¸æƒ…å†µï¼šè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
// æµ‹è¯•ä¸­ï¼šå¯ä»¥æ‰‹åŠ¨æ§åˆ¶æ‰§è¡Œå‡ ä¸ªä»»åŠ¡

// ç±»ä¼¼ Hardhat çš„ mine
await mine(3);  // "æ‰§è¡Œ" 3 ä¸ªåŒºå—
```

---

### ç±»æ¯”3ï¼šæ—¶é—´æˆ³ vs åŒºå—å· â±ï¸

#### ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼šä¸¤ç§çº¦å®šè§é¢çš„æ–¹å¼

**æ–¹å¼1ï¼šçº¦å®šæ—¶é—´ï¼ˆblock.timestampï¼‰**
- "ä¸‹åˆ 3 ç‚¹åœ¨å’–å•¡åº—è§é¢"
- ä¾èµ–çœŸå®æ—¶é—´

**æ–¹å¼2ï¼šçº¦å®šäº‹ä»¶ï¼ˆblock.numberï¼‰**
- "ä½ åˆ°ç¬¬ 10 ä¸ªçº¢ç»¿ç¯æ—¶è§é¢"
- ä¾èµ–äº‹ä»¶è®¡æ•°

```solidity
// æ–¹å¼1ï¼šåŸºäºæ—¶é—´
contract TimeBasedLock {
    uint256 public unlockTime;

    function canWithdraw() public view returns (bool) {
        return block.timestamp >= unlockTime;
    }
}

// æ–¹å¼2ï¼šåŸºäºåŒºå—å·
contract BlockBasedLock {
    uint256 public unlockBlock;

    function canWithdraw() public view returns (bool) {
        return block.number >= unlockBlock;
    }
}
```

**æµ‹è¯•æ–¹å¼å¯¹æ¯”ï¼š**

```javascript
// æµ‹è¯•æ—¶é—´é”
await time.increase(3600);  // å¿«è¿› 1 å°æ—¶

// æµ‹è¯•åŒºå—é”
await mine(100);  // å¿«è¿› 100 ä¸ªåŒºå—
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| æ—¶é—´æ¨¡æ‹Ÿæ¦‚å¿µ | ç”Ÿæ´»åœºæ™¯ç±»æ¯” | å‰ç«¯é¢†åŸŸç±»æ¯” | æ ¸å¿ƒç›¸ä¼¼æ€§ |
|-------------|-------------|-------------|-----------|
| **time.increase()** | ç”µå½±å¿«è¿› | jest.advanceTimersByTime() | è·³è¿‡æŒ‡å®šæ—¶é•¿ |
| **time.increaseTo()** | è·³åˆ°ç”µå½±ç‰¹å®šæ—¶é—´ç‚¹ | jest.setSystemTime() | è®¾ç½®åˆ°ç²¾ç¡®æ—¶é—´ |
| **time.latest()** | å½“å‰æ’­æ”¾è¿›åº¦ | Date.now() | è·å–å½“å‰æ—¶é—´ |
| **mine()** | æ—¥å†ç¿»é¡µ | æ‰‹åŠ¨æ¨è¿›äº‹ä»¶å¾ªç¯ | æ¨è¿›åŒºå— |
| **block.timestamp** | çº¦å®šæ—¶é—´ | ç³»ç»Ÿæ—¶é—´ | ç»å¯¹æ—¶é—´ |
| **block.number** | çº¦å®šç¬¬å‡ ä¸ªçº¢ç»¿ç¯ | äº‹ä»¶è®¡æ•° | ç›¸å¯¹è®¡æ•° |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼štime.increase() ä¸ä¼šè‡ªåŠ¨æŒ–çŸ¿ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

è¿™ä¸ªè¯¯åŒºæ›¾ç»æ˜¯æ­£ç¡®çš„ï¼ˆåœ¨æ—§ç‰ˆ Hardhat ä¸­ï¼‰ï¼Œä½†ç°åœ¨çš„ `hardhat-network-helpers` ä¼š**è‡ªåŠ¨æŒ–çŸ¿**ã€‚

```javascript
// æ—§ç‰ˆ Hardhatï¼ˆä¸æ¨èï¼‰
await network.provider.send("evm_increaseTime", [3600]);
await network.provider.send("evm_mine");  // éœ€è¦æ‰‹åŠ¨æŒ–çŸ¿

// æ–°ç‰ˆ hardhat-network-helpersï¼ˆæ¨èï¼‰
await time.increase(3600);  // è‡ªåŠ¨åŒ…å«æŒ–çŸ¿
// ä¸éœ€è¦å•ç‹¬è°ƒç”¨ mine()
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å¾ˆå¤šæ—§æ•™ç¨‹ä½¿ç”¨åº•å±‚ RPC è°ƒç”¨ï¼Œéœ€è¦æ‰‹åŠ¨æŒ–çŸ¿ã€‚æ–°ç‰ˆå·¥å…·å·²ç»å°è£…å¥½äº†ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
const { time } = require("@nomicfoundation/hardhat-network-helpers");

// ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€é¢å¤–æ“ä½œ
await time.increase(ONE_DAY);
// block.timestamp å·²ç»å¢åŠ äº† ONE_DAY
// å·²ç»æœ‰ä¸€ä¸ªæ–°åŒºå—äº†
```

---

### è¯¯åŒº2ï¼šblock.timestamp ç²¾ç¡®åˆ°æ¯«ç§’ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

```javascript
// âŒ é”™è¯¯ç†è§£
const now = Date.now();  // æ¯«ç§’çº§æ—¶é—´æˆ³ï¼ˆå¦‚ 1699123456789ï¼‰
await time.increaseTo(now);  // è¿™ä¸ªå€¼å¤ªå¤§äº†ï¼

// å®é™…ä¸Š block.timestamp æ˜¯ç§’çº§çš„
const blockTime = await time.latest();  // å¦‚ 1699123456ï¼ˆç§’ï¼‰
```

Solidity çš„ `block.timestamp` æ˜¯ **Unix æ—¶é—´æˆ³ï¼ˆç§’ï¼‰**ï¼Œä¸æ˜¯æ¯«ç§’ã€‚

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

JavaScript çš„ `Date.now()` è¿”å›æ¯«ç§’ï¼Œå®¹æ˜“æ··æ·†å•ä½ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// JavaScript æ¯«ç§’ â†’ Solidity ç§’
const nowMs = Date.now();                    // 1699123456789ï¼ˆæ¯«ç§’ï¼‰
const nowSeconds = Math.floor(nowMs / 1000); // 1699123456ï¼ˆç§’ï¼‰

// è®¾ç½®æ—¶é—´æ—¶ä½¿ç”¨ç§’
await time.increaseTo(nowSeconds + 3600);

// æˆ–è€…ä½¿ç”¨ time.latest() è·å–å½“å‰åŒºå—æ—¶é—´ï¼ˆç§’ï¼‰
const currentBlockTime = await time.latest();
await time.increaseTo(currentBlockTime + 3600);
```

---

### è¯¯åŒº3ï¼šæ—¶é—´å¯ä»¥å€’æµ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

```javascript
// âŒ é”™è¯¯ï¼šä¸èƒ½è®¾ç½®åˆ°è¿‡å»
const now = await time.latest();
await time.increase(3600);  // å‰è¿› 1 å°æ—¶
await time.increaseTo(now);  // å°è¯•å›åˆ°è¿‡å» â†’ æŠ¥é”™ï¼
```

Hardhat Network ä¸å…è®¸å°†æ—¶é—´è®¾ç½®åˆ°è¿‡å»ï¼ˆç¬¦åˆåŒºå—é“¾çš„ä¸å¯é€†ç‰¹æ€§ï¼‰ã€‚

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

åœ¨å…¶ä»–æ¨¡æ‹Ÿç¯å¢ƒä¸­ï¼ˆå¦‚æ¸¸æˆï¼‰ï¼Œæ—¶é—´å¯ä»¥éšæ„è°ƒæ•´ã€‚ä½†åŒºå—é“¾æ˜¯å•å‘çš„ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// ä½¿ç”¨ loadFixture é‡ç½®æ•´ä¸ªçŠ¶æ€ï¼ˆåŒ…æ‹¬æ—¶é—´ï¼‰
describe("Time Tests", function () {
  async function deployFixture() {
    // æ¯æ¬¡è°ƒç”¨éƒ½ä¼šé‡ç½®åˆ°è¿™ä¸ªçŠ¶æ€
    const token = await Token.deploy();
    return { token };
  }

  it("Test 1", async function () {
    const { token } = await loadFixture(deployFixture);
    await time.increase(ONE_DAY);
    // æ—¶é—´å‰è¿›äº† 1 å¤©
  });

  it("Test 2", async function () {
    const { token } = await loadFixture(deployFixture);
    // æ—¶é—´é‡ç½®åˆ° fixture æ—¶çš„çŠ¶æ€ï¼ˆä¸æ˜¯ Test 1 ç»“æŸæ—¶ï¼‰
    await time.increase(ONE_HOUR);
  });
});
```

---

## 7. ã€å®æˆ˜ä»£ç ã€‘

### åŸºç¡€å®ç°ï¼šæ—¶é—´é”åˆçº¦æµ‹è¯•

```solidity
// contracts/TimeLock.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

contract TimeLock {
    mapping(address => uint256) public balances;
    mapping(address => uint256) public unlockTime;

    uint256 public immutable lockDuration;

    event Deposited(address indexed user, uint256 amount, uint256 unlockTime);
    event Withdrawn(address indexed user, uint256 amount);

    error StillLocked(uint256 currentTime, uint256 unlockTime);
    error NoBalance();

    constructor(uint256 _lockDuration) {
        lockDuration = _lockDuration;
    }

    function deposit() external payable {
        require(msg.value > 0, "Must deposit something");

        balances[msg.sender] += msg.value;
        unlockTime[msg.sender] = block.timestamp + lockDuration;

        emit Deposited(msg.sender, msg.value, unlockTime[msg.sender]);
    }

    function withdraw() external {
        if (balances[msg.sender] == 0) revert NoBalance();
        if (block.timestamp < unlockTime[msg.sender]) {
            revert StillLocked(block.timestamp, unlockTime[msg.sender]);
        }

        uint256 amount = balances[msg.sender];
        balances[msg.sender] = 0;

        (bool success, ) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");

        emit Withdrawn(msg.sender, amount);
    }

    function timeUntilUnlock(address user) external view returns (uint256) {
        if (block.timestamp >= unlockTime[user]) return 0;
        return unlockTime[user] - block.timestamp;
    }
}
```

```javascript
// test/TimeLock.test.js
const { expect } = require("chai");
const { ethers } = require("hardhat");
const { time, loadFixture } = require("@nomicfoundation/hardhat-network-helpers");

describe("TimeLock", function () {
  // å¸¸é‡
  const ONE_DAY = 24 * 60 * 60;
  const LOCK_DURATION = 7 * ONE_DAY;  // 7 å¤©é”å®šæœŸ
  const DEPOSIT_AMOUNT = ethers.parseEther("1");

  // Fixture
  async function deployFixture() {
    const [owner, user1, user2] = await ethers.getSigners();
    const TimeLock = await ethers.getContractFactory("TimeLock");
    const timeLock = await TimeLock.deploy(LOCK_DURATION);
    return { timeLock, owner, user1, user2 };
  }

  // å¸¦å­˜æ¬¾çš„ Fixture
  async function deployWithDepositFixture() {
    const { timeLock, owner, user1, user2 } = await deployFixture();
    await timeLock.connect(user1).deposit({ value: DEPOSIT_AMOUNT });
    return { timeLock, owner, user1, user2 };
  }

  // ===== éƒ¨ç½²æµ‹è¯• =====
  describe("Deployment", function () {
    it("Should set the correct lock duration", async function () {
      const { timeLock } = await loadFixture(deployFixture);
      expect(await timeLock.lockDuration()).to.equal(LOCK_DURATION);
    });
  });

  // ===== å­˜æ¬¾æµ‹è¯• =====
  describe("Deposit", function () {
    it("Should accept deposits", async function () {
      const { timeLock, user1 } = await loadFixture(deployFixture);

      await timeLock.connect(user1).deposit({ value: DEPOSIT_AMOUNT });

      expect(await timeLock.balances(user1.address)).to.equal(DEPOSIT_AMOUNT);
    });

    it("Should set correct unlock time", async function () {
      const { timeLock, user1 } = await loadFixture(deployFixture);

      const depositTime = await time.latest();
      await timeLock.connect(user1).deposit({ value: DEPOSIT_AMOUNT });

      const expectedUnlockTime = depositTime + LOCK_DURATION + 1; // +1 for mining
      const actualUnlockTime = await timeLock.unlockTime(user1.address);

      // å…è®¸ 1 ç§’è¯¯å·®
      expect(actualUnlockTime).to.be.closeTo(expectedUnlockTime, 1);
    });

    it("Should emit Deposited event", async function () {
      const { timeLock, user1 } = await loadFixture(deployFixture);

      await expect(timeLock.connect(user1).deposit({ value: DEPOSIT_AMOUNT }))
        .to.emit(timeLock, "Deposited");
    });
  });

  // ===== ææ¬¾æµ‹è¯•ï¼ˆæ ¸å¿ƒï¼šæ—¶é—´æ¨¡æ‹Ÿï¼‰ =====
  describe("Withdraw", function () {
    it("Should revert if still locked", async function () {
      const { timeLock, user1 } = await loadFixture(deployWithDepositFixture);

      // ç«‹å³ææ¬¾åº”è¯¥å¤±è´¥
      await expect(timeLock.connect(user1).withdraw())
        .to.be.revertedWithCustomError(timeLock, "StillLocked");
    });

    it("Should revert if locked period not passed", async function () {
      const { timeLock, user1 } = await loadFixture(deployWithDepositFixture);

      // è¿‡äº† 6 å¤©ï¼ˆä½†é”å®šæœŸæ˜¯ 7 å¤©ï¼‰
      await time.increase(6 * ONE_DAY);

      await expect(timeLock.connect(user1).withdraw())
        .to.be.revertedWithCustomError(timeLock, "StillLocked");
    });

    it("Should allow withdrawal after lock period", async function () {
      const { timeLock, user1 } = await loadFixture(deployWithDepositFixture);

      // è¿‡äº† 7 å¤©
      await time.increase(LOCK_DURATION);

      // ç°åœ¨å¯ä»¥ææ¬¾
      await expect(timeLock.connect(user1).withdraw())
        .to.emit(timeLock, "Withdrawn")
        .withArgs(user1.address, DEPOSIT_AMOUNT);
    });

    it("Should transfer correct amount on withdrawal", async function () {
      const { timeLock, user1 } = await loadFixture(deployWithDepositFixture);

      await time.increase(LOCK_DURATION);

      // éªŒè¯ ETH ä½™é¢å˜åŒ–
      await expect(timeLock.connect(user1).withdraw())
        .to.changeEtherBalance(user1, DEPOSIT_AMOUNT);
    });

    it("Should reset balance after withdrawal", async function () {
      const { timeLock, user1 } = await loadFixture(deployWithDepositFixture);

      await time.increase(LOCK_DURATION);
      await timeLock.connect(user1).withdraw();

      expect(await timeLock.balances(user1.address)).to.equal(0);
    });

    it("Should revert on double withdrawal", async function () {
      const { timeLock, user1 } = await loadFixture(deployWithDepositFixture);

      await time.increase(LOCK_DURATION);
      await timeLock.connect(user1).withdraw();

      await expect(timeLock.connect(user1).withdraw())
        .to.be.revertedWithCustomError(timeLock, "NoBalance");
    });
  });

  // ===== è¾¹ç•Œæ¡ä»¶æµ‹è¯• =====
  describe("Boundary Conditions", function () {
    it("Should not allow withdrawal 1 second before unlock", async function () {
      const { timeLock, user1 } = await loadFixture(deployWithDepositFixture);

      // è·ç¦»è§£é”è¿˜å·® 1 ç§’
      await time.increase(LOCK_DURATION - 1);

      await expect(timeLock.connect(user1).withdraw())
        .to.be.revertedWithCustomError(timeLock, "StillLocked");
    });

    it("Should allow withdrawal exactly at unlock time", async function () {
      const { timeLock, user1 } = await loadFixture(deployWithDepositFixture);

      const unlockTime = await timeLock.unlockTime(user1.address);
      await time.increaseTo(unlockTime);

      await expect(timeLock.connect(user1).withdraw()).to.not.be.reverted;
    });

    it("Should allow withdrawal long after unlock time", async function () {
      const { timeLock, user1 } = await loadFixture(deployWithDepositFixture);

      // è¿‡äº† 1 å¹´
      await time.increase(365 * ONE_DAY);

      await expect(timeLock.connect(user1).withdraw()).to.not.be.reverted;
    });
  });

  // ===== timeUntilUnlock æµ‹è¯• =====
  describe("timeUntilUnlock", function () {
    it("Should return correct remaining time", async function () {
      const { timeLock, user1 } = await loadFixture(deployWithDepositFixture);

      // è¿‡äº† 3 å¤©
      await time.increase(3 * ONE_DAY);

      const remaining = await timeLock.timeUntilUnlock(user1.address);
      // å‰©ä½™ 4 å¤©ï¼ˆå…è®¸ 1 ç§’è¯¯å·®ï¼‰
      expect(remaining).to.be.closeTo(4n * BigInt(ONE_DAY), 1n);
    });

    it("Should return 0 after unlock time", async function () {
      const { timeLock, user1 } = await loadFixture(deployWithDepositFixture);

      await time.increase(LOCK_DURATION + ONE_DAY);

      expect(await timeLock.timeUntilUnlock(user1.address)).to.equal(0);
    });
  });

  // ===== å¤šç”¨æˆ·åœºæ™¯ =====
  describe("Multiple Users", function () {
    it("Should handle different unlock times for different users", async function () {
      const { timeLock, user1, user2 } = await loadFixture(deployFixture);

      // user1 å­˜æ¬¾
      await timeLock.connect(user1).deposit({ value: DEPOSIT_AMOUNT });

      // 2 å¤©å user2 å­˜æ¬¾
      await time.increase(2 * ONE_DAY);
      await timeLock.connect(user2).deposit({ value: DEPOSIT_AMOUNT });

      // 5 å¤©åï¼ˆuser1 å­˜æ¬¾å 7 å¤©ï¼Œuser2 å­˜æ¬¾å 5 å¤©ï¼‰
      await time.increase(5 * ONE_DAY);

      // user1 å¯ä»¥ææ¬¾
      await expect(timeLock.connect(user1).withdraw()).to.not.be.reverted;

      // user2 è¿˜ä¸èƒ½ææ¬¾ï¼ˆè¿˜å·® 2 å¤©ï¼‰
      await expect(timeLock.connect(user2).withdraw())
        .to.be.revertedWithCustomError(timeLock, "StillLocked");

      // å†è¿‡ 2 å¤©ï¼Œuser2 å¯ä»¥ææ¬¾
      await time.increase(2 * ONE_DAY);
      await expect(timeLock.connect(user2).withdraw()).to.not.be.reverted;
    });
  });
});
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**

```
$ npx hardhat test test/TimeLock.test.js

  TimeLock
    Deployment
      âœ” Should set the correct lock duration
    Deposit
      âœ” Should accept deposits
      âœ” Should set correct unlock time
      âœ” Should emit Deposited event
    Withdraw
      âœ” Should revert if still locked
      âœ” Should revert if locked period not passed
      âœ” Should allow withdrawal after lock period
      âœ” Should transfer correct amount on withdrawal
      âœ” Should reset balance after withdrawal
      âœ” Should revert on double withdrawal
    Boundary Conditions
      âœ” Should not allow withdrawal 1 second before unlock
      âœ” Should allow withdrawal exactly at unlock time
      âœ” Should allow withdrawal long after unlock time
    timeUntilUnlock
      âœ” Should return correct remaining time
      âœ” Should return 0 after unlock time
    Multiple Users
      âœ” Should handle different unlock times for different users

  16 passing (2s)
```

---

### è¿›é˜¶ï¼šVestingï¼ˆä»£å¸å½’å±ï¼‰åˆçº¦æµ‹è¯•

```javascript
// test/Vesting.test.js
describe("Vesting", function () {
  const TOTAL_AMOUNT = ethers.parseEther("1000000");  // 100ä¸‡ä»£å¸
  const VESTING_DURATION = 365 * 24 * 60 * 60;  // 1 å¹´
  const CLIFF = 90 * 24 * 60 * 60;  // 3 ä¸ªæœˆæ‚¬å´–æœŸ

  it("Should vest tokens linearly after cliff", async function () {
    const { vesting, token, beneficiary } = await loadFixture(deployVestingFixture);

    // æ‚¬å´–æœŸå†…ï¼šä¸èƒ½é¢†å–
    await time.increase(CLIFF - 1);
    expect(await vesting.claimable(beneficiary.address)).to.equal(0);

    // æ‚¬å´–æœŸåˆšè¿‡ï¼šå¯ä»¥é¢†å– 3/12 = 25%
    await time.increase(1);
    const afterCliff = await vesting.claimable(beneficiary.address);
    expect(afterCliff).to.be.closeTo(TOTAL_AMOUNT / 4n, ethers.parseEther("1000"));

    // 6 ä¸ªæœˆåï¼šå¯ä»¥é¢†å– 50%
    await time.increase(3 * 30 * 24 * 60 * 60);
    const halfYear = await vesting.claimable(beneficiary.address);
    expect(halfYear).to.be.closeTo(TOTAL_AMOUNT / 2n, ethers.parseEther("1000"));

    // 1 å¹´åï¼šå¯ä»¥é¢†å– 100%
    await time.increase(6 * 30 * 24 * 60 * 60);
    const fullYear = await vesting.claimable(beneficiary.address);
    expect(fullYear).to.be.closeTo(TOTAL_AMOUNT, ethers.parseEther("1000"));
  });
});
```

---

## 8. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"å¦‚ä½•æµ‹è¯•ä¸€ä¸ªéœ€è¦ç­‰å¾… 30 å¤©çš„æ—¶é—´é”åˆçº¦ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"ç”¨ time.increase å¿«è¿› 30 å¤©ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **æµ‹è¯•æ—¶é—´é”åˆçº¦éœ€è¦ä»ä¸‰ä¸ªå±‚é¢è€ƒè™‘ï¼š**
>
> **1. åŸºç¡€æ—¶é—´æ“ä½œ**ï¼š
> ```javascript
> const { time } = require("@nomicfoundation/hardhat-network-helpers");
> const THIRTY_DAYS = 30 * 24 * 60 * 60;
>
> // å¿«è¿› 30 å¤©
> await time.increase(THIRTY_DAYS);
> // ç°åœ¨ block.timestamp å·²ç»å¢åŠ äº† 30 å¤©
> ```
>
> **2. è¾¹ç•Œæ¡ä»¶æµ‹è¯•**ï¼š
> ```javascript
> // 29 å¤© 23 å°æ—¶ 59 åˆ† 59 ç§’ï¼šä»ç„¶é”å®š
> await time.increase(THIRTY_DAYS - 1);
> await expect(timeLock.withdraw()).to.be.revertedWith("Still locked");
>
> // æ°å¥½ 30 å¤©ï¼šå¯ä»¥è§£é”
> await time.increase(1);
> await timeLock.withdraw();
> ```
>
> **3. å¤šç”¨æˆ·ä¸åŒè§£é”æ—¶é—´**ï¼š
> ```javascript
> // user1 åœ¨ T æ—¶åˆ»å­˜æ¬¾
> await timeLock.connect(user1).deposit(100);
>
> // user2 åœ¨ T+10å¤© å­˜æ¬¾
> await time.increase(10 * ONE_DAY);
> await timeLock.connect(user2).deposit(100);
>
> // T+30å¤©ï¼šuser1 å¯ä»¥è§£é”ï¼Œuser2 è¿˜éœ€ç­‰ 10 å¤©
> await time.increase(20 * ONE_DAY);
> await timeLock.connect(user1).withdraw();  // âœ…
> await expect(timeLock.connect(user2).withdraw()).to.be.reverted;  // âŒ
> ```
>
> **æœ€ä½³å®è·µ**ï¼š
> - ä½¿ç”¨å¸¸é‡å®šä¹‰æ—¶é—´ï¼ˆ`ONE_DAY = 86400`ï¼‰
> - æµ‹è¯•è¾¹ç•Œæ¡ä»¶ï¼ˆæ°å¥½è§£é”å‰åï¼‰
> - ä½¿ç”¨ loadFixture ç¡®ä¿æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… åˆ†å±‚æ¬¡å›ç­”ï¼ˆåŸºç¡€ã€è¾¹ç•Œã€å¤šç”¨æˆ·ï¼‰
2. âœ… ç»™å‡ºäº†å®Œæ•´ä»£ç ç¤ºä¾‹
3. âœ… å¼ºè°ƒäº†è¾¹ç•Œæ¡ä»¶æµ‹è¯•
4. âœ… æåˆ°äº†æœ€ä½³å®è·µ

---

### é—®é¢˜2ï¼š"block.timestamp å’Œ block.number æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨å“ªä¸ªï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"timestamp æ˜¯æ—¶é—´ï¼Œnumber æ˜¯åŒºå—å·ã€‚ä¸€èˆ¬ç”¨ timestampã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **ä¸¤è€…æ˜¯åŒºå—é“¾ä¸­åº¦é‡"æ—¶é—´"çš„ä¸¤ç§æ–¹å¼ï¼š**
>
> **1. block.timestampï¼ˆUnix æ—¶é—´æˆ³ï¼‰**ï¼š
> - ç²¾ç¡®çš„ç§’çº§æ—¶é—´
> - å¯è¢«çŸ¿å·¥/éªŒè¯è€…å°å¹…æ“æ§ï¼ˆÂ±15ç§’ï¼‰
> - é€‚ç”¨äºï¼šäººç±»å¯è¯»çš„æ—¶é—´ï¼ˆ30å¤©é”å®šã€æœˆåº¦å½’å±ï¼‰
>
> **2. block.numberï¼ˆåŒºå—é«˜åº¦ï¼‰**ï¼š
> - åŒºå—çš„åºåˆ—å·
> - å®Œå…¨ç¡®å®šæ€§ï¼Œä¸èƒ½è¢«æ“æ§
> - é€‚ç”¨äºï¼šéœ€è¦ç²¾ç¡®çš„åŒºå—é—´éš”ï¼ˆæŠ•ç¥¨æŒç»­ 1000 åŒºå—ï¼‰
>
> **é€‰æ‹©å»ºè®®**ï¼š
> ```javascript
> // é€‚åˆ timestampï¼šäººç±»æ—¶é—´æ¦‚å¿µ
> require(block.timestamp >= unlockDate, "Not yet");  // è§£é”æ—¥æœŸ
> uint256 interest = (block.timestamp - startTime) * rate;  // åˆ©æ¯è®¡ç®—
>
> // é€‚åˆ block.numberï¼šç²¾ç¡®åŒºå—æ•°
> require(block.number <= proposalEndBlock, "Voting ended");  // æŠ•ç¥¨æˆªæ­¢
> uint256 confirmations = block.number - depositBlock;  // ç¡®è®¤æ•°
> ```
>
> **æµ‹è¯•å·®å¼‚**ï¼š
> ```javascript
> // æ“ä½œ timestamp
> await time.increase(86400);  // å¿«è¿› 1 å¤©
>
> // æ“ä½œ block.number
> await mine(100);  // æŒ– 100 ä¸ªåŒºå—
>
> // åŒæ—¶æ“ä½œï¼ˆæ¯å— 12 ç§’ï¼‰
> await mine(100, { interval: 12 });
> ```
>
> **å®‰å…¨è€ƒè™‘**ï¼š
> - timestamp å¯è¢«æ“æ§ï¼Œä¸è¦ç”¨äºç²¾ç¡®çš„èµ„é‡‘è®¡ç®—
> - æ—¶é—´çª—å£çŸ­äº 15 ç§’çš„é€»è¾‘ä¸å¯é 

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… æ¸…æ™°å¯¹æ¯”ä¸¤è€…ç‰¹ç‚¹
2. âœ… ç»™å‡ºäº†å…·ä½“ä½¿ç”¨åœºæ™¯
3. âœ… åŒ…å«äº†æµ‹è¯•æ“ä½œå·®å¼‚
4. âœ… æåˆ°äº†å®‰å…¨è€ƒè™‘

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šä¸ºä»€ä¹ˆéœ€è¦æ—¶é—´æ¨¡æ‹Ÿï¼Ÿ ğŸ¯

**ä¸€å¥è¯ï¼š** æ™ºèƒ½åˆçº¦ä¾èµ– block.timestampï¼ŒçœŸå®ç­‰å¾…ä¸å¯è¡Œï¼Œéœ€è¦åœ¨æµ‹è¯•ä¸­"å¿«è¿›"æ—¶é—´ã€‚

**ä¸¾ä¾‹ï¼š**
- æ—¶é—´é”ï¼šç­‰å¾… 30 å¤© â†’ æµ‹è¯•ä¸­å¿«è¿› 30 å¤©
- åˆ©æ¯è®¡ç®—ï¼š1 å¹´åˆ©æ¯ â†’ æµ‹è¯•ä¸­å¿«è¿› 1 å¹´
- æŠ•ç¥¨æˆªæ­¢ï¼š24 å°æ—¶å â†’ æµ‹è¯•ä¸­å¿«è¿› 24 å°æ—¶

**åº”ç”¨ï¼š** æ‰€æœ‰æ—¶é—´ä¾èµ–çš„åˆçº¦é€»è¾‘éƒ½éœ€è¦æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•ã€‚

---

### å¡ç‰‡2ï¼štime.increase() å¢åŠ æ—¶é—´ â©

**ä¸€å¥è¯ï¼š** `time.increase(seconds)` å°†åŒºå—é“¾æ—¶é—´å‘å‰æ¨è¿›æŒ‡å®šç§’æ•°ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
const ONE_DAY = 24 * 60 * 60;
await time.increase(ONE_DAY);     // å¿«è¿› 1 å¤©
await time.increase(7 * ONE_DAY); // å¿«è¿› 1 å‘¨
```

**åº”ç”¨ï¼š** æµ‹è¯•"ç­‰å¾… N å¤©å"çš„åœºæ™¯ã€‚

---

### å¡ç‰‡3ï¼štime.increaseTo() è®¾ç½®åˆ°ç‰¹å®šæ—¶é—´ ğŸ“…

**ä¸€å¥è¯ï¼š** `time.increaseTo(timestamp)` å°†æ—¶é—´è®¾ç½®åˆ°ç‰¹å®šçš„ Unix æ—¶é—´æˆ³ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
const deadline = (await time.latest()) + 3600;
await time.increaseTo(deadline);      // è·³åˆ°æˆªæ­¢æ—¶é—´
await time.increaseTo(deadline + 1);  // è·³åˆ°æˆªæ­¢æ—¶é—´å 1 ç§’
```

**åº”ç”¨ï¼š** æµ‹è¯•è¾¹ç•Œæ¡ä»¶ï¼ˆæ°å¥½åœ¨æˆªæ­¢æ—¶é—´å‰åï¼‰ã€‚

---

### å¡ç‰‡4ï¼štime.latest() è·å–å½“å‰æ—¶é—´ â±ï¸

**ä¸€å¥è¯ï¼š** `time.latest()` è¿”å›å½“å‰åŒºå—çš„ Unix æ—¶é—´æˆ³ï¼ˆç§’ï¼‰ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
const now = await time.latest();
console.log("Current time:", new Date(now * 1000));
// æ³¨æ„ï¼šè¿”å›çš„æ˜¯ç§’ï¼ŒJavaScript ç”¨æ¯«ç§’
```

**åº”ç”¨ï¼š** è·å–å½“å‰æ—¶é—´ç”¨äºè®¡ç®—ç›®æ ‡æ—¶é—´ã€‚

---

### å¡ç‰‡5ï¼šmine() æŒ–çŸ¿æ¨è¿›åŒºå— â›ï¸

**ä¸€å¥è¯ï¼š** `mine(blocks)` æŒ–æŒ‡å®šæ•°é‡çš„åŒºå—ï¼Œæ¨è¿› block.numberã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
await mine(10);                    // æŒ– 10 ä¸ªåŒºå—
await mine(5, { interval: 12 });   // æŒ– 5 å—ï¼Œæ¯å—é—´éš” 12 ç§’
```

**åº”ç”¨ï¼š** æµ‹è¯•ä¾èµ–åŒºå—å·ï¼ˆè€Œéæ—¶é—´æˆ³ï¼‰çš„é€»è¾‘ã€‚

---

### å¡ç‰‡6ï¼šæ—¶é—´å•ä½å¸¸é‡ ğŸ“

**ä¸€å¥è¯ï¼š** å®šä¹‰æ—¶é—´å¸¸é‡æé«˜å¯è¯»æ€§å’Œé¿å…è®¡ç®—é”™è¯¯ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
const ONE_MINUTE = 60;
const ONE_HOUR = 60 * 60;
const ONE_DAY = 24 * 60 * 60;
const ONE_WEEK = 7 * ONE_DAY;
const ONE_MONTH = 30 * ONE_DAY;
const ONE_YEAR = 365 * ONE_DAY;
```

**åº”ç”¨ï¼š** åœ¨æ‰€æœ‰æµ‹è¯•ä¸­ç»Ÿä¸€ä½¿ç”¨è¿™äº›å¸¸é‡ã€‚

---

### å¡ç‰‡7ï¼šè¾¹ç•Œæ¡ä»¶æµ‹è¯• ğŸ¯

**ä¸€å¥è¯ï¼š** æµ‹è¯•"æ°å¥½åœ¨æ—¶é—´ç‚¹å‰å"çš„ä¸åŒè¡Œä¸ºã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// æ°å¥½è§£é”å‰ 1 ç§’
await time.increaseTo(unlockTime - 1);
await expect(withdraw()).to.be.reverted;

// æ°å¥½è§£é”æ—¶é—´
await time.increaseTo(unlockTime);
await withdraw();  // æˆåŠŸ
```

**åº”ç”¨ï¼š** ç¡®ä¿æ—¶é—´åˆ¤æ–­é€»è¾‘æ­£ç¡®ï¼ˆ< vs <=ï¼‰ã€‚

---

### å¡ç‰‡8ï¼šæ—¶é—´æˆ³æ˜¯ç§’ä¸æ˜¯æ¯«ç§’ âš ï¸

**ä¸€å¥è¯ï¼š** Solidity çš„ block.timestamp æ˜¯ç§’çº§ï¼ŒJavaScript çš„ Date.now() æ˜¯æ¯«ç§’çº§ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// âŒ é”™è¯¯
await time.increaseTo(Date.now());  // æ¯«ç§’å€¼å¤ªå¤§

// âœ… æ­£ç¡®
await time.increaseTo(Math.floor(Date.now() / 1000));
// æˆ–è€…
await time.increaseTo((await time.latest()) + 3600);
```

**åº”ç”¨ï¼š** è½¬æ¢æ—¶æ³¨æ„å•ä½ï¼Œæ¨èä½¿ç”¨ time.latest()ã€‚

---

### å¡ç‰‡9ï¼šæ—¶é—´ä¸èƒ½å€’æµ ğŸ”™

**ä¸€å¥è¯ï¼š** Hardhat Network ä¸å…è®¸å°†æ—¶é—´è®¾ç½®åˆ°è¿‡å»ï¼Œä½¿ç”¨ loadFixture é‡ç½®ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// âŒ ä¼šæŠ¥é”™
await time.increase(ONE_DAY);
await time.increaseTo(originalTime);  // Error!

// âœ… ä½¿ç”¨ loadFixture é‡ç½®çŠ¶æ€
const { token } = await loadFixture(deployFixture);
// ç°åœ¨æ—¶é—´å›åˆ° fixture åˆ›å»ºæ—¶
```

**åº”ç”¨ï¼š** ç”¨ loadFixture éš”ç¦»æ¯ä¸ªæµ‹è¯•çš„æ—¶é—´çŠ¶æ€ã€‚

---

### å¡ç‰‡10ï¼šæ—¶é—´ + ç­¾åè€…ç»„åˆæµ‹è¯• ğŸ§©

**ä¸€å¥è¯ï¼š** å¤æ‚åœºæ™¯éœ€è¦åŒæ—¶æ¨¡æ‹Ÿå¤šç”¨æˆ·å’Œæ—¶é—´æµé€ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
const [owner, user1, user2] = await ethers.getSigners();

// user1 åœ¨ T æ—¶åˆ»å­˜æ¬¾
await timeLock.connect(user1).deposit(100);

// user2 åœ¨ T+10å¤©å­˜æ¬¾
await time.increase(10 * ONE_DAY);
await timeLock.connect(user2).deposit(100);

// T+30å¤©ï¼šæµ‹è¯•ä¸åŒç”¨æˆ·çš„è§£é”çŠ¶æ€
await time.increase(20 * ONE_DAY);
// user1 å¯è§£é”ï¼ˆ30å¤©ï¼‰
// user2 ä¸å¯è§£é”ï¼ˆåªè¿‡äº†20å¤©ï¼‰
```

**åº”ç”¨ï¼š** æµ‹è¯•å¤šç”¨æˆ·ä¸åŒæ—¶é—´ç‚¹åŠ å…¥çš„åœºæ™¯ã€‚

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**ä½¿ç”¨ `@nomicfoundation/hardhat-network-helpers` çš„ `time.increase()` å’Œ `time.increaseTo()` å¯ä»¥åœ¨æµ‹è¯•ä¸­ç²¾ç¡®æ§åˆ¶ block.timestampï¼Œé…åˆ `mine()` æ§åˆ¶ block.numberï¼Œä»è€Œå®Œæ•´æµ‹è¯•æ—¶é—´é”ã€å½’å±è®¡åˆ’ã€æŠ•ç¥¨æˆªæ­¢ç­‰æ—¶é—´ä¾èµ–çš„æ™ºèƒ½åˆçº¦é€»è¾‘ã€‚**

---

## ğŸ“š é™„å½•

### å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬çŸ¥è¯†ç‚¹å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ä½¿ç”¨ `time.increase()` å¿«è¿›æ—¶é—´
- [ ] ä½¿ç”¨ `time.increaseTo()` è®¾ç½®åˆ°ç‰¹å®šæ—¶é—´
- [ ] ä½¿ç”¨ `time.latest()` è·å–å½“å‰æ—¶é—´
- [ ] ä½¿ç”¨ `mine()` æ¨è¿›åŒºå—å·
- [ ] å®šä¹‰å’Œä½¿ç”¨æ—¶é—´å¸¸é‡
- [ ] æµ‹è¯•æ—¶é—´è¾¹ç•Œæ¡ä»¶
- [ ] ç»„åˆæ—¶é—´æ¨¡æ‹Ÿå’Œå¤šç­¾åè€…æµ‹è¯•

### å¿«é€Ÿå‚è€ƒå¡

**å¯¼å…¥ï¼š**

```javascript
const { time, mine, loadFixture } = require("@nomicfoundation/hardhat-network-helpers");
```

**å¸¸ç”¨æ“ä½œï¼š**

```javascript
// æ—¶é—´å¸¸é‡
const ONE_DAY = 24 * 60 * 60;

// å¢åŠ æ—¶é—´
await time.increase(ONE_DAY);

// è®¾ç½®åˆ°ç‰¹å®šæ—¶é—´
const target = (await time.latest()) + ONE_DAY;
await time.increaseTo(target);

// è·å–å½“å‰æ—¶é—´
const now = await time.latest();

// æŒ–çŸ¿
await mine(10);
await mine(5, { interval: 12 });
```

### ä¸‹ä¸€æ­¥å­¦ä¹ 

æ¨èæŒ‰ä»¥ä¸‹é¡ºåºç»§ç»­å­¦ä¹ ï¼š

1. **Fork ä¸»ç½‘æµ‹è¯•** - æµ‹è¯•ä¸çœŸå® DeFi åè®®é›†æˆ
2. **å¿«ç…§ä¸å›æ»š** - é«˜çº§æµ‹è¯•çŠ¶æ€ç®¡ç†
3. **æ¨¡ç³Šæµ‹è¯•ï¼ˆFuzzingï¼‰** - éšæœºè¾“å…¥å‘ç°è¾¹ç•Œ bug

### å‚è€ƒèµ„æº

**å®˜æ–¹æ–‡æ¡£ï¼š**
- [Hardhat Network Helpers - Time](https://hardhat.org/hardhat-network-helpers/docs/reference#time)
- [Hardhat Network Helpers - Mining](https://hardhat.org/hardhat-network-helpers/docs/reference#mining)

**å¸¸è§æ—¶é—´æ¨¡å¼ï¼š**
- [OpenZeppelin TimelockController](https://docs.openzeppelin.com/contracts/4.x/api/governance#TimelockController)
- [Vesting Contracts](https://docs.openzeppelin.com/contracts/4.x/api/finance#VestingWallet)

---

**ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2025-12-08
**ä½œè€…ï¼š** Droid
**é€‚ç”¨äººç¾¤ï¼š** å‰ç«¯å·¥ç¨‹å¸ˆè½¬ Web3 å¼€å‘
