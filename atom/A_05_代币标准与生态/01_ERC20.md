# ERC20 - åŒè´¨åŒ–ä»£å¸æ ‡å‡†

## 1. ã€30å­—æ ¸å¿ƒã€‘

**ERC20æ˜¯ä»¥å¤ªåŠåŒè´¨åŒ–ä»£å¸çš„æ¥å£æ ‡å‡†ï¼Œå®šä¹‰äº†6ä¸ªå‡½æ•°å’Œ2ä¸ªäº‹ä»¶ï¼Œä½¿æ‰€æœ‰ä»£å¸å…·æœ‰ç»Ÿä¸€çš„äº¤äº’æ–¹å¼ï¼Œæ˜¯DeFiç”Ÿæ€çš„åŸºçŸ³ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### ERC20çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**ERC20 = ä¸€å¥—ä»£å¸åˆçº¦å¿…é¡»å®ç°çš„æ¥å£è§„èŒƒ**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

ERC20ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ä»£å¸ï¼Œè€Œæ˜¯ä¸€ä¸ª**æ ‡å‡†æ¥å£**ï¼ˆç±»ä¼¼TypeScriptçš„interfaceï¼‰ï¼Œè§„å®šäº†ä»£å¸åˆçº¦å¿…é¡»æœ‰å“ªäº›å‡½æ•°å’Œäº‹ä»¶ã€‚

#### 2. ä¸ºä»€ä¹ˆéœ€è¦ERC20ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•è®©ä¸åŒå¼€å‘è€…åˆ›å»ºçš„ä»£å¸èƒ½å¤Ÿè¢«æ‰€æœ‰é’±åŒ…ã€äº¤æ˜“æ‰€ã€DAppç»Ÿä¸€è¯†åˆ«å’Œæ“ä½œï¼Ÿ**

åœ¨ERC20å‡ºç°ä¹‹å‰ï¼ˆ2015å¹´ä»¥å¤ªåŠæ—©æœŸï¼‰ï¼š
- æ¯ä¸ªé¡¹ç›®è‡ªå·±è®¾è®¡ä»£å¸æ¥å£
- å‡½æ•°åç§°äº”èŠ±å…«é—¨ï¼ˆ`send`ã€`transfer`ã€`pay`...ï¼‰
- é’±åŒ…éœ€è¦ä¸ºæ¯ç§ä»£å¸å†™å•ç‹¬çš„é€‚é…ä»£ç 
- äº¤æ˜“æ‰€æ— æ³•è‡ªåŠ¨ä¸Šæ¶æ–°ä»£å¸

**ç±»æ¯”**ï¼šå°±åƒUSBæ ‡å‡†å‡ºç°ä¹‹å‰ï¼Œæ¯ä¸ªå‚å•†çš„æ‰‹æœºå……ç”µå™¨éƒ½ä¸ä¸€æ ·ã€‚

#### 3. ERC20çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šäº’æ“ä½œæ€§ï¼ˆInteroperabilityï¼‰

æ‰€æœ‰ERC20ä»£å¸éƒ½æœ‰ç›¸åŒçš„æ¥å£ï¼Œä»»ä½•æ”¯æŒERC20çš„åº”ç”¨éƒ½èƒ½è‡ªåŠ¨æ”¯æŒæ–°ä»£å¸ã€‚

```javascript
// é’±åŒ…åªéœ€è¦ä¸€å¥—ä»£ç å°±èƒ½å¤„ç†æ‰€æœ‰ERC20ä»£å¸
const balance = await tokenContract.balanceOf(userAddress);
await tokenContract.transfer(recipient, amount);
```

##### ä»·å€¼2ï¼šå¯ç»„åˆæ€§ï¼ˆComposabilityï¼‰

DeFiåè®®ï¼ˆå¦‚Uniswapã€Aaveï¼‰å¯ä»¥æ„å»ºé€šç”¨çš„ä»£å¸äº¤æ¢/å€Ÿè´·é€»è¾‘ï¼Œæ— éœ€ä¸ºæ¯ç§ä»£å¸å•ç‹¬å¼€å‘ã€‚

```solidity
// Uniswapçš„swapå‡½æ•°å¯ä»¥å¤„ç†ä»»ä½•ERC20ä»£å¸
function swap(address tokenIn, address tokenOut, uint amount) {
    IERC20(tokenIn).transferFrom(msg.sender, address(this), amount);
    // ... è®¡ç®—è¾“å‡ºæ•°é‡
    IERC20(tokenOut).transfer(msg.sender, amountOut);
}
```

##### ä»·å€¼3ï¼šé™ä½å¼€å‘æˆæœ¬

å¼€å‘è€…ä¸éœ€è¦ä»é›¶è®¾è®¡ä»£å¸æ¥å£ï¼Œä½¿ç”¨OpenZeppelinç­‰åº“å¯ä»¥5åˆ†é’Ÿå†…éƒ¨ç½²ä¸€ä¸ªå®‰å…¨çš„ERC20ä»£å¸ã€‚

```solidity
// ä½¿ç”¨OpenZeppelinï¼Œå‡ è¡Œä»£ç å°±èƒ½åˆ›å»ºä»£å¸
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

contract MyToken is ERC20 {
    constructor() ERC20("My Token", "MTK") {
        _mint(msg.sender, 1000000 * 10**18);
    }
}
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ERC20è®¾è®¡

**æ¨ç†é“¾ï¼š**

```
1. å‰æï¼šéœ€è¦ä¸€ä¸ªé€šç”¨çš„ä»£å¸æ ‡å‡†
   â†“
2. æ¨å¯¼ï¼šä»£å¸çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ
   - æŸ¥è¯¢ä½™é¢ â†’ balanceOf(address)
   - è½¬è´¦ â†’ transfer(address, uint256)
   â†“
3. æ¨å¯¼ï¼šå¦‚ä½•è®©ç¬¬ä¸‰æ–¹ä»£ä¸ºæ“ä½œä»£å¸ï¼Ÿ
   - æˆæƒæœºåˆ¶ â†’ approve(address, uint256)
   - æŸ¥è¯¢æˆæƒé¢åº¦ â†’ allowance(address, address)
   - æˆæƒè½¬è´¦ â†’ transferFrom(address, address, uint256)
   â†“
4. æ¨å¯¼ï¼šéœ€è¦å“ªäº›åŸºæœ¬ä¿¡æ¯ï¼Ÿ
   - ä»£å¸åç§° â†’ name()
   - ä»£å¸ç¬¦å· â†’ symbol()
   - ç²¾åº¦ â†’ decimals()
   - æ€»ä¾›åº”é‡ â†’ totalSupply()
   â†“
5. æ¨å¯¼ï¼šå¦‚ä½•è®©é“¾ä¸‹åº”ç”¨ç›‘å¬ä»£å¸å˜åŠ¨ï¼Ÿ
   - è½¬è´¦äº‹ä»¶ â†’ Transfer(from, to, value)
   - æˆæƒäº‹ä»¶ â†’ Approval(owner, spender, value)
   â†“
6. æœ€ç»ˆå®ç°ï¼šERC20æ ‡å‡†
   - 6ä¸ªå¿…é¡»å‡½æ•° + 3ä¸ªå¯é€‰å‡½æ•° + 2ä¸ªäº‹ä»¶
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**ERC20æ˜¯ä»£å¸åˆçº¦çš„"USBæ ‡å‡†"ï¼Œé€šè¿‡å®šä¹‰ç»Ÿä¸€æ¥å£ï¼Œå®ç°äº†ä»£å¸çš„äº’æ“ä½œæ€§å’Œå¯ç»„åˆæ€§ï¼Œæ˜¯æ•´ä¸ªDeFiç”Ÿæ€çš„åŸºç¡€åè®®ã€‚**

---

## 3. ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šä½™é¢æ˜ å°„ï¼ˆBalance Mappingï¼‰ğŸ”¢

**ä¸€å¥è¯å®šä¹‰ï¼š** ERC20ä»£å¸çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ª`mapping(address => uint256)`ï¼Œè®°å½•æ¯ä¸ªåœ°å€æŒæœ‰çš„ä»£å¸æ•°é‡ã€‚

```solidity
// ERC20çš„æ ¸å¿ƒæ•°æ®ç»“æ„
contract ERC20 {
    // ä½™é¢æ˜ å°„ï¼šåœ°å€ â†’ ä»£å¸æ•°é‡
    mapping(address => uint256) private _balances;
  
    // æ€»ä¾›åº”é‡
    uint256 private _totalSupply;
  
    // æŸ¥è¯¢ä½™é¢
    function balanceOf(address account) public view returns (uint256) {
        return _balances[account];
    }
  
    // è½¬è´¦ï¼šä»è°ƒç”¨è€…è´¦æˆ·æ‰£é™¤ï¼Œå¢åŠ åˆ°æ¥æ”¶è€…è´¦æˆ·
    function transfer(address to, uint256 amount) public returns (bool) {
        address from = msg.sender;
      
        // æ£€æŸ¥ä½™é¢
        require(_balances[from] >= amount, "Insufficient balance");
      
        // æ‰£é™¤å‘é€è€…ä½™é¢
        _balances[from] -= amount;
      
        // å¢åŠ æ¥æ”¶è€…ä½™é¢
        _balances[to] += amount;
      
        // è§¦å‘Transferäº‹ä»¶
        emit Transfer(from, to, amount);
      
        return true;
    }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

ERC20ä»£å¸**ä¸æ˜¯çœŸæ­£çš„"è½¬ç§»"**ï¼Œè€Œæ˜¯**ä¿®æ”¹æ˜ å°„è¡¨ä¸­çš„æ•°å­—**ï¼š

```
è½¬è´¦å‰:
_balances = {
    Alice: 1000,
    Bob: 500
}

Alice.transfer(Bob, 200) å:
_balances = {
    Alice: 800,    // å‡å°‘200
    Bob: 700       // å¢åŠ 200
}
```

**ä¸ETHåŸç”Ÿè½¬è´¦çš„åŒºåˆ«ï¼š**

| ç‰¹æ€§ | ETHè½¬è´¦ | ERC20è½¬è´¦ |
|-----|--------|----------|
| å­˜å‚¨ä½ç½® | ä»¥å¤ªåŠçŠ¶æ€æ ‘ï¼ˆå…¨å±€ï¼‰ | ä»£å¸åˆçº¦å†…éƒ¨mapping |
| è½¬è´¦æ–¹å¼ | äº¤æ˜“çš„valueå­—æ®µ | è°ƒç”¨åˆçº¦çš„transferå‡½æ•° |
| Gasæ¶ˆè€— | ~21000 gas | ~50000-65000 gas |
| ç›‘å¬æ–¹å¼ | ç›‘å¬äº¤æ˜“ | ç›‘å¬Transferäº‹ä»¶ |

**åœ¨DAppå¼€å‘ä¸­çš„åº”ç”¨ï¼š**

```javascript
// å‰ç«¯æŸ¥è¯¢ä»£å¸ä½™é¢
const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
const balance = await tokenContract.balanceOf(userAddress);
console.log(`ä½™é¢: ${ethers.formatUnits(balance, 18)} ä»£å¸`);

// è½¬è´¦
const signer = await provider.getSigner();
const tokenWithSigner = tokenContract.connect(signer);
const tx = await tokenWithSigner.transfer(recipient, ethers.parseUnits("100", 18));
await tx.wait();
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šæˆæƒæœºåˆ¶ï¼ˆApprove & Allowanceï¼‰ğŸ”

**ä¸€å¥è¯å®šä¹‰ï¼š** æˆæƒæœºåˆ¶å…è®¸ä»£å¸æŒæœ‰è€…æˆæƒç¬¬ä¸‰æ–¹ï¼ˆå¦‚DEXåˆçº¦ï¼‰ä»£ä¸ºè½¬ç§»å…¶ä»£å¸ï¼Œæ˜¯DeFiå¯ç»„åˆæ€§çš„å…³é”®ã€‚

```solidity
contract ERC20 {
    // åŒå±‚æ˜ å°„ï¼šæ‹¥æœ‰è€… â†’ (è¢«æˆæƒè€… â†’ æˆæƒé¢åº¦)
    mapping(address => mapping(address => uint256)) private _allowances;
  
    // æˆæƒï¼šå…è®¸spenderæœ€å¤šèŠ±è´¹amountæ•°é‡çš„ä»£å¸
    function approve(address spender, uint256 amount) public returns (bool) {
        address owner = msg.sender;
        _allowances[owner][spender] = amount;
        emit Approval(owner, spender, amount);
        return true;
    }
  
    // æŸ¥è¯¢æˆæƒé¢åº¦
    function allowance(address owner, address spender) public view returns (uint256) {
        return _allowances[owner][spender];
    }
  
    // æˆæƒè½¬è´¦ï¼šspenderä»ownerè´¦æˆ·è½¬å‡ºä»£å¸
    function transferFrom(address from, address to, uint256 amount) public returns (bool) {
        address spender = msg.sender;
      
        // æ£€æŸ¥æˆæƒé¢åº¦
        uint256 currentAllowance = _allowances[from][spender];
        require(currentAllowance >= amount, "Insufficient allowance");
      
        // æ‰£å‡æˆæƒé¢åº¦
        _allowances[from][spender] = currentAllowance - amount;
      
        // æ‰§è¡Œè½¬è´¦ï¼ˆä¸transferç›¸åŒï¼‰
        require(_balances[from] >= amount, "Insufficient balance");
        _balances[from] -= amount;
        _balances[to] += amount;
      
        emit Transfer(from, to, amount);
        return true;
    }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

**ä¸ºä»€ä¹ˆéœ€è¦æˆæƒæœºåˆ¶ï¼Ÿ**

å‡è®¾ä½ è¦åœ¨Uniswapç”¨USDCæ¢ETHï¼š
1. Uniswapåˆçº¦éœ€è¦ä»ä½ çš„è´¦æˆ·"æ‹¿èµ°"USDC
2. ä½†åˆçº¦ä¸æ˜¯ä½ ï¼Œæ²¡æœ‰ä½ çš„ç§é’¥ï¼Œæ— æ³•ç›´æ¥è°ƒç”¨`transfer`
3. è§£å†³æ–¹æ¡ˆï¼šä½ å…ˆ`approve`æˆæƒUniswapåˆçº¦ï¼Œç„¶åUniswapè°ƒç”¨`transferFrom`

```javascript
// DeFiäº¤äº’æµç¨‹
// æ­¥éª¤1ï¼šç”¨æˆ·æˆæƒDEXåˆçº¦
await usdcContract.approve(uniswapRouterAddress, ethers.MaxUint256);

// æ­¥éª¤2ï¼šç”¨æˆ·è°ƒç”¨DEXçš„swapå‡½æ•°
await uniswapRouter.swapExactTokensForETH(
    amountIn,     // è¾“å…¥çš„USDCæ•°é‡
    amountOutMin, // æœ€å°è¾“å‡ºETHæ•°é‡
    path,         // äº¤æ˜“è·¯å¾„
    userAddress,  // æ¥æ”¶åœ°å€
    deadline      // äº¤æ˜“æˆªæ­¢æ—¶é—´
);

// æ­¥éª¤3ï¼šDEXåˆçº¦å†…éƒ¨è°ƒç”¨transferFrom
// usdcContract.transferFrom(userAddress, poolAddress, amountIn);
```

**æˆæƒæ•°æ®ç»“æ„å¯è§†åŒ–ï¼š**

```
_allowances = {
    Alice: {
        Uniswap: 1000000,    // AliceæˆæƒUniswapæœ€å¤šèŠ±è´¹100ä¸‡ä»£å¸
        Aave: 500000,        // AliceæˆæƒAaveæœ€å¤šèŠ±è´¹50ä¸‡ä»£å¸
        Bob: 0               // Aliceæ²¡æœ‰æˆæƒBob
    },
    Bob: {
        Uniswap: 2000000,
        ...
    }
}
```

**åœ¨DAppå¼€å‘ä¸­çš„åº”ç”¨ï¼š**

```javascript
// æ£€æŸ¥æˆæƒé¢åº¦
const allowance = await tokenContract.allowance(userAddress, spenderAddress);

// å¦‚æœæˆæƒé¢åº¦ä¸è¶³ï¼Œéœ€è¦å…ˆapprove
if (allowance < requiredAmount) {
    const tx = await tokenContract.approve(spenderAddress, ethers.MaxUint256);
    await tx.wait();
    console.log("æˆæƒæˆåŠŸ");
}

// ç°åœ¨spenderå¯ä»¥è°ƒç”¨transferFrom
```

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šç²¾åº¦ï¼ˆDecimalsï¼‰ğŸ“

**ä¸€å¥è¯å®šä¹‰ï¼š** `decimals`å®šä¹‰ä»£å¸çš„æœ€å°å•ä½ï¼Œé€šå¸¸ä¸º18ï¼ˆä¸ETHä¸€è‡´ï¼‰ï¼Œå®é™…å­˜å‚¨çš„æ˜¯æœ€å°å•ä½çš„æ•´æ•°æ•°é‡ã€‚

```solidity
contract ERC20 {
    uint8 private _decimals = 18;  // å¤§å¤šæ•°ä»£å¸ä½¿ç”¨18ä½ç²¾åº¦
  
    function decimals() public view returns (uint8) {
        return _decimals;
    }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

**ä¸ºä»€ä¹ˆéœ€è¦decimalsï¼Ÿ**

Solidityä¸æ”¯æŒæµ®ç‚¹æ•°ï¼Œæ‰€æœ‰æ•°å€¼éƒ½æ˜¯æ•´æ•°ã€‚ä¸ºäº†è¡¨ç¤ºå°æ•°ï¼Œé‡‡ç”¨"æœ€å°å•ä½"è®¾è®¡ï¼š

```javascript
// 1 ETH = 10^18 Wei
// 1 ä»£å¸ = 10^decimals æœ€å°å•ä½

// å¦‚æœdecimals = 18
// ç”¨æˆ·ç•Œé¢æ˜¾ç¤º "1.5 ä»£å¸"
// åˆçº¦å†…éƒ¨å­˜å‚¨ 1500000000000000000 (1.5 * 10^18)

// å¦‚æœdecimals = 6 (å¦‚USDC)
// ç”¨æˆ·ç•Œé¢æ˜¾ç¤º "1.5 USDC"
// åˆçº¦å†…éƒ¨å­˜å‚¨ 1500000 (1.5 * 10^6)
```

**å¸¸è§ä»£å¸çš„decimalsï¼š**

| ä»£å¸ | decimals | è¯´æ˜ |
|-----|----------|------|
| å¤§å¤šæ•°ä»£å¸ | 18 | ä¸ETHä¿æŒä¸€è‡´ |
| USDC/USDT | 6 | ç¾å…ƒç¨³å®šå¸ï¼Œ2ä½å°æ•°è¶³å¤Ÿ |
| WBTC | 8 | ä¸æ¯”ç‰¹å¸ç²¾åº¦ä¸€è‡´ |
| æŸäº›NFTä»£å¸ | 0 | ä¸å¯åˆ†å‰² |

**åœ¨DAppå¼€å‘ä¸­çš„åº”ç”¨ï¼š**

```javascript
// é”™è¯¯âŒï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æ•°å­—
const amount = 100; // ç”¨æˆ·æƒ³è½¬100ä¸ªä»£å¸
await tokenContract.transfer(recipient, amount); // å®é™…åªè½¬äº†0.0000000000000001ä¸ªï¼

// æ­£ç¡®âœ…ï¼šè½¬æ¢ä¸ºæœ€å°å•ä½
const decimals = await tokenContract.decimals();
const amount = ethers.parseUnits("100", decimals); // 100 * 10^18
await tokenContract.transfer(recipient, amount);

// æ˜¾ç¤ºç»™ç”¨æˆ·æ—¶è½¬æ¢å›å¯è¯»æ ¼å¼
const balance = await tokenContract.balanceOf(userAddress);
const formatted = ethers.formatUnits(balance, decimals);
console.log(`ä½™é¢: ${formatted} ä»£å¸`);
```

**Ethers.jså·¥å…·å‡½æ•°ï¼š**

```javascript
// è§£æï¼šç”¨æˆ·è¾“å…¥ â†’ åˆçº¦å­˜å‚¨æ ¼å¼
ethers.parseUnits("1.5", 18)  // â†’ 1500000000000000000n (BigInt)
ethers.parseUnits("1.5", 6)   // â†’ 1500000n

// æ ¼å¼åŒ–ï¼šåˆçº¦å­˜å‚¨æ ¼å¼ â†’ ç”¨æˆ·æ˜¾ç¤º
ethers.formatUnits(1500000000000000000n, 18)  // â†’ "1.5"
ethers.formatUnits(1500000n, 6)               // â†’ "1.5"

// ä¾¿æ·å‡½æ•°ï¼ˆé»˜è®¤18ä½ï¼‰
ethers.parseEther("1.5")   // ç­‰åŒäº parseUnits("1.5", 18)
ethers.formatEther(1500000000000000000n)  // ç­‰åŒäº formatUnits(..., 18)
```

---

## 4. ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½å¼€å‘åŸºç¡€çš„ERC20ä»£å¸åº”ç”¨ï¼š

### 4.1 ERC20çš„6ä¸ªæ ¸å¿ƒå‡½æ•°

```solidity
// å¿…é¡»å®ç°çš„6ä¸ªå‡½æ•°
interface IERC20 {
    // æŸ¥è¯¢ï¼šæ€»ä¾›åº”é‡
    function totalSupply() external view returns (uint256);
  
    // æŸ¥è¯¢ï¼šæŸåœ°å€çš„ä½™é¢
    function balanceOf(address account) external view returns (uint256);
  
    // æ“ä½œï¼šè½¬è´¦ï¼ˆä»è°ƒç”¨è€…åˆ°ç›®æ ‡åœ°å€ï¼‰
    function transfer(address to, uint256 amount) external returns (bool);
  
    // æŸ¥è¯¢ï¼šæˆæƒé¢åº¦
    function allowance(address owner, address spender) external view returns (uint256);
  
    // æ“ä½œï¼šæˆæƒï¼ˆå…è®¸spenderèŠ±è´¹è°ƒç”¨è€…çš„ä»£å¸ï¼‰
    function approve(address spender, uint256 amount) external returns (bool);
  
    // æ“ä½œï¼šæˆæƒè½¬è´¦ï¼ˆspenderä»ownerè½¬å‡ºåˆ°toï¼‰
    function transferFrom(address from, address to, uint256 amount) external returns (bool);
}
```

### 4.2 å‰ç«¯è¯»å–ä»£å¸ä¿¡æ¯

```javascript
const { ethers } = require('ethers');

// ERC20æœ€å°ABI
const ERC20_ABI = [
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function totalSupply() view returns (uint256)",
    "function balanceOf(address) view returns (uint256)",
    "function transfer(address to, uint256 amount) returns (bool)",
    "function approve(address spender, uint256 amount) returns (bool)",
    "function allowance(address owner, address spender) view returns (uint256)",
    "event Transfer(address indexed from, address indexed to, uint256 value)",
    "event Approval(address indexed owner, address indexed spender, uint256 value)"
];

// åˆ›å»ºåˆçº¦å®ä¾‹
const provider = new ethers.JsonRpcProvider('https://eth.llamarpc.com');
const tokenAddress = "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48"; // USDC
const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);

// è¯»å–ä»£å¸åŸºæœ¬ä¿¡æ¯
const name = await tokenContract.name();           // "USD Coin"
const symbol = await tokenContract.symbol();       // "USDC"
const decimals = await tokenContract.decimals();   // 6
const totalSupply = await tokenContract.totalSupply();

console.log(`${name} (${symbol})`);
console.log(`æ€»ä¾›åº”é‡: ${ethers.formatUnits(totalSupply, decimals)}`);
```

### 4.3 å‰ç«¯å‘é€ä»£å¸äº¤æ˜“

```javascript
// è¿æ¥é’±åŒ…
const signer = await provider.getSigner();
const tokenWithSigner = tokenContract.connect(signer);

// è½¬è´¦ï¼ˆéœ€è¦æ³¨æ„decimalsï¼‰
const amount = ethers.parseUnits("100", decimals); // è½¬100ä¸ªä»£å¸
const tx = await tokenWithSigner.transfer(recipientAddress, amount);
const receipt = await tx.wait();
console.log(`äº¤æ˜“æˆåŠŸ: ${receipt.hash}`);

// æˆæƒï¼ˆå…è®¸DEXåˆçº¦èŠ±è´¹ä»£å¸ï¼‰
const approveTx = await tokenWithSigner.approve(
    uniswapRouterAddress,
    ethers.MaxUint256  // æ— é™æˆæƒ
);
await approveTx.wait();
```

### 4.4 ä½¿ç”¨OpenZeppelinå¿«é€Ÿåˆ›å»ºä»£å¸

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

// æœ€ç®€å•çš„ERC20ä»£å¸
contract MyToken is ERC20 {
    constructor() ERC20("My Token", "MTK") {
        // é“¸é€ 100ä¸‡ä»£å¸ç»™éƒ¨ç½²è€…
        _mint(msg.sender, 1000000 * 10**decimals());
    }
}
```

### 4.5 ç›‘å¬Transferäº‹ä»¶

```javascript
// ç›‘å¬ä»£å¸è½¬è´¦äº‹ä»¶
tokenContract.on("Transfer", (from, to, value, event) => {
    console.log(`è½¬è´¦: ${from} â†’ ${to}`);
    console.log(`æ•°é‡: ${ethers.formatUnits(value, decimals)}`);
    console.log(`äº¤æ˜“å“ˆå¸Œ: ${event.log.transactionHash}`);
});

// æŸ¥è¯¢å†å²è½¬è´¦è®°å½•
const filter = tokenContract.filters.Transfer(userAddress, null);
const events = await tokenContract.queryFilter(filter, -10000); // æœ€è¿‘10000ä¸ªåŒºå—
```

---

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- âœ… åˆ›å»ºå’Œéƒ¨ç½²è‡ªå·±çš„ERC20ä»£å¸
- âœ… åœ¨DAppä¸­æ˜¾ç¤ºä»£å¸ä½™é¢å’Œè½¬è´¦åŠŸèƒ½
- âœ… ä¸DeFiåè®®äº¤äº’ï¼ˆapproveåswapï¼‰
- âœ… ç›‘å¬ä»£å¸è½¬è´¦äº‹ä»¶æ›´æ–°UI
- âœ… ç†è§£ç»å¤§å¤šæ•°ä»£å¸åˆçº¦çš„æºç 

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šERC20ä»£å¸ ğŸ¨

#### ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼šERC20 = å•†åœºè´­ç‰©å¡ç³»ç»Ÿ

æƒ³è±¡ä½ å»äº†ä¸€å®¶å¤§å‹è´­ç‰©ä¸­å¿ƒï¼Œé‡Œé¢æœ‰å¾ˆå¤šå•†å®¶éƒ½å‘è¡Œè‡ªå·±çš„è´­ç‰©å¡ï¼š

**ä¼ ç»Ÿæ–¹å¼ï¼ˆæ²¡æœ‰ç»Ÿä¸€æ ‡å‡†ï¼‰ï¼š**
- æ˜Ÿå·´å…‹å¡ï¼šåˆ·å¡åè¯´"æ‰£5æ¯"
- ä¼˜è¡£åº“å¡ï¼šåˆ·å¡åè¯´"å‡200å…ƒ"
- è‚¯å¾·åŸºå¡ï¼šåˆ·å¡åæŒ‰ä¸‹"ç¡®è®¤"æŒ‰é’®
- æ¯å®¶åº—çš„å¡æ“ä½œæ–¹å¼éƒ½ä¸ä¸€æ ·ï¼Œæ”¶é“¶å‘˜è¦å­¦ä¹ å¾ˆå¤šç§æ“ä½œ

**ERC20æ–¹å¼ï¼ˆç»Ÿä¸€æ ‡å‡†ï¼‰ï¼š**
- æ‰€æœ‰å•†å®¶çš„å¡éƒ½ä½¿ç”¨ç›¸åŒçš„ç³»ç»Ÿ
- æŸ¥ä½™é¢ï¼šåœ¨ä»»ä½•POSæœºè¾“å…¥`balanceOf(å¡å·)`
- æ¶ˆè´¹ï¼šåœ¨ä»»ä½•POSæœºè¾“å…¥`transfer(å•†å®¶, é‡‘é¢)`
- æˆæƒä»£ä»˜ï¼šè¾“å…¥`approve(æœ‹å‹, æœ€å¤š500å…ƒ)`ï¼Œæœ‹å‹å¯ä»¥ç”¨ä½ çš„å¡ä»˜æ¬¾

**å¯¹åº”å…³ç³»ï¼š**

| è´­ç‰©å¡ç³»ç»Ÿ | ERC20 | è¯´æ˜ |
|-----------|-------|------|
| è´­ç‰©å¡ | ERC20ä»£å¸åˆçº¦ | æ¯ç§å¡/ä»£å¸æ˜¯ç‹¬ç«‹çš„ç³»ç»Ÿ |
| å¡å· | é’±åŒ…åœ°å€ | è´¦æˆ·æ ‡è¯† |
| å¡å†…ä½™é¢ | `balanceOf()` | æŸ¥è¯¢æŒæœ‰æ•°é‡ |
| åˆ·å¡æ¶ˆè´¹ | `transfer()` | è½¬ç§»ä»£å¸ |
| æˆæƒæœ‹å‹ä»£ä»˜ | `approve()` | æˆæƒç¬¬ä¸‰æ–¹ |
| æœ‹å‹ä»£ä»˜ | `transferFrom()` | ç¬¬ä¸‰æ–¹æ‰§è¡Œè½¬è´¦ |
| æ‰€æœ‰å¡æ€»å‘è¡Œé‡ | `totalSupply()` | ä»£å¸æ€»é‡ |

**ä¸¾ä¾‹ï¼ˆ10å²å°æœ‹å‹èƒ½æ‡‚ï¼‰ï¼š**

> å°æ˜æœ‰ä¸€å¼ æ¸¸æˆå…çš„æ¸¸æˆå¸å¡ï¼Œå¡é‡Œæœ‰100ä¸ªæ¸¸æˆå¸ã€‚
>
> - **æŸ¥ä½™é¢**ï¼šå°æ˜åœ¨ä»»ä½•æ¸¸æˆæœºä¸Šåˆ·å¡ï¼Œå±å¹•æ˜¾ç¤º"ä½™é¢ï¼š100å¸"
> - **ç©æ¸¸æˆ**ï¼šå°æ˜ç©äº†èµ›è½¦æ¸¸æˆï¼Œæ‰£äº†5ä¸ªå¸ï¼Œç°åœ¨è¿˜å‰©95ä¸ª
> - **å€Ÿç»™æœ‹å‹**ï¼šå°æ˜è¯´"å°çº¢ï¼Œæˆ‘æˆæƒä½ æœ€å¤šç”¨æˆ‘çš„å¡èŠ±20ä¸ªå¸"
> - **æœ‹å‹ä½¿ç”¨**ï¼šå°çº¢æ‹¿å°æ˜çš„å¡ç©äº†å¤¹å¨ƒå¨ƒï¼ŒèŠ±äº†10ä¸ªå¸ï¼ˆä»å°æ˜å¡é‡Œæ‰£ï¼‰
>
> ERC20å°±æ˜¯è®©æ‰€æœ‰æ¸¸æˆå…çš„æ¸¸æˆå¸å¡éƒ½ç”¨åŒæ ·çš„è§„åˆ™ï¼Œè¿™æ ·ä¸ç®¡æ˜¯å“ªå®¶æ¸¸æˆå…å‘çš„å¡ï¼Œæ“ä½œæ–¹å¼éƒ½ä¸€æ ·ï¼

---

#### å‰ç«¯é¢†åŸŸç±»æ¯”ï¼šERC20 = TypeScript Interface

å¦‚æœä½ ç†Ÿæ‚‰TypeScriptï¼ŒERC20å°±æ˜¯ä¸€ä¸ª**æ¥å£å®šä¹‰**ï¼š

```typescript
// ERC20å°±åƒä¸€ä¸ªTypeScriptæ¥å£
interface IERC20 {
    // å±æ€§ï¼ˆåªè¯»ï¼‰
    name(): string;
    symbol(): string;
    decimals(): number;
    totalSupply(): bigint;
  
    // æ–¹æ³•ï¼ˆåªè¯»ï¼‰
    balanceOf(account: string): bigint;
    allowance(owner: string, spender: string): bigint;
  
    // æ–¹æ³•ï¼ˆå†™å…¥ï¼‰
    transfer(to: string, amount: bigint): boolean;
    approve(spender: string, amount: bigint): boolean;
    transferFrom(from: string, to: string, amount: bigint): boolean;
  
    // äº‹ä»¶
    on(event: "Transfer", callback: (from: string, to: string, value: bigint) => void): void;
    on(event: "Approval", callback: (owner: string, spender: string, value: bigint) => void): void;
}

// ä»»ä½•å®ç°äº†IERC20æ¥å£çš„åˆçº¦ï¼Œéƒ½å¯ä»¥è¢«å½“ä½œERC20ä»£å¸ä½¿ç”¨
class USDC implements IERC20 { /* ... */ }
class DAI implements IERC20 { /* ... */ }
class WETH implements IERC20 { /* ... */ }

// DAppåªéœ€è¦é¢å‘æ¥å£ç¼–ç¨‹
function getTokenBalance(token: IERC20, user: string): bigint {
    return token.balanceOf(user);  // é€‚ç”¨äºæ‰€æœ‰ERC20ä»£å¸
}
```

**æ›´è¯¦ç»†çš„å‰ç«¯ç±»æ¯”ï¼š**

```javascript
// å‰ç«¯çŠ¶æ€ç®¡ç†ç±»æ¯”

// ERC20çš„_balancesæ˜ å°„ ç±»ä¼¼äº Redux Storeçš„state
const reduxState = {
    balances: {
        "0xAlice": 1000,
        "0xBob": 500
    }
};

// transferå‡½æ•° ç±»ä¼¼äº Reduxçš„action + reducer
const transferAction = (from, to, amount) => ({
    type: "TRANSFER",
    payload: { from, to, amount }
});

const balanceReducer = (state, action) => {
    if (action.type === "TRANSFER") {
        const { from, to, amount } = action.payload;
        return {
            ...state,
            balances: {
                ...state.balances,
                [from]: state.balances[from] - amount,
                [to]: (state.balances[to] || 0) + amount
            }
        };
    }
    return state;
};

// Transferäº‹ä»¶ ç±»ä¼¼äº Reduxçš„subscribe
store.subscribe(() => {
    console.log("çŠ¶æ€å˜åŒ–:", store.getState());
});
```

**approve/transferFrom ç±»ä¼¼äº OAuthæˆæƒï¼š**

```javascript
// OAuthæˆæƒæµç¨‹ vs ERC20æˆæƒ
// 1. ç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®è‡ªå·±çš„èµ„æº
// OAuth: "å…è®¸Notionè¯»å–æˆ‘çš„Googleæ—¥å†"
// ERC20: "å…è®¸UniswapèŠ±è´¹æˆ‘çš„USDC"

// 2. æˆæƒç /Token
// OAuth: access_token = "eyJhbG..."
// ERC20: allowance[owner][spender] = 1000000

// 3. ç¬¬ä¸‰æ–¹ä½¿ç”¨æˆæƒ
// OAuth: fetch('/calendar', { headers: { Authorization: `Bearer ${token}` }})
// ERC20: tokenContract.transferFrom(owner, recipient, amount)
```

---

### ç±»æ¯”2ï¼šapproveæˆæƒæœºåˆ¶ ğŸ”‘

#### ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼šapprove = é“¶è¡Œæˆæƒæ‰£æ¬¾

æƒ³è±¡ä½ è¦æ¯æœˆè‡ªåŠ¨è¿˜ä¿¡ç”¨å¡ï¼š

1. **è®¾ç½®è‡ªåŠ¨æ‰£æ¬¾ï¼ˆapproveï¼‰**ï¼š
   - ä½ å‘Šè¯‰é“¶è¡Œï¼š"å…è®¸æ‹›å•†é“¶è¡Œä¿¡ç”¨å¡æ¯æœˆä»æˆ‘çš„å‚¨è“„å¡æ‰£æ¬¾ï¼Œæœ€å¤šæ‰£5000å…ƒ"
   - è¿™å°±æ˜¯`approve(æ‹›å•†ä¿¡ç”¨å¡, 5000)`

2. **è‡ªåŠ¨æ‰£æ¬¾æ‰§è¡Œï¼ˆtransferFromï¼‰**ï¼š
   - æ¯æœˆè¿˜æ¬¾æ—¥ï¼Œæ‹›å•†ä¿¡ç”¨å¡ä»ä½ çš„å‚¨è“„å¡æ‰£æ¬¾2000å…ƒ
   - è¿™å°±æ˜¯`transferFrom(ä½ , æ‹›å•†ä¿¡ç”¨å¡, 2000)`

3. **æŸ¥çœ‹æˆæƒé¢åº¦ï¼ˆallowanceï¼‰**ï¼š
   - ä½ æƒ³çŸ¥é“è¿˜æˆæƒäº†å¤šå°‘é¢åº¦
   - è¿™å°±æ˜¯`allowance(ä½ , æ‹›å•†ä¿¡ç”¨å¡)` â†’ è¿”å›5000

---

#### å‰ç«¯é¢†åŸŸç±»æ¯”ï¼šapprove = localStorageæˆæƒç¬¬ä¸‰æ–¹è®¿é—®

```javascript
// ç±»æ¯”ï¼šæµè§ˆå™¨storageæˆæƒ

// æ­£å¸¸è®¿é—®è‡ªå·±çš„storageï¼ˆç±»ä¼¼transferï¼‰
localStorage.setItem("myData", "value"); // è‡ªå·±å¯ä»¥ç›´æ¥æ“ä½œ

// æˆæƒç¬¬ä¸‰æ–¹iframeè®¿é—®ï¼ˆç±»ä¼¼approveï¼‰
// å‡è®¾æœ‰ä¸ªæˆæƒæœºåˆ¶
window.postMessage({
    type: "AUTHORIZE_STORAGE",
    origin: "https://third-party.com",
    maxAccess: "read-write",
    quota: 1000  // æœ€å¤šè¯»å†™1000æ¬¡
}, "*");

// ç¬¬ä¸‰æ–¹ä½¿ç”¨æˆæƒï¼ˆç±»ä¼¼transferFromï¼‰
// ç¬¬ä¸‰æ–¹iframeé€šè¿‡æˆæƒè®¿é—®ä½ çš„storage
window.parent.postMessage({
    type: "ACCESS_STORAGE",
    action: "getItem",
    key: "myData"
}, "*");
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| ERC20æ¦‚å¿µ | ç”Ÿæ´»åœºæ™¯ç±»æ¯” | å‰ç«¯é¢†åŸŸç±»æ¯” |
|----------|-------------|-------------|
| **ERC20æ ‡å‡†** | è´­ç‰©å¡ç»Ÿä¸€æ ‡å‡† | TypeScript Interface |
| **ä»£å¸åˆçº¦** | æŸå•†å®¶çš„è´­ç‰©å¡ç³»ç»Ÿ | å®ç°æ¥å£çš„Class |
| **`_balances`æ˜ å°„** | å¡å·â†’ä½™é¢çš„æ•°æ®åº“è¡¨ | Redux state / Mapå¯¹è±¡ |
| **`balanceOf()`** | æŸ¥è¯¢å¡å†…ä½™é¢ | `state.balances[address]` |
| **`transfer()`** | åˆ·å¡æ¶ˆè´¹ | dispatch(transferAction) |
| **`approve()`** | æˆæƒæœ‹å‹ä»£ä»˜/è‡ªåŠ¨æ‰£æ¬¾ | OAuthæˆæƒ/å­˜å‚¨æƒé™ |
| **`allowance()`** | æŸ¥çœ‹æˆæƒé¢åº¦ | æ£€æŸ¥tokenæƒé™èŒƒå›´ |
| **`transferFrom()`** | ä»£ä»˜/è‡ªåŠ¨æ‰£æ¬¾æ‰§è¡Œ | ç¬¬ä¸‰æ–¹ä½¿ç”¨æˆæƒæ“ä½œ |
| **`Transfer`äº‹ä»¶** | æ¶ˆè´¹çŸ­ä¿¡é€šçŸ¥ | Redux subscribe / EventEmitter |
| **`decimals`** | é‡‘é¢å•ä½ï¼ˆå…ƒvsåˆ†ï¼‰ | æ•°å€¼æ ¼å¼åŒ–ç²¾åº¦ |
| **`totalSupply`** | å‘å¡æ€»é‡ | æ•°æ®æ€»æ¡æ•° |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šERC20ä»£å¸æ˜¯"å‘é€"ç»™æ¥æ”¶è€…çš„ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

å¾ˆå¤šäººä»¥ä¸ºä»£å¸è½¬è´¦æ˜¯æŠŠä»£å¸"ä»Aå‘é€åˆ°B"ï¼Œå®é™…ä¸Šï¼š

- **ERC20æ²¡æœ‰ä»»ä½•æ•°æ®"ç§»åŠ¨"**
- åªæ˜¯ä¿®æ”¹äº†åˆçº¦å†…éƒ¨mappingçš„ä¸¤ä¸ªæ•°å­—
- ä»£å¸æœ¬èº«ä¸å­˜åœ¨äºé’±åŒ…ä¸­ï¼Œåªå­˜åœ¨äºåˆçº¦çš„å­˜å‚¨ä¸­

```solidity
// è½¬è´¦çš„çœŸæ­£é€»è¾‘
function transfer(address to, uint256 amount) public returns (bool) {
    // å¹¶æ²¡æœ‰"å‘é€"ä»»ä½•ä¸œè¥¿
    // åªæ˜¯ä¿®æ”¹äº†ä¸¤ä¸ªæ•°å­—
    _balances[msg.sender] -= amount;  // å‘é€è€…æ•°å­—å‡å°‘
    _balances[to] += amount;           // æ¥æ”¶è€…æ•°å­—å¢åŠ 
  
    emit Transfer(msg.sender, to, amount);
    return true;
}
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸ºæ—¥å¸¸ç»éªŒä¸­ï¼Œè½¬è´¦æ„å‘³ç€"ä¸œè¥¿ä»Aç§»åŠ¨åˆ°B"ï¼Œä½†åœ¨ä»¥å¤ªåŠä¸Šï¼Œä»£å¸åªæ˜¯ä¸€ä¸ªæ™ºèƒ½åˆçº¦ç»´æŠ¤çš„æ•°å­—è®°å½•ã€‚ä½ çš„é’±åŒ…ä¸"æŒæœ‰"ä»£å¸ï¼Œåªæ˜¯åˆçº¦é‡Œè®°å½•äº†ä½ çš„åœ°å€å¯¹åº”å¤šå°‘æ•°å­—ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// ä½ çš„"ä»£å¸ä½™é¢"å¹¶ä¸åœ¨ä½ çš„é’±åŒ…é‡Œ
// è€Œæ˜¯åœ¨ä»£å¸åˆçº¦çš„å­˜å‚¨ä¸­

// æŸ¥è¯¢ä½™é¢å®é™…ä¸Šæ˜¯ï¼š
// 1. è¿æ¥åˆ°ä»£å¸åˆçº¦
// 2. è¯»å–åˆçº¦storageä¸­çš„_balancesæ˜ å°„
// 3. ç”¨ä½ çš„åœ°å€ä½œä¸ºkeyæŸ¥è¯¢å¯¹åº”çš„value

const tokenContract = new ethers.Contract(tokenAddress, abi, provider);
const balance = await tokenContract.balanceOf(myAddress);
// å®é™…æ‰§è¡Œï¼šreturn _balances[myAddress];

// æ‰€ä»¥ä¸åŒçš„ä»£å¸éœ€è¦åˆ†åˆ«æŸ¥è¯¢
const usdcBalance = await usdcContract.balanceOf(myAddress);
const daiBalance = await daiContract.balanceOf(myAddress);
// å› ä¸ºå®ƒä»¬æ˜¯ä¸åŒåˆçº¦çš„ä¸åŒmapping
```

---

### è¯¯åŒº2ï¼šapproveè®¾ç½®ä¸ºæ— é™æˆæƒæ˜¯å®‰å…¨çš„ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

å¾ˆå¤šDAppä¸ºäº†é¿å…ç”¨æˆ·é‡å¤æˆæƒï¼Œä¼šè¯·æ±‚`approve(spender, MaxUint256)`ï¼ˆæ— é™æˆæƒï¼‰ã€‚ä½†è¿™éå¸¸å±é™©ï¼š

```javascript
// å¸¸è§çš„"æ— é™æˆæƒ"æ¨¡å¼
await tokenContract.approve(dexAddress, ethers.MaxUint256);
// MaxUint256 = 2^256 - 1 â‰ˆ 1.15 * 10^77ï¼ˆå¤©æ–‡æ•°å­—ï¼‰
```

**é£é™©ï¼š**

1. **åˆçº¦æ¼æ´**ï¼šå¦‚æœDEXåˆçº¦æœ‰bugï¼Œæ”»å‡»è€…å¯èƒ½è°ƒç”¨`transferFrom`è½¬èµ°ä½ æ‰€æœ‰ä»£å¸
2. **æ¶æ„å‡çº§**ï¼šå¦‚æœåˆçº¦å¯å‡çº§ï¼Œç®¡ç†å‘˜å¯èƒ½æ¤å…¥æ¶æ„ä»£ç 
3. **ç§é’¥æ³„éœ²**ï¼šDEXçš„ç§é’¥æ³„éœ²åï¼Œæ”»å‡»è€…å¯ä»¥æ“ä½œæ‰€æœ‰æˆæƒç”¨æˆ·çš„ä»£å¸

**çœŸå®æ¡ˆä¾‹ï¼š**

- 2022å¹´BadgerDAOæ”»å‡»ï¼šé»‘å®¢åˆ©ç”¨å·²æˆæƒçš„approveï¼Œç›—å–äº†1.2äº¿ç¾å…ƒ
- 2021å¹´å¤šèµ·DeFiæ”»å‡»éƒ½åˆ©ç”¨äº†æ— é™æˆæƒæ¼æ´

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸ºæ¯æ¬¡äº¤æ˜“å‰éƒ½è¦approveå¾ˆéº»çƒ¦ï¼ˆå¤šä¸€æ¬¡äº¤æ˜“=å¤šèŠ±ä¸€æ¬¡Gasï¼‰ï¼Œæ‰€ä»¥ç”¨æˆ·å’ŒDAppéƒ½å€¾å‘äºä¸€æ¬¡æ€§æˆæƒæ— é™é¢åº¦ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// æ›´å®‰å…¨çš„åšæ³•

// 1. åªæˆæƒæœ¬æ¬¡äº¤æ˜“éœ€è¦çš„æ•°é‡
const exactAmount = ethers.parseUnits("100", 18);
await tokenContract.approve(dexAddress, exactAmount);

// 2. äº¤æ˜“å®Œæˆåæ£€æŸ¥/æ’¤é”€æˆæƒ
const allowance = await tokenContract.allowance(myAddress, dexAddress);
if (allowance > 0) {
    await tokenContract.approve(dexAddress, 0); // æ’¤é”€æˆæƒ
}

// 3. ä½¿ç”¨Permitï¼ˆERC20 Permitæ‰©å±•ï¼‰é¿å…approveäº¤æ˜“
// é€šè¿‡ç­¾åæˆæƒï¼Œä¸éœ€è¦å•ç‹¬çš„approveäº¤æ˜“
const { v, r, s } = await signer._signTypedData(domain, types, message);
await tokenContract.permit(owner, spender, value, deadline, v, r, s);
```

**å®‰å…¨å»ºè®®ï¼š**

```javascript
// æ£€æŸ¥æ‰€æœ‰å·²æˆæƒçš„åˆçº¦
// ä½¿ç”¨å·¥å…·å¦‚ revoke.cash æˆ– Etherscan Token Approvals

// åœ¨Etherscanä¸ŠæŸ¥çœ‹æˆæƒ
// https://etherscan.io/tokenapprovalchecker

// æ’¤é”€ä¸éœ€è¦çš„æˆæƒ
await tokenContract.approve(suspiciousContract, 0);
```

---

### è¯¯åŒº3ï¼štransferå¤±è´¥ä¼šè‡ªåŠ¨é€€æ¬¾ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

åœ¨ä¼ ç»Ÿé“¶è¡Œç³»ç»Ÿä¸­ï¼Œè½¬è´¦å¤±è´¥ä¼šè‡ªåŠ¨é€€æ¬¾ã€‚ä½†ERC20ä¸åŒï¼š

```solidity
// ERC20 transferçš„ä¸¤ç§ç»“æœ
function transfer(address to, uint256 amount) public returns (bool) {
    // æƒ…å†µ1ï¼šä½™é¢ä¸è¶³ â†’ äº¤æ˜“revertï¼ŒGasè´¹ä»ç„¶æ‰£é™¤ï¼ŒçŠ¶æ€ä¸å˜
    require(_balances[msg.sender] >= amount, "Insufficient balance");
  
    // æƒ…å†µ2ï¼šè½¬è´¦åˆ°åˆçº¦åœ°å€ï¼Œåˆçº¦æ²¡æœ‰æ¥æ”¶é€»è¾‘ â†’ ä»£å¸æ°¸ä¹…ä¸¢å¤±ï¼
    _balances[msg.sender] -= amount;
    _balances[to] += amount;
  
    emit Transfer(msg.sender, to, amount);
    return true;
}
```

**ä»£å¸ä¸¢å¤±çš„å¸¸è§æƒ…å†µï¼š**

1. **è½¬åˆ°åˆçº¦åœ°å€**ï¼šå¦‚æœæ¥æ”¶åœ°å€æ˜¯ä¸€ä¸ªåˆçº¦ï¼Œä½†è¯¥åˆçº¦æ²¡æœ‰å¤„ç†ERC20ä»£å¸çš„é€»è¾‘ï¼Œä»£å¸ä¼šæ°¸ä¹…é”å®š
2. **è½¬åˆ°é”™è¯¯åœ°å€**ï¼šåœ°å€å†™é”™äº†ï¼Œä»£å¸æ— æ³•æ‰¾å›
3. **è½¬åˆ°é›¶åœ°å€**ï¼š`transfer(0x0, amount)` ç›¸å½“äºé”€æ¯ä»£å¸

**çœŸå®æ¡ˆä¾‹ï¼š**

- ä»·å€¼æ•°ç™¾ä¸‡ç¾å…ƒçš„ä»£å¸è¢«è¯¯è½¬åˆ°åˆçº¦åœ°å€ï¼Œæ°¸ä¹…ä¸¢å¤±
- æœ‰äººè¯¯è½¬ä»£å¸åˆ°ä»£å¸åˆçº¦æœ¬èº«ï¼ˆå¦‚æŠŠUSDCè½¬åˆ°USDCåˆçº¦åœ°å€ï¼‰ï¼Œæ— æ³•å–å›

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸ºä¼ ç»Ÿé“¶è¡Œè½¬è´¦æœ‰ä¸­å¿ƒåŒ–æœºæ„å¯ä»¥æ’¤é”€/é€€æ¬¾ï¼Œè€ŒåŒºå—é“¾æ˜¯ä¸å¯é€†çš„ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// è½¬è´¦å‰éªŒè¯
async function safeTransfer(tokenContract, to, amount) {
    // 1. éªŒè¯åœ°å€æ ¼å¼
    if (!ethers.isAddress(to)) {
        throw new Error("æ— æ•ˆçš„åœ°å€æ ¼å¼");
    }
  
    // 2. æ£€æŸ¥æ˜¯å¦æ˜¯é›¶åœ°å€
    if (to === ethers.ZeroAddress) {
        throw new Error("ä¸èƒ½è½¬è´¦åˆ°é›¶åœ°å€");
    }
  
    // 3. æ£€æŸ¥æ˜¯å¦æ˜¯åˆçº¦åœ°å€ï¼ˆå¯é€‰è­¦å‘Šï¼‰
    const code = await provider.getCode(to);
    if (code !== "0x") {
        console.warn("è­¦å‘Šï¼šæ¥æ”¶åœ°å€æ˜¯åˆçº¦ï¼Œè¯·ç¡®è®¤è¯¥åˆçº¦èƒ½å¤„ç†ERC20ä»£å¸");
    }
  
    // 4. æ£€æŸ¥ä½™é¢
    const balance = await tokenContract.balanceOf(await signer.getAddress());
    if (balance < amount) {
        throw new Error(`ä½™é¢ä¸è¶³ï¼šéœ€è¦ ${amount}ï¼Œå®é™… ${balance}`);
    }
  
    // 5. æ‰§è¡Œè½¬è´¦
    const tx = await tokenContract.transfer(to, amount);
    return tx.wait();
}
```

**ERC20çš„æ”¹è¿›ï¼šSafeERC20**

```solidity
// OpenZeppelinçš„SafeERC20åº“
import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";

using SafeERC20 for IERC20;

// safeTransferä¼šæ£€æŸ¥è¿”å›å€¼
token.safeTransfer(to, amount);  // å¦‚æœå¤±è´¥ä¼šrevert
```

---

## 7. ã€å®æˆ˜ä»£ç ã€‘

### åŸºç¡€å®ç°ï¼šåˆ›å»ºå’Œéƒ¨ç½²ERC20ä»£å¸

**Solidityåˆçº¦ï¼ˆå®Œæ•´ç‰ˆï¼‰ï¼š**

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

/**
 * @title SimpleERC20
 * @dev ä¸€ä¸ªå®Œæ•´çš„ERC20ä»£å¸å®ç°ï¼ˆæ•™å­¦ç‰ˆï¼‰
 */
contract SimpleERC20 {
    // ===== çŠ¶æ€å˜é‡ =====
    string public name;           // ä»£å¸åç§°
    string public symbol;         // ä»£å¸ç¬¦å·
    uint8 public decimals = 18;   // ç²¾åº¦ï¼ˆå°æ•°ä½æ•°ï¼‰
    uint256 public totalSupply;   // æ€»ä¾›åº”é‡
  
    // ä½™é¢æ˜ å°„ï¼šåœ°å€ â†’ ä»£å¸æ•°é‡
    mapping(address => uint256) public balanceOf;
  
    // æˆæƒæ˜ å°„ï¼šæ‹¥æœ‰è€… â†’ (è¢«æˆæƒè€… â†’ æˆæƒé¢åº¦)
    mapping(address => mapping(address => uint256)) public allowance;
  
    // ===== äº‹ä»¶ =====
    event Transfer(address indexed from, address indexed to, uint256 value);
    event Approval(address indexed owner, address indexed spender, uint256 value);
  
    // ===== æ„é€ å‡½æ•° =====
    constructor(
        string memory _name,
        string memory _symbol,
        uint256 _initialSupply
    ) {
        name = _name;
        symbol = _symbol;
      
        // é“¸é€ åˆå§‹ä¾›åº”é‡ç»™éƒ¨ç½²è€…
        // æ³¨æ„ï¼š_initialSupplyåº”è¯¥æ˜¯"äººç±»å¯è¯»"çš„æ•°é‡
        // å®é™…å­˜å‚¨çš„æ˜¯ _initialSupply * 10^decimals
        uint256 totalTokens = _initialSupply * 10**decimals;
        totalSupply = totalTokens;
        balanceOf[msg.sender] = totalTokens;
      
        emit Transfer(address(0), msg.sender, totalTokens);
    }
  
    // ===== æ ¸å¿ƒå‡½æ•° =====
  
    /**
     * @dev è½¬è´¦ä»£å¸
     * @param to æ¥æ”¶åœ°å€
     * @param amount è½¬è´¦æ•°é‡ï¼ˆæœ€å°å•ä½ï¼‰
     */
    function transfer(address to, uint256 amount) public returns (bool) {
        require(to != address(0), "ERC20: transfer to zero address");
        require(balanceOf[msg.sender] >= amount, "ERC20: insufficient balance");
      
        // æ›´æ–°ä½™é¢ï¼ˆSolidity 0.8+è‡ªåŠ¨æ£€æŸ¥æº¢å‡ºï¼‰
        balanceOf[msg.sender] -= amount;
        balanceOf[to] += amount;
      
        emit Transfer(msg.sender, to, amount);
        return true;
    }
  
    /**
     * @dev æˆæƒç¬¬ä¸‰æ–¹èŠ±è´¹ä»£å¸
     * @param spender è¢«æˆæƒåœ°å€
     * @param amount æˆæƒé¢åº¦
     */
    function approve(address spender, uint256 amount) public returns (bool) {
        require(spender != address(0), "ERC20: approve to zero address");
      
        allowance[msg.sender][spender] = amount;
      
        emit Approval(msg.sender, spender, amount);
        return true;
    }
  
    /**
     * @dev æˆæƒè½¬è´¦ï¼ˆç¬¬ä¸‰æ–¹ä»£ä¸ºè½¬è´¦ï¼‰
     * @param from ä»£å¸æ¥æºåœ°å€
     * @param to æ¥æ”¶åœ°å€
     * @param amount è½¬è´¦æ•°é‡
     */
    function transferFrom(
        address from,
        address to,
        uint256 amount
    ) public returns (bool) {
        require(to != address(0), "ERC20: transfer to zero address");
        require(balanceOf[from] >= amount, "ERC20: insufficient balance");
        require(allowance[from][msg.sender] >= amount, "ERC20: insufficient allowance");
      
        // æ‰£å‡æˆæƒé¢åº¦
        allowance[from][msg.sender] -= amount;
      
        // æ‰§è¡Œè½¬è´¦
        balanceOf[from] -= amount;
        balanceOf[to] += amount;
      
        emit Transfer(from, to, amount);
        return true;
    }
  
    // ===== æ‰©å±•å‡½æ•°ï¼ˆå¯é€‰ï¼‰=====
  
    /**
     * @dev å¢åŠ æˆæƒé¢åº¦ï¼ˆæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
     */
    function increaseAllowance(address spender, uint256 addedValue) public returns (bool) {
        approve(spender, allowance[msg.sender][spender] + addedValue);
        return true;
    }
  
    /**
     * @dev å‡å°‘æˆæƒé¢åº¦
     */
    function decreaseAllowance(address spender, uint256 subtractedValue) public returns (bool) {
        uint256 currentAllowance = allowance[msg.sender][spender];
        require(currentAllowance >= subtractedValue, "ERC20: decreased allowance below zero");
        approve(spender, currentAllowance - subtractedValue);
        return true;
    }
}
```

---

### å‰ç«¯é›†æˆï¼šå®Œæ•´çš„ERC20äº¤äº’ç¤ºä¾‹

```javascript
// ===== 1. å®‰è£…ä¾èµ– =====
// npm install ethers

const { ethers } = require('ethers');

// ===== 2. ERC20 ABIï¼ˆæœ€å°åŒ–ç‰ˆæœ¬ï¼‰=====
const ERC20_ABI = [
    // åªè¯»å‡½æ•°
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function totalSupply() view returns (uint256)",
    "function balanceOf(address account) view returns (uint256)",
    "function allowance(address owner, address spender) view returns (uint256)",
  
    // å†™å…¥å‡½æ•°
    "function transfer(address to, uint256 amount) returns (bool)",
    "function approve(address spender, uint256 amount) returns (bool)",
    "function transferFrom(address from, address to, uint256 amount) returns (bool)",
  
    // äº‹ä»¶
    "event Transfer(address indexed from, address indexed to, uint256 value)",
    "event Approval(address indexed owner, address indexed spender, uint256 value)"
];

// ===== 3. è¿æ¥åˆ°ä»¥å¤ªåŠ =====
const provider = new ethers.JsonRpcProvider('https://eth.llamarpc.com');

// æµ‹è¯•ç”¨çš„USDCåˆçº¦åœ°å€ï¼ˆä»¥å¤ªåŠä¸»ç½‘ï¼‰
const USDC_ADDRESS = "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48";

// åˆ›å»ºåˆçº¦å®ä¾‹
const usdcContract = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, provider);

// ===== 4. åœºæ™¯1ï¼šè¯»å–ä»£å¸ä¿¡æ¯ =====
async function getTokenInfo() {
    console.log("=== åœºæ™¯1ï¼šè¯»å–ä»£å¸ä¿¡æ¯ ===\n");
  
    const name = await usdcContract.name();
    const symbol = await usdcContract.symbol();
    const decimals = await usdcContract.decimals();
    const totalSupply = await usdcContract.totalSupply();
  
    console.log(`ä»£å¸åç§°: ${name}`);
    console.log(`ä»£å¸ç¬¦å·: ${symbol}`);
    console.log(`ç²¾åº¦: ${decimals} ä½å°æ•°`);
    console.log(`æ€»ä¾›åº”é‡: ${ethers.formatUnits(totalSupply, decimals)} ${symbol}`);
}

// ===== 5. åœºæ™¯2ï¼šæŸ¥è¯¢è´¦æˆ·ä½™é¢ =====
async function getBalance(address) {
    console.log("\n=== åœºæ™¯2ï¼šæŸ¥è¯¢è´¦æˆ·ä½™é¢ ===\n");
  
    const decimals = await usdcContract.decimals();
    const balance = await usdcContract.balanceOf(address);
  
    console.log(`åœ°å€: ${address}`);
    console.log(`USDCä½™é¢: ${ethers.formatUnits(balance, decimals)}`);
  
    return balance;
}

// ===== 6. åœºæ™¯3ï¼šæŸ¥è¯¢æˆæƒé¢åº¦ =====
async function getAllowance(owner, spender) {
    console.log("\n=== åœºæ™¯3ï¼šæŸ¥è¯¢æˆæƒé¢åº¦ ===\n");
  
    const decimals = await usdcContract.decimals();
    const allowance = await usdcContract.allowance(owner, spender);
  
    console.log(`Owner: ${owner}`);
    console.log(`Spender: ${spender}`);
    console.log(`æˆæƒé¢åº¦: ${ethers.formatUnits(allowance, decimals)} USDC`);
  
    return allowance;
}

// ===== 7. åœºæ™¯4ï¼šè½¬è´¦ï¼ˆéœ€è¦ç§é’¥/é’±åŒ…ï¼‰=====
async function transferTokens(privateKey, to, amount) {
    console.log("\n=== åœºæ™¯4ï¼šè½¬è´¦ä»£å¸ ===\n");
  
    // åˆ›å»ºé’±åŒ…å®ä¾‹
    const wallet = new ethers.Wallet(privateKey, provider);
    const contractWithSigner = usdcContract.connect(wallet);
  
    const decimals = await usdcContract.decimals();
    const amountInWei = ethers.parseUnits(amount.toString(), decimals);
  
    console.log(`å‘é€æ–¹: ${wallet.address}`);
    console.log(`æ¥æ”¶æ–¹: ${to}`);
    console.log(`æ•°é‡: ${amount} USDC`);
  
    // æ£€æŸ¥ä½™é¢
    const balance = await usdcContract.balanceOf(wallet.address);
    if (balance < amountInWei) {
        throw new Error(`ä½™é¢ä¸è¶³ï¼šéœ€è¦ ${amount}ï¼Œå®é™… ${ethers.formatUnits(balance, decimals)}`);
    }
  
    // å‘é€äº¤æ˜“
    const tx = await contractWithSigner.transfer(to, amountInWei);
    console.log(`äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);
  
    // ç­‰å¾…ç¡®è®¤
    const receipt = await tx.wait();
    console.log(`äº¤æ˜“ç¡®è®¤ï¼åŒºå—: ${receipt.blockNumber}`);
  
    return receipt;
}

// ===== 8. åœºæ™¯5ï¼šæˆæƒï¼ˆapproveï¼‰=====
async function approveSpender(privateKey, spender, amount) {
    console.log("\n=== åœºæ™¯5ï¼šæˆæƒç¬¬ä¸‰æ–¹ ===\n");
  
    const wallet = new ethers.Wallet(privateKey, provider);
    const contractWithSigner = usdcContract.connect(wallet);
  
    const decimals = await usdcContract.decimals();
    const amountInWei = ethers.parseUnits(amount.toString(), decimals);
  
    console.log(`æˆæƒäºº: ${wallet.address}`);
    console.log(`è¢«æˆæƒæ–¹: ${spender}`);
    console.log(`æˆæƒé¢åº¦: ${amount} USDC`);
  
    const tx = await contractWithSigner.approve(spender, amountInWei);
    console.log(`äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);
  
    const receipt = await tx.wait();
    console.log(`æˆæƒæˆåŠŸï¼`);
  
    return receipt;
}

// ===== 9. åœºæ™¯6ï¼šç›‘å¬Transferäº‹ä»¶ =====
async function listenTransfers() {
    console.log("\n=== åœºæ™¯6ï¼šç›‘å¬Transferäº‹ä»¶ ===\n");
  
    const decimals = await usdcContract.decimals();
  
    // ç›‘å¬æ‰€æœ‰è½¬è´¦äº‹ä»¶
    usdcContract.on("Transfer", (from, to, value, event) => {
        console.log(`\nğŸ“¤ æ–°çš„è½¬è´¦!`);
        console.log(`  ä»: ${from}`);
        console.log(`  åˆ°: ${to}`);
        console.log(`  æ•°é‡: ${ethers.formatUnits(value, decimals)} USDC`);
        console.log(`  äº¤æ˜“å“ˆå¸Œ: ${event.log.transactionHash}`);
    });
  
    console.log("æ­£åœ¨ç›‘å¬USDCè½¬è´¦äº‹ä»¶...");
}

// ===== 10. åœºæ™¯7ï¼šæŸ¥è¯¢å†å²è½¬è´¦ =====
async function getTransferHistory(address, blockRange = 1000) {
    console.log("\n=== åœºæ™¯7ï¼šæŸ¥è¯¢å†å²è½¬è´¦ ===\n");
  
    const decimals = await usdcContract.decimals();
    const currentBlock = await provider.getBlockNumber();
    const fromBlock = currentBlock - blockRange;
  
    // æŸ¥è¯¢è½¬å…¥è¯¥åœ°å€çš„Transferäº‹ä»¶
    const filterIn = usdcContract.filters.Transfer(null, address);
    const eventsIn = await usdcContract.queryFilter(filterIn, fromBlock, currentBlock);
  
    // æŸ¥è¯¢ä»è¯¥åœ°å€è½¬å‡ºçš„Transferäº‹ä»¶
    const filterOut = usdcContract.filters.Transfer(address, null);
    const eventsOut = await usdcContract.queryFilter(filterOut, fromBlock, currentBlock);
  
    console.log(`åœ°å€: ${address}`);
    console.log(`æŸ¥è¯¢åŒºå—èŒƒå›´: ${fromBlock} - ${currentBlock}`);
    console.log(`\nè½¬å…¥äº¤æ˜“ (${eventsIn.length} ç¬”):`);
  
    eventsIn.slice(-5).forEach(event => {
        console.log(`  ä» ${event.args.from.slice(0, 10)}... æ”¶åˆ° ${ethers.formatUnits(event.args.value, decimals)} USDC`);
    });
  
    console.log(`\nè½¬å‡ºäº¤æ˜“ (${eventsOut.length} ç¬”):`);
    eventsOut.slice(-5).forEach(event => {
        console.log(`  è½¬ç»™ ${event.args.to.slice(0, 10)}... ${ethers.formatUnits(event.args.value, decimals)} USDC`);
    });
}

// ===== 11. è¿è¡Œç¤ºä¾‹ =====
async function main() {
    try {
        // è¯»å–ä»£å¸ä¿¡æ¯
        await getTokenInfo();
      
        // æŸ¥è¯¢Vitalikçš„USDCä½™é¢ï¼ˆç¤ºä¾‹åœ°å€ï¼‰
        const vitalikAddress = "0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045";
        await getBalance(vitalikAddress);
      
        // æŸ¥è¯¢æˆæƒé¢åº¦ï¼ˆç¤ºä¾‹ï¼‰
        const uniswapRouter = "0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D";
        await getAllowance(vitalikAddress, uniswapRouter);
      
        // æ³¨æ„ï¼šè½¬è´¦å’Œæˆæƒéœ€è¦ç§é’¥ï¼Œè¿™é‡Œåªæ˜¯æ¼”ç¤ºç»“æ„
        // await transferTokens(PRIVATE_KEY, recipientAddress, 100);
        // await approveSpender(PRIVATE_KEY, uniswapRouter, 1000);
      
        // æŸ¥è¯¢å†å²è½¬è´¦
        await getTransferHistory(vitalikAddress, 10000);
      
    } catch (error) {
        console.error("é”™è¯¯:", error.message);
    }
}

main();
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**

```
=== åœºæ™¯1ï¼šè¯»å–ä»£å¸ä¿¡æ¯ ===

ä»£å¸åç§°: USD Coin
ä»£å¸ç¬¦å·: USDC
ç²¾åº¦: 6 ä½å°æ•°
æ€»ä¾›åº”é‡: 24,567,890,123.456789 USDC

=== åœºæ™¯2ï¼šæŸ¥è¯¢è´¦æˆ·ä½™é¢ ===

åœ°å€: 0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045
USDCä½™é¢: 1234.567890

=== åœºæ™¯3ï¼šæŸ¥è¯¢æˆæƒé¢åº¦ ===

Owner: 0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045
Spender: 0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D
æˆæƒé¢åº¦: 0.000000 USDC

=== åœºæ™¯7ï¼šæŸ¥è¯¢å†å²è½¬è´¦ ===

åœ°å€: 0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045
æŸ¥è¯¢åŒºå—èŒƒå›´: 18990000 - 19000000

è½¬å…¥äº¤æ˜“ (3 ç¬”):
  ä» 0x1234abcd... æ”¶åˆ° 100.000000 USDC
  ä» 0x5678efgh... æ”¶åˆ° 50.000000 USDC

è½¬å‡ºäº¤æ˜“ (2 ç¬”):
  è½¬ç»™ 0xaaaa1111... 25.000000 USDC
```

---

## 8. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"è¯·è§£é‡ŠERC20æ ‡å‡†çš„æ ¸å¿ƒå‡½æ•°ï¼Œä»¥åŠapprove/transferFromçš„å·¥ä½œåŸç†"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"ERC20æœ‰transferç”¨æ¥è½¬è´¦ï¼Œapproveç”¨æ¥æˆæƒï¼ŒtransferFromè®©åˆ«äººå¸®ä½ è½¬è´¦ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **ERC20å®šä¹‰äº†6ä¸ªæ ¸å¿ƒå‡½æ•°ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ç±»æ¥ç†è§£ï¼š**
>
> **1. æŸ¥è¯¢ç±»å‡½æ•°ï¼ˆåªè¯»ï¼Œä¸æ¶ˆè€—Gasï¼‰ï¼š**
> - `totalSupply()`: è¿”å›ä»£å¸æ€»ä¾›åº”é‡
> - `balanceOf(address)`: è¿”å›æŸåœ°å€çš„ä»£å¸ä½™é¢
> - `allowance(owner, spender)`: è¿”å›owneræˆæƒç»™spenderçš„é¢åº¦
>
> **2. ç›´æ¥è½¬è´¦ï¼š**
> - `transfer(to, amount)`: ä»è°ƒç”¨è€…è´¦æˆ·è½¬å‡ºä»£å¸åˆ°ç›®æ ‡åœ°å€
>   - æ ¸å¿ƒé€»è¾‘ï¼š`_balances[msg.sender] -= amount; _balances[to] += amount;`
>
> **3. æˆæƒè½¬è´¦ï¼ˆä¸¤æ­¥æ“ä½œï¼‰ï¼š**
> - `approve(spender, amount)`: æˆæƒspenderå¯ä»¥èŠ±è´¹è°ƒç”¨è€…æœ€å¤šamountæ•°é‡çš„ä»£å¸
>   - æ ¸å¿ƒé€»è¾‘ï¼š`_allowances[msg.sender][spender] = amount;`
> - `transferFrom(from, to, amount)`: spenderä»fromè´¦æˆ·è½¬å‡ºä»£å¸åˆ°to
>   - æ ¸å¿ƒé€»è¾‘ï¼šå…ˆæ£€æŸ¥allowanceï¼Œå†æ‰£å‡allowanceï¼Œæœ€åæ‰§è¡Œè½¬è´¦
>
> **ä¸ºä»€ä¹ˆéœ€è¦approve/transferFromï¼Ÿ**
>
> è¿™æ˜¯ä¸ºäº†æ”¯æŒ**ç¬¬ä¸‰æ–¹æ“ä½œ**ï¼Œæ˜¯DeFiå¯ç»„åˆæ€§çš„åŸºç¡€ã€‚ä¸¾ä¸ªä¾‹å­ï¼š
>
> å½“ä½ åœ¨Uniswapç”¨USDCæ¢ETHæ—¶ï¼š
> 1. ä½ è°ƒç”¨`usdc.approve(uniswapRouter, amount)` â€” æˆæƒUniswapåˆçº¦
> 2. ä½ è°ƒç”¨`uniswapRouter.swap(...)` â€” æ‰§è¡Œäº¤æ¢
> 3. Uniswapå†…éƒ¨è°ƒç”¨`usdc.transferFrom(ä½ , æ± å­, amount)` â€” ä»ä½ è´¦æˆ·è½¬USDCåˆ°æ± å­
>
> **å®‰å…¨æ³¨æ„ç‚¹ï¼š**
> - æ— é™æˆæƒï¼ˆ`approve(spender, MaxUint256)`ï¼‰æœ‰é£é™©ï¼Œåˆçº¦æ¼æ´å¯èƒ½å¯¼è‡´èµ„é‡‘è¢«ç›—
> - æ¨èä½¿ç”¨`increaseAllowance/decreaseAllowance`æˆ–ç²¾ç¡®æˆæƒ
> - å¯ä»¥ä½¿ç”¨ERC20 Permitæ‰©å±•ï¼Œé€šè¿‡ç­¾åæˆæƒé¿å…å•ç‹¬çš„approveäº¤æ˜“
>
> **ä¸ETHåŸç”Ÿè½¬è´¦çš„å…³é”®åŒºåˆ«ï¼š**
> - ETHè½¬è´¦åœ¨äº¤æ˜“çš„valueå­—æ®µï¼Œ~21000 gas
> - ERC20è½¬è´¦æ˜¯åˆçº¦è°ƒç”¨ï¼Œéœ€è¦ä¿®æ”¹storageï¼Œ~50000-65000 gas

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… åˆ†ç±»æ¸…æ™°ï¼ˆæŸ¥è¯¢/ç›´æ¥è½¬è´¦/æˆæƒè½¬è´¦ï¼‰
2. âœ… ç»™å‡ºäº†æ ¸å¿ƒå®ç°é€»è¾‘ï¼ˆä¼ªä»£ç ï¼‰
3. âœ… è§£é‡Šäº†ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªè®¾è®¡ï¼ˆDeFiåœºæ™¯ï¼‰
4. âœ… æåˆ°äº†å®‰å…¨æ³¨æ„ç‚¹å’Œæœ€ä½³å®è·µ
5. âœ… å¯¹æ¯”äº†ä¸ETHåŸç”Ÿè½¬è´¦çš„åŒºåˆ«

---

### é—®é¢˜2ï¼š"ERC20æœ‰ä»€ä¹ˆå·²çŸ¥çš„é—®é¢˜æˆ–å±€é™æ€§ï¼Ÿæœ‰å“ªäº›æ”¹è¿›æ–¹æ¡ˆï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"ERC20å¯èƒ½ä¼šæœ‰ä»£å¸ä¸¢å¤±çš„é—®é¢˜ï¼Œåæ¥æœ‰ERC223å’ŒERC777æ¥æ”¹è¿›ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **ERC20æœ‰ä¸‰ä¸ªä¸»è¦é—®é¢˜å’Œå¯¹åº”çš„æ”¹è¿›æ–¹æ¡ˆï¼š**
>
> **é—®é¢˜1ï¼šä»£å¸ä¸¢å¤±ï¼ˆToken Lostï¼‰**
>
> å¦‚æœtransferåˆ°ä¸€ä¸ªæ²¡æœ‰å¤„ç†ERC20çš„åˆçº¦åœ°å€ï¼Œä»£å¸ä¼šæ°¸ä¹…é”å®šã€‚
>
> ```solidity
> // ç”¨æˆ·è¯¯æ“ä½œ
> token.transfer(someContractWithoutReceiver, 1000);
> // ä»£å¸æ°¸ä¹…ä¸¢å¤±ï¼Œæ— æ³•å–å›
> ```
>
> **æ”¹è¿›æ–¹æ¡ˆï¼š**
> - **ERC223**: å¼•å…¥`tokenFallback`å›è°ƒï¼Œåˆçº¦å¿…é¡»å®ç°è¯¥å‡½æ•°æ‰èƒ½æ¥æ”¶ä»£å¸
> - **ERC777**: å¼•å…¥Hooksæœºåˆ¶ï¼ˆ`tokensReceived`ï¼‰ï¼Œæ›´çµæ´»çš„æ¥æ”¶é€»è¾‘
> - **ERC1363**: å¼•å…¥`transferAndCall`ï¼Œè½¬è´¦çš„åŒæ—¶è°ƒç”¨æ¥æ”¶åˆçº¦çš„å›è°ƒ
>
> **é—®é¢˜2ï¼šä¸¤æ­¥æˆæƒï¼ˆDouble Transactionï¼‰**
>
> DeFiæ“ä½œéœ€è¦å…ˆapproveå†swapï¼Œä¸¤ç¬”äº¤æ˜“=ä¸¤å€Gas+ä¸¤å€ç­‰å¾…æ—¶é—´ã€‚
>
> **æ”¹è¿›æ–¹æ¡ˆï¼š**
> - **ERC2612 (Permit)**: é€šè¿‡é“¾ä¸‹ç­¾åæˆæƒï¼Œåªéœ€è¦ä¸€ç¬”äº¤æ˜“
>
> ```javascript
> // ä¼ ç»Ÿæ–¹å¼ï¼šä¸¤ç¬”äº¤æ˜“
> await token.approve(router, amount);  // äº¤æ˜“1
> await router.swap(amount);            // äº¤æ˜“2
>
> // Permitæ–¹å¼ï¼šä¸€ç¬”äº¤æ˜“
> const signature = await signer._signTypedData(domain, types, permitData);
> await router.swapWithPermit(amount, deadline, v, r, s);  // åªéœ€ä¸€ç¬”äº¤æ˜“
> ```
>
> **é—®é¢˜3ï¼šæˆæƒç«æ€æ¡ä»¶ï¼ˆApprove Race Conditionï¼‰**
>
> ```solidity
> // Aliceå½“å‰æˆæƒBob 100ä¸ªä»£å¸
> // Aliceæƒ³æŠŠæˆæƒæ”¹ä¸º50ä¸ª
> Alice: approve(Bob, 50)
>
> // åœ¨Aliceçš„äº¤æ˜“ç¡®è®¤å‰ï¼ŒBobçœ‹åˆ°äº†pendingäº¤æ˜“
> Bob: transferFrom(Alice, Bob, 100)  // å…ˆèŠ±æ‰100ä¸ª
> // Aliceçš„äº¤æ˜“ç¡®è®¤å
> Bob: transferFrom(Alice, Bob, 50)   // å†èŠ±æ‰50ä¸ª
> // Bobæ€»å…±èŠ±äº†150ä¸ªï¼Œè€Œä¸æ˜¯Aliceé¢„æœŸçš„50ä¸ª
> ```
>
> **æ”¹è¿›æ–¹æ¡ˆï¼š**
> - å…ˆ`approve(spender, 0)`ï¼Œå†`approve(spender, newAmount)`
> - ä½¿ç”¨`increaseAllowance`/`decreaseAllowance`
> - ERC20 Permitçš„deadlineæœºåˆ¶
>
> **å½“å‰ä¸»æµé€‰æ‹©ï¼š**
>
> å°½ç®¡æœ‰è¿™äº›é—®é¢˜ï¼ŒERC20ä»æ˜¯ä¸»æµï¼Œå› ä¸ºï¼š
> 1. ç”Ÿæ€æ”¯æŒæœ€å¹¿æ³›ï¼ˆæ‰€æœ‰é’±åŒ…ã€äº¤æ˜“æ‰€ã€DeFiéƒ½æ”¯æŒï¼‰
> 2. ä»£ç æœ€ç®€å•ï¼Œå®¡è®¡æˆæœ¬ä½
> 3. é…åˆSafeERC20å’ŒPermitæ‰©å±•ï¼Œé—®é¢˜å¯ä»¥ç¼“è§£
>
> ERC777æ›¾è¢«å¯„äºˆåšæœ›ï¼Œä½†å› ä¸ºHooksæœºåˆ¶å¼•å…¥äº†é‡å…¥æ”»å‡»é£é™©ï¼ˆå¦‚dForceæ”»å‡»ï¼‰ï¼Œç°åœ¨åè€Œä¸æ¨èä½¿ç”¨ã€‚

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… å‡†ç¡®æŒ‡å‡ºäº†ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜
2. âœ… ç»™å‡ºäº†å…·ä½“çš„ä»£ç ç¤ºä¾‹è¯´æ˜é—®é¢˜
3. âœ… åˆ—ä¸¾äº†å¤šç§æ”¹è¿›æ–¹æ¡ˆå¹¶è§£é‡ŠåŸç†
4. âœ… å®¢è§‚åˆ†æäº†ä¸ºä»€ä¹ˆERC20ä»æ˜¯ä¸»æµ
5. âœ… æåˆ°äº†ERC777çš„é‡å…¥é£é™©ï¼ˆå±•ç¤ºæ·±åº¦ç†è§£ï¼‰

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šç›´è§‰ç†è§£ - ERC20æ˜¯ä»€ä¹ˆï¼Ÿ ğŸ¯

**ä¸€å¥è¯ï¼š** ERC20æ˜¯ä»¥å¤ªåŠä»£å¸çš„"æ¥å£è§„èŒƒ"ï¼Œå®šä¹‰äº†æ‰€æœ‰åŒè´¨åŒ–ä»£å¸å¿…é¡»å®ç°çš„å‡½æ•°å’Œäº‹ä»¶ã€‚

**ä¸¾ä¾‹ï¼š**
å°±åƒUSBæ ‡å‡†è®©æ‰€æœ‰USBè®¾å¤‡éƒ½èƒ½ç”¨åŒä¸€ç§æ¥å£è¿æ¥ç”µè„‘ï¼ŒERC20è®©æ‰€æœ‰ä»£å¸éƒ½èƒ½ç”¨åŒä¸€ç§æ–¹å¼è¢«é’±åŒ…å’ŒDAppè¯†åˆ«ã€‚

**åº”ç”¨ï¼š** USDCã€USDTã€DAIã€UNIã€LINKç­‰å‡ ä¹æ‰€æœ‰ä½ çŸ¥é“çš„ä»£å¸éƒ½æ˜¯ERC20æ ‡å‡†ã€‚

---

### å¡ç‰‡2ï¼šå½¢å¼åŒ–å®šä¹‰ - 6ä¸ªæ ¸å¿ƒå‡½æ•° ğŸ“

**ä¸€å¥è¯ï¼š** ERC20è¦æ±‚å®ç°6ä¸ªå‡½æ•°ï¼š3ä¸ªæŸ¥è¯¢ï¼ˆtotalSupply, balanceOf, allowanceï¼‰+ 3ä¸ªæ“ä½œï¼ˆtransfer, approve, transferFromï¼‰ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
interface IERC20 {
    function totalSupply() external view returns (uint256);
    function balanceOf(address) external view returns (uint256);
    function transfer(address, uint256) external returns (bool);
    function allowance(address, address) external view returns (uint256);
    function approve(address, uint256) external returns (bool);
    function transferFrom(address, address, uint256) external returns (bool);
}
```

**åº”ç”¨ï¼š** ä»»ä½•å®ç°è¿™6ä¸ªå‡½æ•°çš„åˆçº¦éƒ½æ˜¯ERC20ä»£å¸ï¼Œå¯è¢«æ‰€æœ‰æ”¯æŒERC20çš„åº”ç”¨ä½¿ç”¨ã€‚

---

### å¡ç‰‡3ï¼šå…³é”®æ¦‚å¿µ - ä½™é¢æ˜ å°„ ğŸ”¢

**ä¸€å¥è¯ï¼š** ERC20çš„æ ¸å¿ƒæ˜¯`mapping(address => uint256)`ï¼Œè®°å½•æ¯ä¸ªåœ°å€çš„ä»£å¸æ•°é‡ã€‚

**ä¸¾ä¾‹ï¼š**
```solidity
// ä»£å¸ä½™é¢ä¸åœ¨ä½ çš„é’±åŒ…é‡Œï¼Œè€Œæ˜¯åœ¨åˆçº¦çš„mappingé‡Œ
mapping(address => uint256) private _balances;

// æŸ¥è¯¢ä½™é¢ = åœ¨mappingé‡ŒæŸ¥æ‰¾
function balanceOf(address account) public view returns (uint256) {
    return _balances[account];
}
```

**åº”ç”¨ï¼š** è½¬è´¦åªæ˜¯ä¿®æ”¹mappingçš„ä¸¤ä¸ªæ•°å­—ï¼Œä¸æ˜¯"å‘é€"ä»£å¸ã€‚

---

### å¡ç‰‡4ï¼šå…³é”®æ¦‚å¿µ - æˆæƒæœºåˆ¶ ğŸ”

**ä¸€å¥è¯ï¼š** `approve` + `transferFrom`è®©ç¬¬ä¸‰æ–¹åˆçº¦èƒ½ä»£ä¸ºè½¬ç§»ä½ çš„ä»£å¸ï¼Œæ˜¯DeFiçš„åŸºç¡€ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// åœ¨Uniswapæ¢å¸å‰ï¼Œéœ€è¦å…ˆæˆæƒ
await token.approve(uniswapRouter, amount);

// Uniswapå†…éƒ¨è°ƒç”¨transferFromä»ä½ è´¦æˆ·è½¬å‡ºä»£å¸
// token.transferFrom(ä½ , æ± å­, amount);
```

**åº”ç”¨ï¼š** æ‰€æœ‰DEXã€å€Ÿè´·åè®®ã€æ”¶ç›Šèšåˆå™¨éƒ½ä¾èµ–è¿™ä¸ªæœºåˆ¶ã€‚

---

### å¡ç‰‡5ï¼šç¼–ç¨‹å®ç° - decimalsç²¾åº¦ ğŸ’»

**ä¸€å¥è¯ï¼š** `decimals`å®šä¹‰æœ€å°å•ä½ï¼Œé€šå¸¸ä¸º18ï¼Œå®é™…å­˜å‚¨çš„æ˜¯æœ€å°å•ä½çš„æ•´æ•°ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// ç”¨æˆ·æƒ³è½¬1.5ä¸ªä»£å¸
const amount = 1.5;

// é”™è¯¯âŒï¼šç›´æ¥ä½¿ç”¨ä¼šè½¬0.0000...0015ä¸ª
await token.transfer(to, amount);

// æ­£ç¡®âœ…ï¼šè½¬æ¢ä¸ºæœ€å°å•ä½
const decimals = await token.decimals(); // 18
const amountWei = ethers.parseUnits("1.5", decimals);
await token.transfer(to, amountWei);
```

**åº”ç”¨ï¼š** æ°¸è¿œä½¿ç”¨`parseUnits`å’Œ`formatUnits`å¤„ç†ä»£å¸æ•°é‡ã€‚

---

### å¡ç‰‡6ï¼šå¯¹æ¯”åŒºåˆ† - ERC20 vs ETHè½¬è´¦ ğŸ†š

**ä¸€å¥è¯ï¼š** ETHè½¬è´¦åœ¨äº¤æ˜“valueå­—æ®µï¼ŒERC20è½¬è´¦æ˜¯è°ƒç”¨åˆçº¦å‡½æ•°ã€‚

**ä¸¾ä¾‹ï¼š**

| ç‰¹æ€§ | ETHè½¬è´¦ | ERC20è½¬è´¦ |
|-----|--------|----------|
| æ–¹å¼ | `tx.value` | `contract.transfer()` |
| Gas | ~21000 | ~50000-65000 |
| å­˜å‚¨ | å…¨å±€çŠ¶æ€ | åˆçº¦å†…mapping |
| ç›‘å¬ | ç›‘å¬äº¤æ˜“ | ç›‘å¬Transferäº‹ä»¶ |

**åº”ç”¨ï¼š** è½¬ETHå’Œè½¬ä»£å¸çš„å‰ç«¯ä»£ç å®Œå…¨ä¸åŒã€‚

---

### å¡ç‰‡7ï¼šè¿›é˜¶ç†è§£ - äº‹ä»¶ç›‘å¬ ğŸ“¡

**ä¸€å¥è¯ï¼š** ERC20å¿…é¡»è§¦å‘`Transfer`å’Œ`Approval`äº‹ä»¶ï¼Œç”¨äºé“¾ä¸‹åº”ç”¨ç›‘å¬çŠ¶æ€å˜åŒ–ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// ç›‘å¬ä»£å¸è½¬è´¦
token.on("Transfer", (from, to, value) => {
    console.log(`${from} â†’ ${to}: ${ethers.formatUnits(value, decimals)}`);
});

// æŸ¥è¯¢å†å²è®°å½•
const filter = token.filters.Transfer(null, myAddress);
const events = await token.queryFilter(filter, -10000);
```

**åº”ç”¨ï¼š** é’±åŒ…æ›´æ–°ä½™é¢ã€äº¤æ˜“è®°å½•é¡µé¢éƒ½ä¾èµ–äº‹ä»¶ã€‚

---

### å¡ç‰‡8ï¼šé«˜çº§åº”ç”¨ - å®‰å…¨æˆæƒ ğŸ›¡ï¸

**ä¸€å¥è¯ï¼š** æ— é™æˆæƒæœ‰é£é™©ï¼Œæ¨èç²¾ç¡®æˆæƒæˆ–ä½¿ç”¨Permitæ‰©å±•ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// å±é™©âŒï¼šæ— é™æˆæƒ
await token.approve(spender, ethers.MaxUint256);

// å®‰å…¨âœ…ï¼šç²¾ç¡®æˆæƒ
await token.approve(spender, exactAmount);

// æ›´å¥½âœ…ï¼šä½¿ç”¨Permitï¼ˆä¸€ç¬”äº¤æ˜“å®Œæˆæˆæƒ+æ“ä½œï¼‰
await router.swapWithPermit(amount, deadline, v, r, s);
```

**åº”ç”¨ï¼š** ä½¿ç”¨revoke.cashæ£€æŸ¥å¹¶æ’¤é”€ä¸å¿…è¦çš„æˆæƒã€‚

---

### å¡ç‰‡9ï¼šåœ¨DeFiç”Ÿæ€ä¸­çš„åº”ç”¨ ğŸŒ

**ä¸€å¥è¯ï¼š** ERC20æ˜¯DeFiçš„"è¡€æ¶²"ï¼Œæ‰€æœ‰åè®®éƒ½å›´ç»•å®ƒæ„å»ºã€‚

**ä¸¾ä¾‹ï¼š**
- **DEX (Uniswap)**: äº¤æ¢ERC20ä»£å¸å¯¹
- **å€Ÿè´· (Aave)**: å­˜å…¥ERC20è·å¾—åˆ©æ¯
- **ç¨³å®šå¸ (DAI)**: é€šè¿‡CDPé“¸é€ çš„ERC20
- **æ²»ç† (UNI)**: æŠ•ç¥¨æƒçš„ERC20ä»£å¸
- **æ”¶ç›Š (Yearn)**: ä¼˜åŒ–ERC20æ”¶ç›Šç­–ç•¥

**åº”ç”¨ï¼š** ç†è§£ERC20å°±èƒ½ç†è§£80%çš„DeFiåè®®ã€‚

---

### å¡ç‰‡10ï¼šæ€»ç»“ä¸å»¶ä¼¸ ğŸ“

**ä¸€å¥è¯ï¼š** ERC20æ˜¯Web3æœ€é‡è¦çš„æ ‡å‡†ä¹‹ä¸€ï¼ŒæŒæ¡å®ƒæ˜¯è¿›å…¥DeFiå¼€å‘çš„ç¬¬ä¸€æ­¥ã€‚

**æ ¸å¿ƒè¦ç‚¹æ€»ç»“ï¼š**
1. **6ä¸ªå‡½æ•°** = 3æŸ¥è¯¢ + 3æ“ä½œ
2. **ä½™é¢ = mapping**ï¼Œä¸æ˜¯"æŒæœ‰"
3. **æˆæƒæœºåˆ¶**æ˜¯DeFiçš„åŸºç¡€
4. **decimals**å¤„ç†å¾ˆé‡è¦
5. **äº‹ä»¶**ç”¨äºé“¾ä¸‹ç›‘å¬

**ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®ï¼š**
- **ERC721 (NFT)**: éåŒè´¨åŒ–ä»£å¸æ ‡å‡†
- **ERC1155**: å¤šä»£å¸æ ‡å‡†ï¼ˆåŒæ—¶æ”¯æŒFTå’ŒNFTï¼‰
- **ERC2612 (Permit)**: ç­¾åæˆæƒæ‰©å±•
- **å®æˆ˜**: éƒ¨ç½²è‡ªå·±çš„ä»£å¸ï¼Œé›†æˆåˆ°DApp

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**ERC20æ˜¯ä»¥å¤ªåŠåŒè´¨åŒ–ä»£å¸çš„æ¥å£æ ‡å‡†ï¼Œé€šè¿‡å®šä¹‰6ä¸ªæ ¸å¿ƒå‡½æ•°ï¼ˆtotalSupplyã€balanceOfã€transferã€allowanceã€approveã€transferFromï¼‰å’Œ2ä¸ªäº‹ä»¶ï¼ˆTransferã€Approvalï¼‰ï¼Œå®ç°äº†ä»£å¸çš„äº’æ“ä½œæ€§å’Œå¯ç»„åˆæ€§ï¼Œæ˜¯æ‰€æœ‰DeFiåè®®çš„åŸºç¡€ï¼Œä¹Ÿæ˜¯Web3å¼€å‘è€…å¿…é¡»æŒæ¡çš„ç¬¬ä¸€ä¸ªä»£å¸æ ‡å‡†ã€‚**

---

## ğŸ“š é™„å½•

### å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬çŸ¥è¯†ç‚¹å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è¯´å‡ºERC20çš„6ä¸ªæ ¸å¿ƒå‡½æ•°åŠå…¶ä½œç”¨
- [ ] è§£é‡Šapprove/transferFromçš„å·¥ä½œåŸç†
- [ ] ç†è§£decimalsçš„ä½œç”¨å¹¶æ­£ç¡®å¤„ç†ä»£å¸ç²¾åº¦
- [ ] ä½¿ç”¨ethers.jsè¯»å–ä»£å¸ä¿¡æ¯å’Œä½™é¢
- [ ] ä½¿ç”¨ethers.jså‘é€ä»£å¸è½¬è´¦å’Œæˆæƒ
- [ ] ç›‘å¬Transferäº‹ä»¶å¹¶æŸ¥è¯¢å†å²è®°å½•
- [ ] ä½¿ç”¨OpenZeppelinå¿«é€Ÿéƒ¨ç½²ERC20ä»£å¸
- [ ] è¯´å‡ºæ— é™æˆæƒçš„é£é™©å’Œå®‰å…¨æœ€ä½³å®è·µ
- [ ] è§£é‡ŠERC20çš„å±€é™æ€§å’Œæ”¹è¿›æ–¹æ¡ˆï¼ˆERC223ã€ERC777ã€ERC2612ï¼‰
- [ ] åŒºåˆ†ETHè½¬è´¦å’ŒERC20è½¬è´¦çš„ä¸åŒ

### å¿«é€Ÿå‚è€ƒå¡

**ERC20 ABIï¼ˆæœ€å°åŒ–ï¼‰ï¼š**

```javascript
const ERC20_ABI = [
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function totalSupply() view returns (uint256)",
    "function balanceOf(address) view returns (uint256)",
    "function transfer(address, uint256) returns (bool)",
    "function approve(address, uint256) returns (bool)",
    "function allowance(address, address) view returns (uint256)",
    "function transferFrom(address, address, uint256) returns (bool)",
    "event Transfer(address indexed, address indexed, uint256)",
    "event Approval(address indexed, address indexed, uint256)"
];
```

**å¸¸ç”¨ä»£ç ç‰‡æ®µï¼š**

```javascript
// åˆ›å»ºåˆçº¦å®ä¾‹
const token = new ethers.Contract(tokenAddress, ERC20_ABI, provider);

// è¯»å–ä¿¡æ¯
const decimals = await token.decimals();
const balance = await token.balanceOf(address);

// æ ¼å¼åŒ–
const formatted = ethers.formatUnits(balance, decimals);
const parsed = ethers.parseUnits("100", decimals);

// è½¬è´¦
const tx = await token.connect(signer).transfer(to, parsed);

// æˆæƒ
await token.connect(signer).approve(spender, parsed);
```

### ä¸‹ä¸€æ­¥å­¦ä¹ 

æ¨èæŒ‰ä»¥ä¸‹é¡ºåºç»§ç»­å­¦ä¹ ï¼š

1. **ERC721 (NFT)** - éåŒè´¨åŒ–ä»£å¸æ ‡å‡†
2. **ERC1155** - å¤šä»£å¸æ ‡å‡†
3. **ERC2612 (Permit)** - ç­¾åæˆæƒæ‰©å±•
4. **Uniswap V2/V3** - DEXå¦‚ä½•ä½¿ç”¨ERC20
5. **OpenZeppelinåº“** - å®‰å…¨çš„ERC20æ‰©å±•

### å‚è€ƒèµ„æº

**å®˜æ–¹æ–‡æ¡£ï¼š**
- [EIP-20: Token Standard](https://eips.ethereum.org/EIPS/eip-20)
- [OpenZeppelin ERC20](https://docs.openzeppelin.com/contracts/4.x/erc20)

**å®‰å…¨å·¥å…·ï¼š**
- [Revoke.cash](https://revoke.cash/) - æ£€æŸ¥å’Œæ’¤é”€æˆæƒ
- [Etherscan Token Approvals](https://etherscan.io/tokenapprovalchecker)

**æ·±å…¥é˜…è¯»ï¼š**
- [ERC20 vs ERC721 vs ERC1155](https://ethereum.org/en/developers/docs/standards/tokens/)
- [ERC20 Permit (EIP-2612)](https://eips.ethereum.org/EIPS/eip-2612)

---

**ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2025-01-XX
**ä½œè€…ï¼š** Claude Code
**é€‚ç”¨äººç¾¤ï¼š** å‰ç«¯å·¥ç¨‹å¸ˆè½¬Web3å¼€å‘

---

**è®°ä½ï¼š** ERC20æ˜¯Web3ä¸–ç•Œçš„"è´§å¸æ ‡å‡†"ï¼Œç†è§£å®ƒå°±åƒç†è§£HTTPåè®®ä¸€æ ·åŸºç¡€å’Œé‡è¦ã€‚æŒæ¡6ä¸ªå‡½æ•°ã€2ä¸ªäº‹ä»¶ã€1ä¸ªç²¾åº¦ï¼Œä½ å°±èƒ½ä¸99%çš„ä»£å¸äº¤äº’ï¼ğŸ¯